<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JDKActivity</title>
<meta name="theme-color" content="#0d0f14">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JDKActivity">
<link rel="manifest" id="pwa-manifest">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg: #0d0f14;
  --bg2: #13161e;
  --bg3: #1a1e2a;
  --surface: #1e2230;
  --surface2: #252a3a;
  --border: #2e3347;
  --text: #e8eaf0;
  --text2: #9099b0;
  --text3: #5a6275;
  --accent: #f0a500;
  --accent2: #e8c860;
  --todo: #7c6ff7;
  --notes: #f07050;
  --invest: #30c88a;
  --culture: #e05580;
  --voyage: #38b8d8;
  --settings: #8899cc;
  --habit: #22d3a0;
  --habit2: #0ea47a;
  --journal: #a78bfa;
  --journal2: #7c6ff7;
  --danger: #e05555;
  --success: #30c88a;
  --radius: 14px;
  --radius-sm: 8px;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

* { margin:0; padding:0; box-sizing:border-box; }

html,body { 
  height:100%; 
  background:var(--bg); 
  color:var(--text); 
  font-family:'Outfit',sans-serif;
  font-size:14px;
  overflow:hidden;
  font-feature-settings:'kern' 1,'liga' 1,'calt' 1;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Mobile: scroll naturel sur le body */
@media (max-width:768px) {
  html, body { overflow:auto; height:auto; min-height:100%; }
}

/* ===== LAYOUT ===== */
#app { display:flex; height:100vh; }

@media (max-width:768px) {
  #app { height:auto; min-height:100vh; }
}

#sidebar {
  width:240px;
  background:var(--bg2);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  padding:24px 0;
  transition:width 0.3s;
  z-index:100;
  flex-shrink:0;
}

.logo {
  padding:0 24px 28px;
  border-bottom:1px solid var(--border);
  margin-bottom:16px;
}
.logo-title { 
  font-family:'Bricolage Grotesque',sans-serif; 
  font-size:21px;
  font-weight:800;
  letter-spacing:-0.5px;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.logo-sub { font-size:10px; color:var(--text3); letter-spacing:2px; text-transform:uppercase; margin-top:2px; }

.nav-item {
  display:flex; align-items:center; gap:12px;
  padding:12px 24px;
  cursor:pointer;
  border-radius:0;
  transition:all 0.2s;
  color:var(--text2);
  border-left:3px solid transparent;
  user-select:none;
}
.nav-item:hover { background:var(--bg3); color:var(--text); }
.nav-item.active { color:var(--text); border-left-color:var(--c,var(--accent)); background:var(--bg3); }
.nav-item .nav-icon { width:20px; text-align:center; font-size:15px; }
.nav-item .nav-label { font-size:13px; font-weight:500; }
.nav-item .nav-badge { 
  margin-left:auto; min-width:20px; height:20px; 
  border-radius:10px; background:var(--c,var(--accent)); 
  color:#000; font-size:10px; font-weight:700;
  display:flex; align-items:center; justify-content:center; padding:0 5px;
}

.main { flex:1; display:flex; flex-direction:column; overflow:hidden; }

.topbar {
  height:60px; flex-shrink:0;
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 24px;
  gap:16px;
}
.topbar-title { font-family:'Bricolage Grotesque',sans-serif; font-size:19px; font-weight:700; letter-spacing:-0.3px; flex:1; }
.topbar-actions { display:flex; gap:8px; }

.content { flex:1; overflow-y:auto; padding:24px; }
.content::-webkit-scrollbar { width:5px; }
.content::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* Mobile: body scroll instead of internal overflow */
/* Mobile: layout géré dans le bloc principal */
@media (max-width:768px) {
  .main { overflow:visible; flex:none; width:100%; }
}

/* ===== MOBILE LEFT RAIL NAV ===== */
#bottomnav {
  display:none;
  position:fixed; top:0; left:0; bottom:0;
  width:64px;
  background:var(--bg2);
  border-right:1px solid var(--border);
  z-index:200;
  flex-direction:column;
  align-items:center;
  padding:8px 0 12px;
  box-shadow:2px 0 12px rgba(0,0,0,0.25);
}

/* Logo mini */
#bottomnav .bnav-logo {
  width:40px; height:40px; border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex; align-items:center; justify-content:center;
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:17px; color:#000; font-weight:800;
  margin-bottom:8px; flex-shrink:0;
}

.bnav-items {
  display:flex; flex-direction:column; align-items:center;
  width:100%; flex:1; gap:2px; overflow-y:auto;
}
.bnav-items::-webkit-scrollbar { display:none; }

.bnav-item {
  width:52px; height:52px; border-radius:12px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:3px; cursor:pointer; color:var(--text3); transition:all 0.18s;
  font-size:9px; font-weight:600; letter-spacing:0.3px;
  position:relative; flex-shrink:0; user-select:none;
}
.bnav-item:hover { background:var(--surface); color:var(--text); }
.bnav-item i { font-size:19px; transition:transform 0.18s; }
.bnav-item span { text-transform:uppercase; letter-spacing:0.3px; line-height:1; }

.bnav-item.active {
  background:var(--surface2);
  color:var(--c, var(--accent));
}
.bnav-item.active::before {
  content:''; position:absolute;
  left:0; top:50%; transform:translateY(-50%);
  width:3px; height:28px;
  border-radius:0 3px 3px 0;
  background:var(--c, var(--accent));
}
.bnav-item.active i { transform:scale(1.15); }

/* Todo badge */
.bnav-item .bnav-badge {
  position:absolute; top:5px; right:5px;
  min-width:16px; height:16px; border-radius:8px;
  background:var(--todo); color:#000;
  font-size:9px; font-weight:700;
  display:flex; align-items:center; justify-content:center; padding:0 3px;
}


/* ===== CARDS ===== */
.card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:16px;
}
.card-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:16px;
}
.card-title { font-size:14px; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; }

/* ===== BUTTONS ===== */
.btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:9px 16px; border-radius:var(--radius-sm);
  font-family:'Outfit',sans-serif; font-size:13px; font-weight:500;
  cursor:pointer; border:none; transition:all 0.2s; text-decoration:none;
}
.btn-primary { background:var(--accent); color:#000; }
.btn-primary:hover { background:var(--accent2); }
.btn-ghost { background:transparent; color:var(--text2); border:1px solid var(--border); }
.btn-ghost:hover { background:var(--surface2); color:var(--text); }
.btn-danger { background:var(--danger); color:#fff; }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-icon { padding:8px; border-radius:var(--radius-sm); width:36px; height:36px; justify-content:center; }

/* ===== FORMS ===== */
.form-group { margin-bottom:14px; }
.form-label { font-size:11px; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; display:block; }
.form-input, .form-select, .form-textarea {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:10px 14px;
  color:var(--text); font-family:'Outfit',sans-serif; font-size:13px;
  transition:border 0.2s; outline:none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color:var(--accent); }
.form-textarea { resize:vertical; min-height:80px; }
.form-select option { background:var(--bg3); }
.form-row { display:flex; gap:12px; }
.form-row .form-group { flex:1; }

/* ===== MODAL ===== */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center;
  z-index:999; padding:20px;
  opacity:0; pointer-events:none; transition:opacity 0.2s;
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal {
  background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--radius); width:100%; max-width:520px;
  max-height:90vh; overflow-y:auto;
  transform:translateY(20px); transition:transform 0.2s;
}
.modal-overlay.open .modal { transform:translateY(0); }
.modal-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 24px; border-bottom:1px solid var(--border);
}
.modal-title { font-family:'Bricolage Grotesque',sans-serif; font-size:18px; font-weight:700; letter-spacing:-0.3px; }
.modal-body { padding:24px; }
.modal-footer { padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }

/* ===== GRID ===== */
.grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
.grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
.grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }

/* ===== STATS CARD ===== */
.stat-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px;
  position:relative; overflow:hidden;
}
.stat-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg, var(--c,var(--accent)), transparent);
}
.stat-icon { font-size:24px; margin-bottom:10px; color:var(--c,var(--accent)); }
.stat-value { font-family:'Bricolage Grotesque',sans-serif; font-size:28px; font-weight:700; letter-spacing:-0.5px; }
.stat-label { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-top:4px; }

/* ===== TAGS ===== */
.tag {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:20px;
  font-size:11px; font-weight:600;
  background:var(--surface2); color:var(--text2);
  text-transform:uppercase; letter-spacing:0.3px;
}
.tag-dot { width:6px; height:6px; border-radius:50%; background:var(--c,var(--accent)); }

/* ===== TODO ===== */
.todo-item {
  display:flex; align-items:center; gap:12px;
  padding:14px 16px; background:var(--surface);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  margin-bottom:8px; transition:all 0.2s;
}
.todo-item:hover { border-color:var(--todo); }
.todo-item.done { opacity:0.5; }
.todo-item.done .todo-text { text-decoration:line-through; }
.todo-check {
  width:20px; height:20px; border-radius:50%;
  border:2px solid var(--border); flex-shrink:0;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s;
}
.todo-check.checked { background:var(--todo); border-color:var(--todo); }
.todo-check.checked::after { content:'✓'; color:#fff; font-size:11px; font-weight:700; }
.todo-text { flex:1; font-size:13px; }
.todo-meta { font-size:11px; color:var(--text3); }
.todo-actions { display:flex; gap:4px; opacity:0; transition:opacity 0.2s; }
.todo-item:hover .todo-actions { opacity:1; }
.priority-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.p-high { background:#e05555; }
.p-medium { background:#f0a500; }
.p-low { background:#30c88a; }

/* ===== NOTES ===== */
.note-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:16px;
  cursor:pointer; transition:all 0.2s;
  position:relative;
}
.note-card:hover { border-color:var(--notes); transform:translateY(-2px); }
.note-type { font-size:10px; color:var(--text3); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
.note-title { font-size:14px; font-weight:600; margin-bottom:6px; }
.note-preview { font-size:12px; color:var(--text2); line-height:1.5; overflow:hidden; max-height:48px; }
.note-date { font-size:10px; color:var(--text3); margin-top:10px; }
.note-img-thumb { 
  width:40px; height:40px; border-radius:6px; object-fit:cover;
  border:1px solid var(--border); position:absolute; top:16px; right:16px;
}

/* ===== CANVAS ===== */
#drawing-canvas {
  width:100%; background:#fff; border-radius:var(--radius-sm);
  cursor:crosshair; touch-action:none;
}
.canvas-tools { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
.color-btn { 
  width:24px; height:24px; border-radius:50%; border:2px solid transparent;
  cursor:pointer; transition:all 0.2s;
}
.color-btn.active { border-color:#fff; transform:scale(1.2); }
.size-btn {
  padding:4px 10px; border-radius:20px; border:1px solid var(--border);
  background:transparent; color:var(--text2); cursor:pointer; font-size:11px;
}
.size-btn.active { background:var(--notes); border-color:var(--notes); color:#fff; }

/* ===== INVEST ===== */
.invest-item {
  display:flex; align-items:center; gap:16px;
  padding:18px 20px; background:var(--surface);
  border:1px solid var(--border); border-radius:var(--radius); margin-bottom:10px;
  transition:border-color .2s, transform .15s;
}
.invest-item:hover { border-color:var(--invest); transform:translateY(-1px); }
.invest-icon { 
  width:48px; height:48px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:22px; background:var(--bg3); flex-shrink:0;
}
.invest-name { font-size:15px; font-weight:600; margin-bottom:3px; }
.invest-cat { font-size:11px; color:var(--text3); letter-spacing:.2px; }
.invest-amount { font-family:'Bricolage Grotesque',sans-serif; font-size:20px; font-weight:700; letter-spacing:-0.3px; margin-left:auto; }
.invest-change { font-size:11px; font-weight:600; margin-top:4px; text-align:right; }
.invest-change.pos { color:var(--invest); }
.invest-change.neg { color:var(--danger); }
.invest-pnl-bar { height:3px; background:var(--bg3); border-radius:2px; margin-top:14px; }
.invest-pnl-fill { height:100%; border-radius:2px; transition:width .6s ease; }
.progress-bar { height:4px; background:var(--bg3); border-radius:2px; margin-top:12px; }
.progress-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--invest),var(--accent)); transition:width 0.5s; }

/* ===== CULTURE ===== */
.culture-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); overflow:hidden; transition:all 0.2s;
  cursor:pointer;
}
.culture-card:hover { border-color:var(--culture); transform:translateY(-3px); box-shadow:var(--shadow); }
.culture-poster {
  height:140px; background:var(--bg3);
  display:flex; align-items:center; justify-content:center;
  font-size:48px; position:relative; overflow:hidden;
}
.culture-poster img { width:100%; height:100%; object-fit:cover; position:absolute; }
.culture-body { padding:14px; }
.culture-title { font-size:13px; font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.culture-sub { font-size:11px; color:var(--text3); }
.stars { color:var(--accent); font-size:11px; margin-top:6px; }
.status-badge {
  position:absolute; top:10px; right:10px;
  padding:3px 8px; border-radius:20px; font-size:10px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.3px;
}
.status-done { background:var(--invest); color:#000; }
.status-todo { background:var(--surface); color:var(--text2); border:1px solid var(--border); }
.status-progress { background:var(--accent); color:#000; }

/* ===== VOYAGE ===== */
.trip-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px; margin-bottom:16px;
  transition:all 0.2s; cursor:pointer;
}
.trip-card:hover { border-color:var(--voyage); }
.trip-header { display:flex; align-items:center; gap:14px; margin-bottom:14px; }
.trip-flag { font-size:36px; }
.trip-dest { font-family:'Bricolage Grotesque',sans-serif; font-size:22px; font-weight:700; letter-spacing:-0.4px; }
.trip-dates { font-size:12px; color:var(--text3); margin-top:2px; }
.trip-stats { display:flex; gap:20px; flex-wrap:wrap; }
.trip-stat { font-size:11px; color:var(--text2); }
.trip-stat span { font-weight:600; color:var(--text); }
.trip-tags { display:flex; gap:6px; flex-wrap:wrap; margin-top:12px; }

/* ===== ITINERARY ===== */
.itin-wrap {
  margin-top:14px; padding-top:14px;
  border-top:1px solid var(--border);
}
.itin-toggle {
  display:flex; align-items:center; gap:8px;
  cursor:pointer; user-select:none;
  font-size:12px; font-weight:600; color:var(--voyage);
  padding:2px 0;
}
.itin-toggle:hover { opacity:.75; }
.itin-toggle .itin-chev {
  margin-left:auto; font-size:10px; color:var(--text3);
  transition:transform .2s;
}
.itin-toggle.open .itin-chev { transform:rotate(90deg); }
.itin-body { display:none; margin-top:12px; }
.itin-body.open { display:block; }

.itin-day {
  margin-bottom:12px;
  padding-left:16px;
  border-left:2px solid rgba(56,184,216,.25);
  position:relative;
}
.itin-day::before {
  content:''; position:absolute; left:-5px; top:5px;
  width:8px; height:8px; border-radius:50%;
  background:var(--voyage); border:2px solid var(--bg2);
}
.itin-day-header {
  display:flex; align-items:center; gap:8px; margin-bottom:7px;
}
.itin-day-num {
  width:22px; height:22px; border-radius:50%;
  background:var(--voyage); color:#000;
  font-size:10px; font-weight:700;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.itin-day-title { font-size:13px; font-weight:600; flex:1; }
.itin-day-date  { font-size:10px; color:var(--text3); }

.itin-act {
  display:flex; align-items:flex-start; gap:8px;
  padding:7px 10px; margin-bottom:5px;
  background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius-sm);
}
.itin-act-time {
  font-size:11px; font-weight:700; color:var(--voyage);
  font-variant-numeric:tabular-nums; min-width:36px; flex-shrink:0; padding-top:1px;
}
.itin-act-body { flex:1; min-width:0; }
.itin-act-desc { font-size:13px; font-weight:500; }
.itin-act-loc  { font-size:11px; color:var(--text3); margin-top:2px; }
.itin-type-badge {
  font-size:10px; padding:2px 7px; border-radius:12px;
  background:var(--surface2); color:var(--text3);
  white-space:nowrap; flex-shrink:0;
}
.itin-add-act-btn {
  width:100%; padding:5px 10px; margin-top:4px;
  font-size:11px; font-weight:600; color:var(--voyage);
  background:transparent; border:1px dashed rgba(56,184,216,.3);
  border-radius:var(--radius-sm); cursor:pointer;
  display:flex; align-items:center; gap:6px; transition:background .15s;
}
.itin-add-act-btn:hover { background:rgba(56,184,216,.07); }
.itin-add-day-btn {
  width:100%; padding:7px 12px; margin-top:4px;
  font-size:11px; font-weight:600; color:var(--voyage);
  background:transparent; border:1px dashed rgba(56,184,216,.25);
  border-radius:var(--radius-sm); cursor:pointer;
  display:flex; align-items:center; gap:6px; transition:background .15s;
}
.itin-add-day-btn:hover { background:rgba(56,184,216,.05); }

/* ===== SETTINGS ===== */
.settings-section { margin-bottom:28px; }
.settings-title { 
  font-family:'Bricolage Grotesque',sans-serif; font-size:16px; font-weight:700; letter-spacing:-0.2px;
  margin-bottom:14px; display:flex; align-items:center; gap:8px;
}
.cat-item {
  display:flex; align-items:center; gap:10px;
  padding:10px 14px; background:var(--bg3);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  margin-bottom:6px;
}
.cat-item .cat-name { flex:1; font-size:13px; }
.cat-color { width:16px; height:16px; border-radius:50%; flex-shrink:0; }
.add-cat { 
  display:flex; gap:8px; margin-top:8px;
}

/* ===== TABS ===== */
.tabs { display:flex; gap:4px; margin-bottom:20px; background:var(--bg3); padding:4px; border-radius:var(--radius-sm); }
.tab { 
  flex:1; text-align:center; padding:8px 12px; border-radius:6px;
  font-size:12px; font-weight:500; cursor:pointer; transition:all 0.2s; color:var(--text2);
}
.tab.active { background:var(--surface); color:var(--text); }

/* ===== SECTION FILTER BAR ===== */
.filter-bar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; align-items:center; }
.filter-chip {
  padding:6px 14px; border-radius:20px; border:1px solid var(--border);
  font-size:12px; font-weight:500; cursor:pointer; transition:all 0.2s;
  background:var(--surface); color:var(--text2);
}
.filter-chip.active { border-color:var(--c,var(--accent)); color:var(--c,var(--accent)); background:transparent; }
.filter-spacer { flex:1; }

/* ===== EMPTY STATE ===== */
.empty { 
  text-align:center; padding:60px 20px; color:var(--text3);
}
.empty i { font-size:48px; margin-bottom:16px; display:block; }
.empty p { font-size:14px; }

/* ===== TOAST ===== */
#toast {
  position:fixed; bottom:24px; right:24px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:12px 18px;
  font-size:13px; display:flex; align-items:center; gap:8px;
  transform:translateY(60px); opacity:0; transition:all 0.3s;
  z-index:9999; max-width:300px; box-shadow:var(--shadow);
}
#toast.show { transform:translateY(0); opacity:1; }
#toast i { color:var(--accent); }

/* ===== SECTION PAGES ===== */
.section-page { display:none; }
.section-page.active { display:block; }

/* ===== DASHBOARD CLEAN ===== */
.dash-kpis { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.kpi-pill {
  display:flex; align-items:center; gap:10px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:40px; padding:9px 16px;
  cursor:pointer; transition:all 0.2s; flex:1; min-width:110px;
}
.kpi-pill:hover { border-color:var(--c,var(--accent)); transform:translateY(-1px); }
.kpi-pill-icon {
  width:30px; height:30px; border-radius:50%;
  background:color-mix(in srgb, var(--c,var(--accent)) 15%, transparent);
  display:flex; align-items:center; justify-content:center;
  font-size:13px; color:var(--c,var(--accent)); flex-shrink:0;
}
.kpi-pill-val { font-family:'Bricolage Grotesque',sans-serif; font-size:17px; font-weight:700; line-height:1; }
.kpi-pill-lbl { font-size:10px; color:var(--text3); margin-top:2px; text-transform:uppercase; letter-spacing:0.3px; }

/* ===== ACTIVITY RINGS WIDGET ===== */
.rings-widget {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:16px;
  display:flex;
  gap:24px;
  align-items:center;
  position:relative;
  overflow:hidden;
}
.rings-widget::before {
  content:'';
  position:absolute; top:-60px; right:-60px;
  width:220px; height:220px; border-radius:50%;
  background:radial-gradient(circle, rgba(240,165,0,0.06) 0%, transparent 70%);
  pointer-events:none;
}

/* SVG rings container */
.rings-svg-wrap {
  position:relative;
  flex-shrink:0;
}
.rings-svg-wrap svg {
  transform:rotate(-90deg);
  overflow:visible;
}
.ring-track {
  fill:none;
  stroke-linecap:round;
  opacity:0.12;
}
.ring-fill {
  fill:none;
  stroke-linecap:round;
  transition:stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1);
}
/* Glow filter */
.ring-glow { filter:drop-shadow(0 0 4px var(--glow-color)); }

/* Center text (counter-rotated) */
.rings-center {
  position:absolute;
  inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center;
  transform:none;
}
.rings-center-day {
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:26px; font-weight:800;
  line-height:1; color:var(--text);
  letter-spacing:-0.5px;
}
.rings-center-label {
  font-size:9px; color:var(--text3);
  text-transform:uppercase; letter-spacing:1px;
  margin-top:3px;
}

/* Right side: ring legend + stats */
.rings-info { flex:1; min-width:0; }

.rings-greeting {
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:18px; font-weight:800;
  letter-spacing:-0.3px; margin-bottom:2px;
}
.rings-date {
  font-size:11px; color:var(--text3); margin-bottom:16px;
}

.ring-legend-list { display:flex; flex-direction:column; gap:8px; }
.ring-legend-item {
  display:flex; align-items:center; gap:8px;
  cursor:pointer; transition:opacity 0.2s;
}
.ring-legend-item:hover { opacity:0.7; }
.ring-legend-dot {
  width:8px; height:8px; border-radius:50%; flex-shrink:0;
}
.ring-legend-bar-wrap {
  flex:1; height:4px; background:var(--border); border-radius:2px; overflow:hidden;
}
.ring-legend-bar {
  height:100%; border-radius:2px;
  transition:width 1s cubic-bezier(.4,0,.2,1);
  width:0%;
}
.ring-legend-label { font-size:11px; color:var(--text2); min-width:50px; }
.ring-legend-val {
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:12px; font-weight:700; min-width:28px; text-align:right;
}

@media (max-width:520px) {
  .rings-widget { flex-direction:column; align-items:center; }
  .rings-info { width:100%; }
}

* { scrollbar-width:thin; scrollbar-color:var(--border) transparent; }

/* ===== QUICK ACTION CARDS (Dashboard) ===== */
.quick-action-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px 16px;
  transition:border-color .2s;
}
.quick-action-card:hover { border-color:inherit; }
.quick-action-header {
  display:flex; align-items:center; gap:10px; margin-bottom:10px;
}
.quick-action-input-row {
  display:flex; gap:8px; align-items:center; margin-bottom:0;
}
.quick-input {
  flex:1; padding:8px 12px; font-size:13px;
}
.quick-select {
  width:52px; padding:8px 4px; font-size:13px;
  text-align:center; flex-shrink:0;
}
.quick-textarea {
  width:100%; font-size:12px; padding:8px 12px;
  min-height:56px; resize:none; margin-top:8px;
  border-radius:var(--radius-sm);
}

/* ===== WIDGET GENERATOR ===== */
.widget-code {
  resize:vertical; line-height:1.5;
  border:1px solid var(--border); border-radius:var(--radius-sm);
}
.widget-code:focus { border-color:var(--voyage); }
#widget-preview-box { transition:all .3s; }
#widget-preview-box .wline-title  { color:var(--accent); font-weight:700; font-size:13px; }
#widget-preview-box .wline-sep    { color:var(--border); }
#widget-preview-box .wline-todo   { color:#7c6ff7; }
#widget-preview-box .wline-invest { color:#30c88a; }
#widget-preview-box .wline-voyage { color:#38b8d8; }
#widget-preview-box .wline-notes  { color:#f07050; }
#widget-preview-box .wline-time   { color:#5a6275; font-size:11px; }

/* ===== THEME CUSTOMIZER ===== */
.clr-input {
  width:44px; height:44px; padding:2px; border-radius:10px;
  border:2px solid var(--border); cursor:pointer;
  background:transparent; flex-shrink:0;
  transition:border-color .2s;
}
.clr-input:hover { border-color:var(--accent); }

.swatch-row { display:flex; gap:6px; flex-wrap:wrap; }
.swatch {
  width:28px; height:28px; border-radius:8px; cursor:pointer;
  border:2px solid transparent; transition:all .15s;
  flex-shrink:0;
}
.swatch:hover { transform:scale(1.15); border-color:#fff4; }
.swatch.active { border-color:#fff; transform:scale(1.1); }

.theme-preset {
  display:flex; flex-direction:column; align-items:center; gap:4px;
  cursor:pointer; padding:8px 10px; border-radius:10px;
  border:2px solid var(--border); transition:all .2s;
  font-size:10px; color:var(--text2); font-weight:600;
  text-transform:uppercase; letter-spacing:.3px;
}
.theme-preset:hover { border-color:var(--accent); background:var(--surface2); }
.theme-preset.active { border-color:var(--accent); }
.theme-preset-dots { display:flex; gap:4px; }
.theme-dot { width:12px; height:12px; border-radius:50%; }


.badge-notif {
  font-size:10px; font-weight:700; padding:3px 10px;
  border-radius:20px; text-transform:uppercase; letter-spacing:0.3px;
}
.badge-notif.granted { background:rgba(48,200,138,.15); color:var(--invest); border:1px solid var(--invest); }
.badge-notif.denied  { background:rgba(224,85,85,.15);  color:var(--danger); border:1px solid var(--danger); }
.badge-notif.default { background:rgba(240,165,0,.15);  color:var(--accent); border:1px solid var(--accent); }

.deadline-banner {
  position:fixed; top:12px; left:50%; transform:translateX(-50%) translateY(-120px);
  background:var(--surface); border:1px solid var(--accent); border-radius:var(--radius);
  padding:12px 16px; display:flex; align-items:flex-start; gap:12px;
  min-width:280px; max-width:400px; z-index:9990;
  box-shadow:0 8px 32px rgba(0,0,0,.4);
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);
}
.deadline-banner.show { transform:translateX(-50%) translateY(0); }
.deadline-banner.urgent { border-color:var(--danger); }
.deadline-banner-icon { font-size:20px; flex-shrink:0; }
.deadline-banner-body { flex:1; }
.deadline-banner-title { font-size:13px; font-weight:700; margin-bottom:3px; }
.deadline-banner-msg   { font-size:12px; color:var(--text2); line-height:1.5; }
.deadline-banner-close { color:var(--text3); cursor:pointer; font-size:13px; flex-shrink:0; padding:2px 4px; }
.deadline-banner-close:hover { color:var(--text); }
@media(max-width:768px) {
  .deadline-banner { left:12px; right:12px; min-width:0; max-width:none; transform:translateY(-120px); }
  .deadline-banner.show { transform:translateY(0); }
}

/* ===== MOBILE ===== */
@media (max-width:768px) {
  #sidebar { display:none; }
  #bottomnav { display:flex; }
  /* Décale le contenu pour la rail gauche */
  #app { padding-left:64px; padding-bottom:0; }
  .main { overflow:visible; flex:none; width:100%; }
  /* Topbar sticky */
  .topbar { position:sticky; top:0; z-index:150; padding:0 14px; height:52px; }
  .topbar-title { font-size:16px; }
  #menu-btn { display:none !important; }
  .grid-2, .grid-3, .grid-4 { grid-template-columns:1fr; }
  .grid-3, .grid-4 { grid-template-columns:repeat(2,1fr); }
  .stat-card .stat-value { font-size:22px; }
  .kpi-pill { min-width:80px; padding:8px 12px; }
  .kpi-pill-val { font-size:15px; }
  /* Actions toujours visibles sur mobile */
  .todo-actions { opacity:1; }
  /* Modales bottom-sheet */
  .modal-overlay { align-items:flex-end; padding:0; }
  .modal {
    max-width:100%; border-radius:var(--radius) var(--radius) 0 0;
    max-height:92vh; transform:translateY(100%);
  }
  .modal-overlay.open .modal { transform:translateY(0); }
  /* Padding contenu */
  .content { overflow:visible; padding:14px 14px 32px; flex:none; }
  /* Filter bar scrollable */
  .filter-bar { flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
  .filter-bar::-webkit-scrollbar { display:none; }
  .invest-item { flex-wrap:wrap; }
  /* Deadline banner décalée */
  .deadline-banner { left:76px; right:12px; min-width:0; max-width:none; transform:translateY(-120px); }
  .deadline-banner.show { transform:translateY(0); }
}
@media (max-width:480px) {
  .grid-3, .grid-4 { grid-template-columns:repeat(2,1fr); }
  #bottomnav { width:56px; }
  #app { padding-left:56px; }
  .bnav-item { width:46px; height:46px; }
  .bnav-item i { font-size:17px; }
}


[data-section="todo"] { --c: var(--todo); }
[data-section="notes"] { --c: var(--notes); }
[data-section="invest"] { --c: var(--invest); }
[data-section="culture"] { --c: var(--culture); }
[data-section="voyage"] { --c: var(--voyage); }
[data-section="settings"] { --c: var(--settings); }
[data-section="dashboard"] { --c: var(--accent); }

/* ===== CLOUD SYNC INDICATOR ===== */
.sync-dot { width:8px; height:8px; border-radius:50%; background:var(--text3); flex-shrink:0; }
.sync-dot.synced { background:var(--invest); }
.sync-dot.syncing { background:var(--accent); animation:pulse 1s infinite; }
.sync-dot.error { background:var(--danger); }
.sync-dot.offline { background:var(--text3); }
.sync-dot.pending { background:var(--accent2); animation:pulse 0.8s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Sync bar */
.sync-bar {
  padding:10px 16px; margin:0 8px 8px;
  background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius-sm); cursor:pointer;
  transition:all 0.2s;
}
.sync-bar:hover { border-color:var(--accent); }
.sync-bar-top { display:flex; align-items:center; gap:8px; }
.sync-bar-label { font-size:11px; color:var(--text2); flex:1; }
.sync-bar-time { font-size:10px; color:var(--text3); }
.sync-progress { height:2px; background:var(--border); border-radius:1px; margin-top:6px; overflow:hidden; display:none; }
.sync-progress.active { display:block; }
.sync-progress-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--invest)); width:0%; transition:width 0.3s; border-radius:1px; }

/* Conflict modal */
.conflict-box { background:var(--bg3); border:1px solid var(--danger); border-radius:var(--radius-sm); padding:14px; margin-bottom:12px; }
.conflict-title { font-size:12px; font-weight:600; color:var(--danger); margin-bottom:6px; }
.conflict-detail { font-size:11px; color:var(--text2); line-height:1.5; }

/* Offline queue badge */
.queue-badge {
  background:var(--accent2); color:#000; font-size:9px; font-weight:700;
  padding:2px 6px; border-radius:10px; margin-left:4px;
}

/* ===== STATS SECTION ===== */
.stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
.stats-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; }
.stats-card-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--text3); margin-bottom:14px; display:flex; align-items:center; gap:6px; }
.bar-chart { display:flex; align-items:flex-end; gap:6px; height:80px; }
.bar-chart-col { display:flex; flex-direction:column; align-items:center; gap:4px; flex:1; }
.bar-chart-bar { width:100%; border-radius:3px 3px 0 0; min-height:2px; transition:height .5s cubic-bezier(.4,0,.2,1); }
.bar-chart-label { font-size:9px; color:var(--text3); text-align:center; }
.bar-chart-val { font-size:9px; font-weight:700; color:var(--text2); }
.pie-wrap { position:relative; display:flex; align-items:center; gap:16px; }
.pie-legend { display:flex; flex-direction:column; gap:6px; }
.pie-legend-item { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text2); }
.pie-legend-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.sparkline { display:inline-block; vertical-align:middle; }

/* ===== FOCUS DU JOUR ===== */
.focus-card { background:linear-gradient(135deg,rgba(240,165,0,.08),rgba(240,165,0,.02)); border:1px solid rgba(240,165,0,.2); border-radius:var(--radius); padding:16px 20px; margin-bottom:16px; }
.focus-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--accent); margin-bottom:12px; }
.focus-row { display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.05); font-size:13px; }
.focus-row:last-child { border-bottom:none; }
.focus-icon { width:24px; text-align:center; font-size:14px; flex-shrink:0; }

/* ===== OFFLINE BANNER ===== */
#offline-banner {
  position:fixed; top:0; left:0; right:0; z-index:9998;
  background:rgba(224,85,85,.95); color:#fff;
  padding:8px 16px; font-size:12px; font-weight:600;
  display:flex; align-items:center; justify-content:center; gap:8px;
  transform:translateY(-100%); transition:transform .3s ease;
  backdrop-filter:blur(4px);
}
#offline-banner.show { transform:translateY(0); }
@media(max-width:768px) { #offline-banner { left:64px; } }

/* ===== DRAG & DROP TODOS ===== */
.todo-item[draggable=true] { cursor:grab; }
.todo-item.drag-over { border-color:var(--todo); background:rgba(124,111,247,.08); transform:scale(1.01); }
.todo-item.dragging { opacity:.4; }

/* ===== INVEST SPARKLINE & OBJECTIF ===== */
.invest-sparkline-wrap { margin-top:8px; }
.invest-objectif-bar { height:3px; background:var(--bg3); border-radius:2px; margin-top:6px; position:relative; overflow:visible; }
.invest-objectif-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--invest),var(--accent)); transition:width .6s; }
.invest-objectif-target { position:absolute; top:-2px; width:2px; height:7px; background:var(--accent); border-radius:1px; }

/* ===== PWA INSTALL BUTTON ===== */
#pwa-install-btn {
  display:none; padding:8px 16px; background:var(--accent); color:#000;
  border-radius:var(--radius-sm); font-size:12px; font-weight:600;
  cursor:pointer; border:none; transition:all .2s;
}
#pwa-install-btn.visible { display:inline-flex; align-items:center; gap:6px; }
#pwa-install-btn:hover { background:var(--accent2); }

/* ===== TODO RECURRENCE ===== */
.recur-badge { font-size:10px; color:var(--accent); margin-left:4px; }

/* ===== PRINT / PDF ===== */
@media print {
  #bottomnav, #sidebar, .topbar, .deadline-banner, #toast, #offline-banner,
  .btn, .topbar-actions, #search-overlay { display:none !important; }
  #app { display:block; }
  .section-page { display:block !important; break-inside:avoid; margin-bottom:24px; }
  body { background:#fff; color:#000; font-size:12px; }
  .surface, .card { background:#fff; border:1px solid #ccc; }
  --bg:#fff; --surface:#fff; --text:#000; --text2:#444; --border:#ccc;
}

@media(max-width:768px) {
  .stats-grid { grid-template-columns:1fr; }
}
.section-page { animation:fadeSlide 0.25s ease; }
@keyframes fadeSlide { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* ===== SEARCH ===== */
.search-result-group { margin-bottom:14px; }
.search-result-group-title {
  font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  color:var(--text3);padding:0 4px;margin-bottom:6px;
}
.search-result-item {
  display:flex;align-items:center;gap:12px;
  padding:11px 14px;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;
  transition:all 0.15s;
}
.search-result-item:hover { border-color:var(--accent);background:var(--surface2); }
.search-result-icon { width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0; }
.search-result-title { font-size:13px;font-weight:600; }
.search-result-sub { font-size:11px;color:var(--text3);margin-top:2px; }
.search-highlight { background:rgba(240,165,0,0.25);border-radius:2px;color:var(--accent);font-weight:600; }
.search-empty { text-align:center;padding:40px;color:var(--text3);font-size:13px; }

/* ===== HABITUDES ===== */
.habit-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0;
  margin-bottom:12px;
  overflow:hidden;
  transition:border-color .2s, transform .15s;
  position:relative;
}
.habit-card:hover { border-color:var(--hc, var(--habit)); transform:translateY(-1px); }
.habit-card.completed-today { border-color:var(--hc, var(--habit)); background:color-mix(in srgb, var(--hc, var(--habit)) 5%, var(--surface)); }

.habit-top {
  display:flex; align-items:center; gap:14px;
  padding:18px 20px 14px;
}
.habit-check-btn {
  width:48px; height:48px; border-radius:50%; flex-shrink:0;
  border:2.5px solid var(--hc, var(--habit));
  background:transparent; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:22px; transition:all 0.2s;
  color:var(--hc, var(--habit));
}
.habit-check-btn.done {
  background:var(--hc, var(--habit));
  color:#fff;
  box-shadow:0 4px 16px color-mix(in srgb, var(--hc, var(--habit)) 40%, transparent);
}
.habit-check-btn:hover:not(.done) {
  background:color-mix(in srgb, var(--hc, var(--habit)) 12%, transparent);
}
.habit-info { flex:1; min-width:0; }
.habit-name { font-size:15px; font-weight:600; margin-bottom:2px; display:flex; align-items:center; gap:8px; }
.habit-freq-badge {
  font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.3px;
  padding:2px 8px; border-radius:10px;
  background:color-mix(in srgb, var(--hc, var(--habit)) 15%, transparent);
  color:var(--hc, var(--habit));
}
.habit-meta { font-size:11px; color:var(--text3); display:flex; align-items:center; gap:12px; }
.habit-streak { display:flex; align-items:center; gap:4px; color:var(--accent); font-weight:700; }

.habit-actions { display:flex; gap:4px; align-items:center; }
.habit-actions .btn-icon { width:30px; height:30px; opacity:0; transition:opacity .2s; font-size:12px; }
.habit-card:hover .habit-actions .btn-icon { opacity:1; }

/* 7-day mini dots */
.habit-week {
  display:flex; gap:5px; padding:0 20px 16px;
  align-items:center;
}
.habit-day-dot {
  flex:1; height:6px; border-radius:3px;
  background:var(--bg3);
  position:relative;
  transition:background .25s;
}
.habit-day-dot.done { background:var(--hc, var(--habit)); }
.habit-day-dot.today { outline:2px solid var(--hc, var(--habit)); outline-offset:2px; border-radius:3px; }
.habit-day-label {
  font-size:9px; color:var(--text3); text-align:center;
  margin-bottom:4px; text-transform:uppercase; letter-spacing:.3px;
}
.habit-week-wrap { padding:0 20px 16px; }
.habit-week-labels { display:flex; gap:5px; margin-bottom:4px; }
.habit-week-label { flex:1; font-size:9px; color:var(--text3); text-align:center; text-transform:uppercase; }

/* Heatmap calendar */
.habit-heatmap-wrap { overflow-x:auto; padding-bottom:4px; }
.habit-heatmap {
  display:inline-grid;
  grid-auto-flow:column;
  grid-template-rows:repeat(7,1fr);
  gap:3px;
  padding:4px 0;
  min-width:max-content;
}
.hm-cell {
  width:13px; height:13px; border-radius:3px;
  background:var(--bg3);
  transition:background .2s;
  cursor:default;
}
.hm-cell.l1 { background:color-mix(in srgb, var(--hc,var(--habit)) 30%, transparent); }
.hm-cell.l2 { background:color-mix(in srgb, var(--hc,var(--habit)) 60%, transparent); }
.hm-cell.l3 { background:var(--hc, var(--habit)); }
.hm-cell.today-cell { outline:1.5px solid var(--hc,var(--habit)); outline-offset:1px; }

/* Stat pills */
.habit-stat-pills { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; }
.habit-stat-pill {
  display:flex; align-items:center; gap:8px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:40px; padding:8px 16px;
  font-size:12px;
}
.habit-stat-pill .val {
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:18px; font-weight:700; color:var(--habit);
}

/* Completion ring in modal */
.habit-emoji-grid {
  display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
}
.habit-emoji-opt {
  width:36px; height:36px; border-radius:10px;
  background:var(--bg3); border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:18px; cursor:pointer; transition:all .15s;
}
.habit-emoji-opt.active { border-color:var(--accent); background:rgba(240,165,0,.12); }

.habit-color-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.habit-color-swatch {
  width:26px; height:26px; border-radius:50%;
  cursor:pointer; border:2px solid transparent;
  transition:all .15s;
}
.habit-color-swatch.active { border-color:#fff; transform:scale(1.2); }

/* Empty habits */
.habit-empty {
  text-align:center; padding:60px 20px; color:var(--text3);
}
.habit-empty-icon { font-size:52px; margin-bottom:16px; }

/* Section header row */
.habit-header-row {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:8px;
}
.habit-section-title {
  font-family:'Bricolage Grotesque',sans-serif;
  font-size:13px; font-weight:700; letter-spacing:-.1px;
  color:var(--text2); text-transform:uppercase; letter-spacing:.5px;
}

/* ===== INVEST MINI CHART ===== */
.invest-chart-wrap {
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 20px;margin-bottom:16px;
}
.invest-chart-title { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);margin-bottom:12px; }
.invest-chart-bar-row { display:flex;align-items:center;gap:10px;margin-bottom:6px; }
.invest-chart-bar-label { font-size:11px;color:var(--text2);width:90px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.invest-chart-bar-track { flex:1;height:8px;background:var(--bg3);border-radius:4px;overflow:hidden; }
.invest-chart-bar-fill { height:100%;border-radius:4px;transition:width 0.6s cubic-bezier(.4,0,.2,1); }
.invest-chart-bar-val { font-size:11px;font-weight:600;font-family:'Bricolage Grotesque',sans-serif;width:60px;text-align:right;flex-shrink:0; }

/* ===== JOURNAL ===== */
.journal-entry {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius); padding:0; margin-bottom:12px;
  transition:border-color .2s, transform .15s; cursor:pointer;
  position:relative; overflow:hidden;
}
.journal-entry::before {
  content:''; position:absolute; left:0; top:0; bottom:0;
  width:3px; background:var(--journal);
}
.journal-entry:hover { border-color:var(--journal); transform:translateY(-1px); }
.journal-entry-head { display:flex; align-items:flex-start; gap:14px; padding:16px 18px 10px 20px; }
.journal-date-badge {
  flex-shrink:0; text-align:center;
  background:color-mix(in srgb, var(--journal) 12%, transparent);
  border:1px solid color-mix(in srgb, var(--journal) 25%, transparent);
  border-radius:10px; padding:6px 10px; min-width:48px;
}
.journal-date-day { font-family:'Bricolage Grotesque',sans-serif; font-size:22px; font-weight:800; color:var(--journal); line-height:1; }
.journal-date-mon { font-size:9px; color:var(--text3); text-transform:uppercase; letter-spacing:.5px; margin-top:2px; }
.journal-meta { flex:1; min-width:0; }
.journal-title { font-size:15px; font-weight:600; margin-bottom:3px; display:flex; align-items:center; gap:8px; }
.journal-mood { font-size:18px; }
.journal-preview { padding:0 18px 12px 20px; font-size:13px; color:var(--text2); line-height:1.6; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.journal-footer { padding:9px 18px 11px 20px; border-top:1px solid var(--border); display:flex; align-items:center; gap:12px; font-size:11px; color:var(--text3); }
.journal-tag { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.3px; padding:2px 8px; border-radius:10px; background:var(--bg3); color:var(--text3); border:1px solid var(--border); }
.journal-actions { margin-left:auto; display:flex; gap:4px; opacity:0; transition:opacity .2s; }
.journal-entry:hover .journal-actions { opacity:1; }
.mood-grid { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.mood-opt { width:40px; height:40px; border-radius:10px; font-size:20px; display:flex; align-items:center; justify-content:center; background:var(--bg3); border:2px solid transparent; cursor:pointer; transition:all .15s; }
.mood-opt:hover { border-color:var(--journal); transform:scale(1.1); }
.mood-opt.active { border-color:var(--journal); background:color-mix(in srgb, var(--journal) 15%, transparent); }
.journal-editor { width:100%; min-height:220px; resize:vertical; background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px; color:var(--text); font-family:'Outfit',sans-serif; font-size:14px; line-height:1.7; outline:none; transition:border .2s; }
.journal-editor:focus { border-color:var(--journal); }
.journal-wc { font-size:11px; color:var(--text3); text-align:right; margin-top:4px; }
.journal-stats-row { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.journal-stat-pill { display:flex; align-items:center; gap:8px; background:var(--surface); border:1px solid var(--border); border-radius:40px; padding:8px 16px; }
.journal-stat-pill .val { font-family:'Bricolage Grotesque',sans-serif; font-size:18px; font-weight:700; color:var(--journal); }
</style>
</head>
<body>
<div id="app">

<!-- SIDEBAR (Desktop) -->
<nav id="sidebar">
  <div class="logo">
    <div class="logo-title">JDKActivity</div>
    <div class="logo-sub">Tableau de bord personnel</div>
  </div>
  <div class="nav-item active" data-section="dashboard" onclick="navigate('dashboard')">
    <span class="nav-icon"><i class="fas fa-th-large"></i></span>
    <span class="nav-label">Tableau de bord</span>
  </div>
  <div class="nav-item" data-section="todo" onclick="navigate('todo')" style="--c:var(--todo)">
    <span class="nav-icon"><i class="fas fa-check-circle"></i></span>
    <span class="nav-label">Todo</span>
    <span class="nav-badge" id="badge-todo" style="display:none">0</span>
  </div>
  <div class="nav-item" data-section="notes" onclick="navigate('notes')" style="--c:var(--notes)">
    <span class="nav-icon"><i class="fas fa-pen-nib"></i></span>
    <span class="nav-label">Notes</span>
  </div>
  <div class="nav-item" data-section="invest" onclick="navigate('invest')" style="--c:var(--invest)">
    <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
    <span class="nav-label">Investissement</span>
  </div>
  <div class="nav-item" data-section="culture" onclick="navigate('culture')" style="--c:var(--culture)">
    <span class="nav-icon"><i class="fas fa-film"></i></span>
    <span class="nav-label">Culture</span>
  </div>
  <div class="nav-item" data-section="voyage" onclick="navigate('voyage')" style="--c:var(--voyage)">
    <span class="nav-icon"><i class="fas fa-plane"></i></span>
    <span class="nav-label">Voyage</span>
  </div>
  <div class="nav-item" data-section="habitudes" onclick="navigate('habitudes')" style="--c:var(--habit)">
    <span class="nav-icon"><i class="fas fa-fire"></i></span>
    <span class="nav-label">Habitudes</span>
  </div>
  <div class="nav-item" data-section="journal" onclick="navigate('journal')" style="--c:var(--journal)">
    <span class="nav-icon"><i class="fas fa-book-open"></i></span>
    <span class="nav-label">Journal</span>
  </div>
  <div style="flex:1"></div>
  <div class="sync-bar" onclick="cloudSync()" title="Cliquer pour synchroniser">
    <div class="sync-bar-top">
      <span class="sync-dot" id="sync-dot"></span>
      <span class="sync-bar-label" id="sync-label">Non synchronisé</span>
      <span class="sync-bar-time" id="sync-time"></span>
      <span class="queue-badge" id="sync-queue-badge" style="display:none">0</span>
    </div>
    <div class="sync-progress" id="sync-progress">
      <div class="sync-progress-fill" id="sync-progress-fill"></div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <button class="btn btn-ghost btn-icon" onclick="toggleSidebar()" title="Menu" style="display:none" id="menu-btn">
      <i class="fas fa-bars"></i>
    </button>
    <div class="topbar-title" id="topbar-title">Tableau de bord</div>
    <div class="topbar-actions" id="topbar-actions"></div>
    <button class="btn btn-ghost btn-sm" onclick="openSearch()" title="Rechercher (Ctrl+K)" id="search-btn">
      <i class="fas fa-magnifying-glass"></i>
    </button>
    <button class="btn btn-ghost btn-sm" id="pomo-topbar-btn" onclick="togglePomoPanel()" title="Pomodoro Timer" style="position:relative">
      <i class="fas fa-clock"></i>
      <span id="pomo-topbar-badge" style="display:none;position:absolute;top:2px;right:2px;width:7px;height:7px;border-radius:50%;background:#e868a2"></span>
    </button>
    <button id="pwa-install-btn" title="Installer l'application" onclick="installPWA()">
      <i class="fas fa-download"></i> Installer
    </button>
    <button class="btn btn-ghost btn-sm" onclick="cloudSync()" title="Synchroniser">
      <i class="fas fa-cloud-arrow-up"></i>
    </button>
    <button class="btn btn-ghost btn-sm" onclick="exportData()" title="Exporter">
      <i class="fas fa-download"></i>
    </button>
    <button class="btn btn-ghost btn-sm" onclick="navigate('settings')" title="Paramètres" id="settings-btn" style="position:relative">
      <i class="fas fa-sliders-h"></i>
    </button>
  </div>

  <!-- CONTENT -->
  <div class="content" id="main-content">

    <!-- ===== DASHBOARD ===== -->
    <div class="section-page active" id="page-dashboard">
      <div id="dash-widget"></div>
      <div id="dash-body"></div>
    </div>
    <!-- ===== TODO ===== -->
    <div class="section-page" id="page-todo" data-section="todo">
      <div class="filter-bar" id="todo-filters"></div>
      <div id="todo-list"></div>
    </div>

    <!-- ===== NOTES ===== -->
    <div class="section-page" id="page-notes" data-section="notes">
      <div class="filter-bar" id="notes-filters"></div>
      <div id="notes-keynotes-panel" class="notes-panel">
        <div id="keynotes-list" class="grid-3"></div>
      </div>
      <div id="notes-hwnotes-panel" class="notes-panel" style="display:none">
        <div id="hwnotes-list" class="grid-3"></div>
      </div>
      <div id="notes-allnotes-panel" class="notes-panel" style="display:none">
        <div id="allnotes-list" class="grid-3"></div>
      </div>
    </div>

    <!-- ===== INVEST ===== -->
    <div class="section-page" id="page-invest" data-section="invest">
      <div class="grid-3" id="invest-summary" style="margin-bottom:20px"></div>
      <div id="invest-chart"></div>
      <div class="filter-bar" id="invest-filters"></div>
      <div id="invest-list"></div>
    </div>

    <!-- ===== CULTURE ===== -->
    <div class="section-page" id="page-culture" data-section="culture">
      <div class="filter-bar" id="culture-filters"></div>
      <div class="grid-3" id="culture-grid"></div>
    </div>

    <!-- ===== VOYAGE ===== -->
    <div class="section-page" id="page-voyage" data-section="voyage">
      <div class="tabs">
        <div class="tab active" id="tab-voyage-prochain" onclick="switchTab('voyage','prochain',this)">🗺 À venir</div>
        <div class="tab" id="tab-voyage-passe" onclick="switchTab('voyage','passe',this)">✅ Passés</div>
        <div class="tab" id="tab-voyage-idees" onclick="switchTab('voyage','idees',this)">💡 Idées</div>
      </div>
      <div id="voyage-list"></div>
    </div>

    <!-- ===== HABITUDES ===== -->
    <div class="section-page" id="page-habitudes" data-section="habitudes">

      <!-- Stats pills -->
      <div class="habit-stat-pills" id="habit-stats-pills"></div>

      <!-- Today block -->
      <div class="habit-header-row">
        <div class="habit-section-title">🔥 Aujourd'hui</div>
        <div style="font-size:11px;color:var(--text3)" id="habit-today-rate"></div>
      </div>
      <div id="habit-today-list" style="margin-bottom:28px"></div>

      <!-- Heatmap block -->
      <div class="habit-header-row" style="margin-bottom:14px">
        <div class="habit-section-title">📆 Calendrier — 3 derniers mois</div>
        <div style="display:flex;gap:6px;align-items:center;font-size:11px;color:var(--text3)">
          <span style="width:10px;height:10px;border-radius:2px;background:var(--bg3);display:inline-block"></span>0
          <span style="width:10px;height:10px;border-radius:2px;background:color-mix(in srgb,var(--habit) 35%,transparent);display:inline-block"></span>~
          <span style="width:10px;height:10px;border-radius:2px;background:var(--habit);display:inline-block"></span>Toutes
        </div>
      </div>
      <div id="habit-heatmap-section" style="margin-bottom:28px"></div>

    </div>

    <!-- ===== JOURNAL ===== -->
    <div class="section-page" id="page-journal" data-section="journal">

      <!-- Stats row -->
      <div class="journal-stats-row" id="journal-stats"></div>

      <!-- Filter bar -->
      <div class="filter-bar" id="journal-filters" style="margin-bottom:20px"></div>

      <!-- Entries list -->
      <div id="journal-list"></div>

    </div>

    <!-- ===== SETTINGS ===== -->
    <div class="section-page" id="page-settings" data-section="settings">
      <div class="grid-2">
        <div>
          <div class="settings-section">
            <div class="settings-title"><i class="fas fa-check-circle" style="color:var(--todo)"></i> Catégories Todo</div>
            <div id="todo-cats-list"></div>
            <div class="add-cat">
              <input class="form-input" id="new-todo-cat" placeholder="Nouvelle catégorie...">
              <button class="btn btn-primary btn-sm" onclick="addCat('todo')">Ajouter</button>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title"><i class="fas fa-bell" style="color:var(--accent)"></i> Rappels échéances</div>
            <div class="card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
                <span style="font-size:12px;color:var(--text2)">Autorisation</span>
                <span class="badge-notif" id="notif-perm-badge">—</span>
              </div>
              <div class="form-group">
                <label class="form-label">Vérifier les échéances</label>
                <select class="form-select" id="notif-freq" onchange="saveNotifConfig()">
                  <option value="0">Désactivé</option>
                  <option value="60" selected>Toutes les heures</option>
                  <option value="480">2× par jour</option>
                  <option value="1440">Une fois par jour</option>
                </select>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary btn-sm" onclick="requestNotifPerm()">
                  <i class="fas fa-bell"></i> Autoriser
                </button>
                <button class="btn btn-ghost btn-sm" onclick="checkDeadlines(true)">
                  <i class="fas fa-clock"></i> Tester
                </button>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title"><i class="fas fa-film" style="color:var(--culture)"></i> Catégories Culture</div>
            <div id="culture-cats-list"></div>
            <div class="add-cat">
              <input class="form-input" id="new-culture-cat" placeholder="Nouvelle catégorie...">
              <button class="btn btn-primary btn-sm" onclick="addCat('culture')">Ajouter</button>
            </div>
          </div>
        </div>
        <div>
          <div class="settings-section">
            <div class="settings-title"><i class="fas fa-chart-line" style="color:var(--invest)"></i> Catégories Investissement</div>
            <div id="invest-cats-list"></div>
            <div class="add-cat">
              <input class="form-input" id="new-invest-cat" placeholder="Nouvelle catégorie...">
              <button class="btn btn-primary btn-sm" onclick="addCat('invest')">Ajouter</button>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title"><i class="fas fa-cloud" style="color:var(--voyage)"></i> Synchronisation Netlify Blobs</div>
            <div class="card">
              <div class="form-group">
                <label class="form-label">URL de ton site Netlify</label>
                <input class="form-input" id="netlify-url" placeholder="https://monsite.netlify.app" oninput="saveCloudConfig()">
                <small style="color:var(--text3);font-size:11px;margin-top:4px;display:block">
                  L'URL de base de ton site Netlify (sans slash final). La fonction sera appelée sur <code style="color:var(--accent)">/.netlify/functions/sync</code>.
                </small>
              </div>
              <div class="form-group">
                <label class="form-label">Token secret <span style="color:var(--text3);font-weight:400">(variable <code>JDK_SECRET_TOKEN</code> dans Netlify)</span></label>
                <input class="form-input" type="password" id="netlify-token" placeholder="mon-token-secret" oninput="saveCloudConfig()">
                <small style="color:var(--text3);font-size:11px;margin-top:4px;display:block">
                  Définis la variable d'env <code style="color:var(--accent)">JDK_SECRET_TOKEN</code> dans Netlify → Site configuration → Environment variables, puis mets la même valeur ici.
                </small>
              </div>
              <div class="form-group">
                <label class="form-label">⚡ Sync automatique en arrière-plan</label>
                <select class="form-select" id="cloud-autosync" onchange="saveCloudConfig();restartAutoSync()">
                  <option value="0" selected>Désactivée</option>
                  <option value="1">Toutes les minutes</option>
                  <option value="5">Toutes les 5 minutes</option>
                  <option value="15">Toutes les 15 minutes</option>
                  <option value="30">Toutes les 30 minutes</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">🔀 Résolution de conflits</label>
                <select class="form-select" id="cloud-conflict" onchange="saveCloudConfig()">
                  <option value="ask">Me demander (recommandé)</option>
                  <option value="local">Toujours garder le local</option>
                  <option value="remote">Toujours garder Netlify</option>
                  <option value="newer">Le plus récent gagne</option>
                </select>
              </div>
              <div style="background:var(--bg3);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                  <span class="sync-dot" id="sync-dot2"></span>
                  <span style="font-size:12px;color:var(--text2)" id="sync-status-detail">—</span>
                </div>
                <div style="font-size:11px;color:var(--text3);line-height:1.8">
                  <div>📤 File d'attente : <strong id="queue-count" style="color:var(--text)">0</strong> modification(s)</div>
                  <div>🕐 Dernière sync : <span id="last-cloud-sync" style="color:var(--text)">Jamais</span></div>
                  <div>🔁 Prochaine sync : <span id="next-sync-time" style="color:var(--text)">—</span></div>
                  <div>📦 Taille payload : <span id="payload-size" style="color:var(--text)">—</span></div>
                  <div style="margin-top:4px">Empreinte locale : <code id="local-hash" style="font-size:10px;color:var(--accent)">—</code></div>
                </div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="cloudSync(true)"><i class="fas fa-cloud-arrow-up"></i> Sync maintenant</button>
                <button class="btn btn-ghost" onclick="cloudPull()"><i class="fas fa-cloud-arrow-down"></i> Restaurer</button>
                <button class="btn btn-ghost btn-sm" onclick="netlifyTest()" title="Tester la connexion"><i class="fas fa-plug"></i> Tester</button>
              </div>
            </div>
          </div>
            <div class="card">
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> Exporter JSON</button>
                <button class="btn btn-ghost" onclick="$('import-file').click()"><i class="fas fa-upload"></i> Importer JSON</button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
              </div>
              <div style="margin-top:12px; font-size:12px; color:var(--text3)">Dernière sauvegarde locale : <span id="last-save">Jamais</span></div>
            </div>
          </div>
        </div>
      <!-- WIDGET SECTION — full width -->
      <div class="settings-section" style="margin-top:8px">
        <div class="settings-title"><i class="fas fa-mobile-screen" style="color:var(--voyage)"></i> Widget Android</div>
        <div class="card">

          <!-- Tabs -->
          <div class="filter-bar" id="widget-tabs" style="margin-bottom:16px">
            <div class="filter-chip active" style="--c:var(--voyage)" onclick="switchWidgetTab('preview')">👁 Aperçu</div>
            <div class="filter-chip" style="--c:var(--voyage)" onclick="switchWidgetTab('macrodroid')">MacroDroid</div>
            <div class="filter-chip" style="--c:var(--voyage)" onclick="switchWidgetTab('tasker')">Tasker</div>
            <div class="filter-chip" style="--c:var(--voyage)" onclick="switchWidgetTab('http')">HTTP Shortcuts</div>
          </div>

          <!-- Preview Panel -->
          <div id="widget-panel-preview">
            <div style="font-size:12px;color:var(--text3);margin-bottom:12px">Aperçu en temps réel de vos données actuelles</div>
            <div id="widget-preview-box" style="
              background:#0d0f14; border:1px solid var(--border); border-radius:16px;
              padding:16px; font-family:'Outfit',monospace; font-size:12px;
              color:#e8eaf0; max-width:360px; line-height:1.8;
            "></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn btn-primary btn-sm" onclick="refreshWidgetPreview()"><i class="fas fa-rotate"></i> Actualiser</button>
            </div>
          </div>

          <!-- MacroDroid Panel -->
          <div id="widget-panel-macrodroid" style="display:none">
            <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
              Script JavaScript pré-rempli avec vos credentials JSONBin.<br>
              Dans MacroDroid : <strong>+ Action → Scripting → JavaScript</strong> → collez le script.
            </div>
            <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
              <button class="btn btn-primary btn-sm" onclick="copyWidgetScript('macrodroid')"><i class="fas fa-copy"></i> Copier</button>
            </div>
            <textarea id="widget-script-macrodroid" class="form-textarea widget-code" readonly style="min-height:280px;font-family:monospace;font-size:11px;background:var(--bg3)"></textarea>
          </div>

          <!-- Tasker Panel -->
          <div id="widget-panel-tasker" style="display:none">
            <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
              Script pour Tasker JavaScriptlet pré-rempli.<br>
              Dans Tasker : <strong>+ Action → Scripting → JavaScriptlet</strong> → collez le script.
            </div>
            <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
              <button class="btn btn-primary btn-sm" onclick="copyWidgetScript('tasker')"><i class="fas fa-copy"></i> Copier</button>
            </div>
            <textarea id="widget-script-tasker" class="form-textarea widget-code" readonly style="min-height:280px;font-family:monospace;font-size:11px;background:var(--bg3)"></textarea>
            <div style="margin-top:10px;padding:10px;background:var(--bg3);border-radius:var(--radius-sm);font-size:11px;color:var(--text3)">
              <strong style="color:var(--text2);display:block;margin-bottom:4px">Configuration requête HTTP dans Tasker :</strong>
              URL : <code id="widget-jsonbin-url" style="color:var(--accent)">—</code><br>
              Header : <code style="color:var(--accent)">X-Master-Key: <span id="widget-apikey-display">configurez votre clé dans Cloud Sync</span></code>
            </div>
          </div>

          <!-- HTTP Shortcuts Panel -->
          <div id="widget-panel-http" style="display:none">
            <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.6">
              Script pour HTTP Shortcuts (Response Handling → Run Script).<br>
              Affiche une popup avec vos données au tap.
            </div>
            <div style="display:flex;justify-content:flex-end;margin-bottom:6px">
              <button class="btn btn-primary btn-sm" onclick="copyWidgetScript('http')"><i class="fas fa-copy"></i> Copier</button>
            </div>
            <textarea id="widget-script-http" class="form-textarea widget-code" readonly style="min-height:280px;font-family:monospace;font-size:11px;background:var(--bg3)"></textarea>
            <div style="margin-top:10px;padding:10px;background:var(--bg3);border-radius:var(--radius-sm);font-size:11px;color:var(--text3)">
              <strong style="color:var(--text2);display:block;margin-bottom:4px">Configuration dans HTTP Shortcuts :</strong>
              Method : <code style="color:var(--accent)">GET</code><br>
              URL : <code id="widget-jsonbin-url2" style="color:var(--accent)">—</code><br>
              Header : <code style="color:var(--accent)">X-Master-Key: <span id="widget-apikey-display2">configurez votre clé</span></code><br>
              Header : <code style="color:var(--accent)">X-Bin-Meta: false</code>
            </div>
          </div>

        </div>
      </div>

      <!-- THEME SECTION — full width, inside page-settings -->
      <div class="settings-section" style="margin-top:8px">
        <div class="settings-title"><i class="fas fa-palette" style="color:var(--accent)"></i> Apparence & Couleurs</div>
        <div class="card">

          <!-- Presets -->
          <div class="form-group">
            <label class="form-label">Thème prédéfini</label>
            <div id="theme-presets" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          </div>

          <!-- Base colors -->
          <div class="form-group">
            <label class="form-label">Couleur principale (accent)</label>
            <div style="display:flex;gap:10px;align-items:center">
              <input type="color" id="clr-accent" class="clr-input" oninput="applyThemeColor('accent',this.value);applyThemeColor('accent2',lighten(this.value,20))">
              <div id="clr-accent-swatches" class="swatch-row"></div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
            <div class="form-group">
              <label class="form-label"><span style="color:var(--todo)">■</span> Todo</label>
              <input type="color" id="clr-todo" class="clr-input" oninput="applyThemeColor('todo',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label"><span style="color:var(--notes)">■</span> Notes</label>
              <input type="color" id="clr-notes" class="clr-input" oninput="applyThemeColor('notes',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label"><span style="color:var(--invest)">■</span> Invest</label>
              <input type="color" id="clr-invest" class="clr-input" oninput="applyThemeColor('invest',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label"><span style="color:var(--culture)">■</span> Culture</label>
              <input type="color" id="clr-culture" class="clr-input" oninput="applyThemeColor('culture',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label"><span style="color:var(--voyage)">■</span> Voyage</label>
              <input type="color" id="clr-voyage" class="clr-input" oninput="applyThemeColor('voyage',this.value)">
            </div>
            <div class="form-group">
              <label class="form-label">Arrière-plan</label>
              <input type="color" id="clr-bg" class="clr-input" oninput="applyBgColor(this.value)">
            </div>
          </div>

          <!-- Radius -->
          <div class="form-group">
            <label class="form-label">Arrondi des coins — <span id="radius-val">14px</span></label>
            <input type="range" id="radius-range" min="0" max="24" value="14" step="2"
              style="width:100%;accent-color:var(--accent)"
              oninput="applyRadius(this.value)">
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px">
            <button class="btn btn-ghost btn-sm" onclick="resetTheme()"><i class="fas fa-rotate-left"></i> Réinitialiser</button>
          </div>
        </div>
      </div><!-- /theme-section -->

    </div><!-- /page-settings -->

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- OFFLINE BANNER -->
<div id="offline-banner">
  <i class="fas fa-wifi-slash"></i> Hors ligne — modifications en attente de synchronisation
</div>

<!-- RAIL NAV (Mobile) -->
<nav id="bottomnav">
  <div class="bnav-logo">J</div>
  <div class="bnav-items">
    <div class="bnav-item active" data-section="dashboard" onclick="navigate('dashboard')" style="--c:var(--accent)">
      <i class="fas fa-th-large"></i><span>Accueil</span>
    </div>
    <div class="bnav-item" data-section="todo" onclick="navigate('todo')" style="--c:var(--todo)">
      <i class="fas fa-check-circle"></i><span>Todo</span>
      <span class="bnav-badge" id="bnav-badge-todo" style="display:none">0</span>
    </div>
    <div class="bnav-item" data-section="notes" onclick="navigate('notes')" style="--c:var(--notes)">
      <i class="fas fa-pen-nib"></i><span>Notes</span>
    </div>
    <div class="bnav-item" data-section="invest" onclick="navigate('invest')" style="--c:var(--invest)">
      <i class="fas fa-chart-line"></i><span>Invest</span>
    </div>
    <div class="bnav-item" data-section="culture" onclick="navigate('culture')" style="--c:var(--culture)">
      <i class="fas fa-film"></i><span>Culture</span>
    </div>
    <div class="bnav-item" data-section="voyage" onclick="navigate('voyage')" style="--c:var(--voyage)">
      <i class="fas fa-plane"></i><span>Voyage</span>
    </div>
    <div class="bnav-item" data-section="habitudes" onclick="navigate('habitudes')" style="--c:var(--habit)">
      <i class="fas fa-fire"></i><span>Habits</span>
    </div>
    <div class="bnav-item" data-section="journal" onclick="navigate('journal')" style="--c:var(--journal)">
      <i class="fas fa-book-open"></i><span>Journal</span>
    </div>
  </div>
</nav>

<!-- TOAST -->
<!-- POMODORO FLOATING PANEL -->
<div id="pomo-panel" style="
  display:none; position:fixed; top:68px; right:12px; z-index:800;
  width:300px; background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--radius); box-shadow:0 12px 40px rgba(0,0,0,0.5);
  overflow:hidden;
">
  <!-- Header -->
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(232,104,162,0.1),rgba(200,109,212,0.06))">
    <div style="display:flex;align-items:center;gap:8px">
      <i class="fas fa-clock" style="color:#e868a2;font-size:13px"></i>
      <span style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:14px">Pomodoro</span>
    </div>
    <button class="btn btn-ghost btn-icon" onclick="togglePomoPanel()" style="width:26px;height:26px;font-size:11px"><i class="fas fa-xmark"></i></button>
  </div>

  <!-- Mode tabs -->
  <div style="display:flex;gap:0;border-bottom:1px solid var(--border)">
    <div id="ptab-work"  onclick="pomoSetMode('work')"  style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid #e868a2;color:#e868a2;transition:all .2s">🎯 Focus</div>
    <div id="ptab-short" onclick="pomoSetMode('short')" style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--text3);transition:all .2s">☕ Pause</div>
    <div id="ptab-long"  onclick="pomoSetMode('long')"  style="flex:1;text-align:center;padding:8px 4px;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--text3);transition:all .2s">🌸 Longue</div>
  </div>

  <!-- Timer -->
  <div style="padding:24px 18px 16px;text-align:center">
    <!-- Ring -->
    <div style="position:relative;width:140px;height:140px;margin:0 auto 20px;cursor:pointer" onclick="pomoToggle()">
      <svg width="140" height="140" viewBox="0 0 140 140" style="transform:rotate(-90deg)">
        <circle cx="70" cy="70" r="60" fill="none" stroke="rgba(232,104,162,0.12)" stroke-width="8"/>
        <circle id="pomo-ring" cx="70" cy="70" r="60" fill="none" stroke="url(#pg)" stroke-width="8"
          stroke-linecap="round" stroke-dasharray="376.99" stroke-dashoffset="0"
          style="transition:stroke-dashoffset 0.9s linear"/>
        <defs>
          <linearGradient id="pg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#e868a2"/>
            <stop offset="100%" stop-color="#c86dd4"/>
          </linearGradient>
        </defs>
      </svg>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
        <div id="pomo-digits" style="font-family:'Bricolage Grotesque',sans-serif;font-size:34px;font-weight:800;letter-spacing:-2px;line-height:1;color:var(--text)">25:00</div>
        <div id="pomo-mode-lbl" style="font-size:10px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:1px">Focus</div>
      </div>
    </div>

    <!-- Controls -->
    <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:16px">
      <button onclick="pomoReset()" style="width:34px;height:34px;border-radius:50%;background:var(--surface);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:12px;transition:all .2s" onmouseover="this.style.borderColor='#e868a2';this.style.color='#e868a2'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">
        <i class="fas fa-rotate-left"></i>
      </button>
      <button id="pomo-play-btn" onclick="pomoToggle()" style="width:50px;height:50px;border-radius:50%;background:#e868a2;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;box-shadow:0 4px 16px rgba(232,104,162,0.4);transition:all .2s">
        <i id="pomo-play-icon" class="fas fa-play"></i>
      </button>
      <button onclick="pomoSkip()" style="width:34px;height:34px;border-radius:50%;background:var(--surface);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:12px;transition:all .2s" onmouseover="this.style.borderColor='#e868a2';this.style.color='#e868a2'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">
        <i class="fas fa-forward-step"></i>
      </button>
    </div>

    <!-- Session dots -->
    <div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px" id="pomo-dots">
      <div class="pdot"></div><div class="pdot"></div><div class="pdot"></div><div class="pdot"></div>
    </div>

    <!-- Stats -->
    <div style="font-size:11px;color:var(--text3)">
      Aujourd'hui : <strong id="pomo-today" style="color:#e868a2">0</strong> &nbsp;·&nbsp; Total : <strong id="pomo-total" style="color:#e868a2">0</strong>
    </div>
  </div>

  <!-- Duration settings -->
  <div style="padding:0 18px 16px;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3)">
      🎯
      <select id="pomo-dur-work" onchange="pomoUpdateDur()" style="width:62px;font-size:11px;padding:3px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)">
        <option value="15">15 min</option><option value="20">20 min</option>
        <option value="25" selected>25 min</option><option value="30">30 min</option>
        <option value="45">45 min</option><option value="50">50 min</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3)">
      ☕
      <select id="pomo-dur-short" onchange="pomoUpdateDur()" style="width:58px;font-size:11px;padding:3px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)">
        <option value="3">3 min</option><option value="5" selected>5 min</option><option value="10">10 min</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3)">
      🌸
      <select id="pomo-dur-long" onchange="pomoUpdateDur()" style="width:58px;font-size:11px;padding:3px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text)">
        <option value="10">10 min</option><option value="15" selected>15 min</option>
        <option value="20">20 min</option><option value="30">30 min</option>
      </select>
    </div>
  </div>
</div>

<style>
.pdot {
  width:9px;height:9px;border-radius:50%;
  background:rgba(232,104,162,0.2);border:1px solid rgba(232,104,162,0.35);
  transition:all .3s;
}
.pdot.done { background:#e868a2;border-color:#e868a2; }
</style>

<div id="toast"><i class="fas fa-circle-check"></i><span id="toast-msg"></span></div>

<!-- DEADLINE BANNER -->
<div class="deadline-banner" id="deadline-banner">
  <div class="deadline-banner-icon" id="deadline-banner-icon">⏰</div>
  <div class="deadline-banner-body">
    <div class="deadline-banner-title" id="deadline-banner-title"></div>
    <div class="deadline-banner-msg"   id="deadline-banner-msg"></div>
  </div>
  <div class="deadline-banner-close" onclick="closeDeadlineBanner()"><i class="fas fa-xmark"></i></div>
</div>

<!-- SEARCH OVERLAY -->
<div id="search-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1100;padding:60px 20px 20px" onclick="if(event.target===this)closeSearch()">
  <div style="max-width:600px;margin:0 auto">
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px">
      <div style="flex:1;position:relative">
        <i class="fas fa-magnifying-glass" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)"></i>
        <input id="search-input" class="form-input" placeholder="Rechercher dans tout JDKActivity…"
          style="padding-left:40px;font-size:15px;background:var(--bg2);border-color:var(--accent)"
          oninput="runSearch(this.value)"
          onkeydown="if(event.key==='Escape')closeSearch()">
      </div>
      <button class="btn btn-ghost" onclick="closeSearch()">Fermer</button>
    </div>
    <div id="search-results" style="max-height:70vh;overflow-y:auto"></div>
  </div>
</div>

<!-- MODALS CONTAINER -->
<div id="modals-container"></div>

<script>

// ── Section names (avoid magic strings) ─────────────────────────────
const SECTIONS = ['dashboard','todo','notes','invest','culture','voyage','habitudes','journal','settings'];
const SECTION_TITLES = {
  dashboard:'Tableau de bord', todo:'Todo', notes:'Notes',
  invest:'Investissement', culture:'Culture', voyage:'Voyage',
  habitudes:'Habitudes 🔥', journal:'Journal', settings:'Paramètres'
};

// ── Helpers ──────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const setHTML = (id, html) => { const el = $(id); if (el) el.innerHTML = html; };

// ===== STATE =====
let state = {
  todo: [], notes: [], invest: [], culture: [], voyage: [], habits: [], journal: [],
  cats: {
    todo: ['Personnel','Travail','Santé','Maison','Urgent'],
    invest: ['Actions','Banque','Crypto','Immobilier','Obligations','ETF'],
    culture: ['Films','Séries TV','Expo','Livres','Musique','Podcasts']
  },
  cloud: { netlifyUrl:'', netlifyToken:'', autoSync:0, conflictStrategy:'ask' },
  notifFreq: 60,
  lastSave: null
};

let currentSection = 'dashboard';
let currentNoteTab = 'keynotes';
let currentInvestTab = 'all';
let currentVoyageTab = 'prochain';
let currentCultureFilter = 'all';
let currentTodoFilter = 'all';
let drawingCtx = null, isDrawing = false, drawColor = '#000', drawSize = 3;

// ===== INIT =====
function init() {
  loadData();
  loadTheme();
  setupResponsive();
  render();
  updateBadges();
  updateHashDisplay();
  restoreCloudUI();
  restartAutoSync();
  initDeadlineNotif();
  initPWA();
  initOfflineBanner();
  initVoyageReminders();
  initKeyboardShortcuts();
  // On launch: restore from cloud if configured (pull, not push)
  if (state.cloud.netlifyUrl) {
    setTimeout(() => cloudPull(), 2500);
  }
}

// ===== DATA =====
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}) : ''; }
function formatMoney(n) { return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n||0); }

function loadData() {
  try {
    const saved = localStorage.getItem('jdkactivity');
    if (saved) {
      const d = JSON.parse(saved);
      // Merge carefully
      if (d.todo) state.todo = d.todo;
      if (d.notes) state.notes = d.notes;
      if (d.invest) state.invest = d.invest;
      if (d.culture) state.culture = d.culture;
      if (d.voyage) state.voyage = d.voyage;
      if (d.cats) state.cats = { ...state.cats, ...d.cats };
      if (d.cloud) state.cloud = { ...state.cloud, ...d.cloud };
      if (d.notifFreq !== undefined) state.notifFreq = d.notifFreq;
      if (d.theme) state.theme = d.theme;
      if (d.lastSave) state.lastSave = d.lastSave;
    }
  } catch(e) {
    console.warn('[JDK] loadData error:', e);
  }
}

function saveDataSilent() {
  try {
    state.lastSave = new Date().toISOString();
    // Try to save, with fallback stripping images if quota exceeded
    let payload = state;
    try {
      localStorage.setItem('jdkactivity', JSON.stringify(payload));
    } catch(quota) {
      console.warn('[JDK] localStorage quota exceeded, stripping images...');
      payload = stripImagesForStorage(state);
      localStorage.setItem('jdkactivity', JSON.stringify(payload));
    }
    const lsEl = $('last-save');
    if (lsEl) lsEl.textContent = new Date(state.lastSave).toLocaleString('fr-FR');
  } catch(e) {
    console.error('[JDK] saveDataSilent error:', e);
    toast('Erreur sauvegarde locale', 'fas fa-xmark');
  }
}

function stripImagesForStorage(s) {
  const clone = JSON.parse(JSON.stringify(s));
  (clone.notes||[]).forEach(n => { n.photo = null; });
  (clone.culture||[]).forEach(c => { c.image = null; });
  return clone;
}

function saveData() {
  saveDataSilent();
  enqueueChange();
}

function saveCloudConfig() {
  const get = id => { const el = $(id); return el ? el.value.trim() : ''; };
  state.cloud.netlifyUrl   = get('netlify-url').replace(/\/$/, '');
  state.cloud.netlifyToken = get('netlify-token');
  const as = $('cloud-autosync');
  if (as) state.cloud.autoSync = parseInt(as.value) || 0;
  const cf = $('cloud-conflict');
  if (cf) state.cloud.conflictStrategy = cf.value;
  saveDataSilent();
}

function restoreCloudUI() {
  const setVal = (id, val) => { const el = $(id); if (el && val) el.value = val; };
  setVal('netlify-url',   state.cloud.netlifyUrl   || '');
  setVal('netlify-token', state.cloud.netlifyToken || '');
  const as = $('cloud-autosync');
  if (as && state.cloud.autoSync !== undefined) as.value = state.cloud.autoSync;
  const cf = $('cloud-conflict');
  if (cf && state.cloud.conflictStrategy) cf.value = state.cloud.conflictStrategy;
  if (state.lastSave) {
    const ls = $('last-save');
    if (ls) ls.textContent = new Date(state.lastSave).toLocaleString('fr-FR');
  }
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'jdkactivity_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  toast('Export réussi !');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.todo !== undefined) state.todo = data.todo;
      if (data.notes !== undefined) state.notes = data.notes;
      if (data.invest !== undefined) state.invest = data.invest;
      if (data.culture !== undefined) state.culture = data.culture;
      if (data.voyage !== undefined) state.voyage = data.voyage;
      if (data.habits !== undefined) state.habits = data.habits;
      if (data.journal !== undefined) state.journal = data.journal;
      if (data.cats !== undefined) state.cats = { ...state.cats, ...data.cats };
      if (data.cloud !== undefined) state.cloud = { ...state.cloud, ...data.cloud };
      saveDataSilent();
      render();
      toast('Import réussi !');
    } catch { toast('Fichier invalide', 'fas fa-xmark'); }
  };
  reader.readAsText(file);
}

// ===== NETLIFY BLOBS SYNC ENGINE =====
let autoSyncTimer = null;
let nextSyncTimestamp = null;
let syncQueue = [];
let lastLocalHash = null;
let lastCloudHash = null;
let isOnline = navigator.onLine;

window.addEventListener('online', () => {
  isOnline = true;
  setSyncState('pending', 'Reconnecté — sync en attente');
  setTimeout(() => flushQueue(), 1500);
});
window.addEventListener('offline', () => {
  isOnline = false;
  setSyncState('offline', 'Hors ligne');
});

function simpleHash(obj) {
  try {
    const str = JSON.stringify({ t:(obj.todo||[]).length, n:(obj.notes||[]).length, i:(obj.invest||[]).length, c:(obj.culture||[]).length, v:(obj.voyage||[]).length, h:(obj.habits||[]).length, j:(obj.journal||[]).length, ts:obj.lastSave });
    let h = 0;
    for (let i = 0; i < str.length; i++) { h = ((h<<5)-h) + str.charCodeAt(i); h |= 0; }
    return (h>>>0).toString(16).slice(0,8);
  } catch { return Math.random().toString(16).slice(2,10); }
}

function updateHashDisplay() {
  lastLocalHash = simpleHash(state);
  const el = $('local-hash');
  if (el) el.textContent = lastLocalHash;
}

function updateQueueDisplay() {
  const n = syncQueue.length;
  const badge = $('sync-queue-badge');
  if (badge) { badge.textContent = n; badge.style.display = n > 0 ? 'inline-flex' : 'none'; }
  const countEl = $('queue-count');
  if (countEl) countEl.textContent = n;
}

function enqueueChange() {
  const h = simpleHash(state);
  if (h === lastLocalHash && syncQueue.length === 0) return;
  lastLocalHash = h;
  updateHashDisplay();
  syncQueue.push({ hash: h, timestamp: Date.now() });
  updateQueueDisplay();
  if (!isOnline) { setSyncState('pending','Hors ligne — modif en attente'); return; }
  clearTimeout(window._debounceSync);
  window._debounceSync = setTimeout(() => {
    if (state.cloud.netlifyUrl) doSync(false);
  }, 3000);
}

function netlifyApiUrl() {
  return (state.cloud.netlifyUrl||'').replace(/\/$/, '') + '/.netlify/functions/sync';
}

function netlifyHeaders(extra) {
  const h = { 'Content-Type': 'application/json' };
  if (state.cloud.netlifyToken) h['Authorization'] = 'Bearer ' + state.cloud.netlifyToken;
  return { ...h, ...extra };
}

async function netlifyTest() {
  if (!state.cloud.netlifyUrl) {
    toast("Configure l'URL Netlify d'abord", 'fas fa-warning');
    return;
  }
  setSyncState('syncing', 'Test de connexion…');
  try {
    const res = await fetch(netlifyApiUrl(), { headers: netlifyHeaders() });
    if (res.ok || res.status === 404) {
      setSyncState('synced', 'Connexion Netlify OK ✓');
      toast('Connexion Netlify réussie ✓');
    } else if (res.status === 401) {
      setSyncState('error', 'Token invalide (401)');
      toast('Token invalide — vérifie JDK_SECRET_TOKEN', 'fas fa-xmark');
    } else {
      throw new Error('HTTP ' + res.status);
    }
  } catch(e) {
    setSyncState('error', 'Échec : ' + e.message);
    toast('Erreur connexion : ' + e.message, 'fas fa-xmark');
  }
}

function mergeRemoteData(remote) {
  const clone = JSON.parse(JSON.stringify(remote));
  const best = (a, b) => { if (!a && !b) return null; if (!a) return b; if (!b) return a; return a.length >= b.length ? a : b; };
  const localNotes = {};
  (state.notes||[]).forEach(n => localNotes[n.id] = n);
  for (const n of clone.notes||[]) {
    const loc = localNotes[n.id]; if (!loc) continue;
    n.photo      = best(n.photo,      loc.photo);
    n.canvasData = best(n.canvasData, loc.canvasData);
  }
  const localCulture = {};
  (state.culture||[]).forEach(c => localCulture[c.id] = c);
  for (const c of clone.culture||[]) {
    const loc = localCulture[c.id]; if (!loc) continue;
    c.image = best(c.image, loc.image);
  }
  return clone;
}

async function buildPayload() {
  const clone = JSON.parse(JSON.stringify(state));
  // Compress images for cloud storage
  const compress = (b64, maxW, maxH, q) => new Promise(res => {
    if (!b64 || !b64.startsWith('data:')) { res(b64); return; }
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      const ratio = Math.min(maxW/w, maxH/h, 1);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      if (w < 1 || h < 1) { res(b64); return; }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
      const result = c.toDataURL('image/jpeg', q);
      res(result.length < b64.length ? result : b64);
    };
    img.onerror = () => res(b64);
    img.src = b64;
  });
  for (const n of clone.notes||[]) {
    if (n.photo)      n.photo      = await compress(n.photo, 400, 400, 0.5);
    if (n.canvasData) n.canvasData = await compress(n.canvasData, 700, 500, 0.35);
  }
  for (const c of clone.culture||[]) {
    if (c.image) c.image = await compress(c.image, 300, 400, 0.5);
  }
  return clone;
}

async function doSync(showToast=true, force=false) {
  if (!state.cloud.netlifyUrl) return;
  if (!isOnline) { setSyncState('offline','Hors ligne'); return; }
  const currentHash = simpleHash(state);
  if (!force && currentHash === lastCloudHash && syncQueue.length === 0) {
    setSyncState('synced','À jour'); return;
  }
  setSyncState('syncing','Synchronisation…');
  showSyncProgress(true);
  try {
    animateSyncProgress(20);

    // Check for conflict — fetch remote first
    if (lastCloudHash) {
      const getRes = await fetch(netlifyApiUrl(), { headers: netlifyHeaders() });
      if (getRes.ok) {
        const body = await getRes.json();
        const rd = body.data;
        if (rd) {
          const rh = simpleHash(rd);
          if (rh !== lastCloudHash && rh !== currentHash) {
            animateSyncProgress(40);
            await handleConflict(rd, rh);
            return;
          }
        }
      }
    }
    animateSyncProgress(60);

    // Push
    const payload = await buildPayload();
    payload._meta = { hash: currentHash, syncedAt: new Date().toISOString() };
    const res = await fetch(netlifyApiUrl(), {
      method: 'POST',
      headers: netlifyHeaders(),
      body: JSON.stringify(payload),
    });
    animateSyncProgress(100);

    if (res.ok) {
      lastCloudHash = currentHash;
      syncQueue = [];
      updateQueueDisplay();
      saveDataSilent();
      const now = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      setSyncState('synced', `Synchronisé à ${now}`);
      const lcs = $('last-cloud-sync');
      if (lcs) lcs.textContent = new Date().toLocaleString('fr-FR');
      const ps = $('payload-size');
      if (ps) ps.textContent = Math.round(new Blob([JSON.stringify(payload)]).size/1024) + ' KB';
      if (showToast) toast('Netlify synchronisé ✓');
    } else {
      const err = await res.json().catch(()=>({error:'HTTP '+res.status}));
      throw new Error(err.error || 'HTTP ' + res.status);
    }
  } catch(e) {
    console.error('[JDK] Netlify sync error:', e);
    setSyncState('error', isOnline ? 'Erreur : ' + e.message : 'Hors ligne');
    if (showToast) toast('Erreur sync : ' + e.message, 'fas fa-xmark');
  } finally {
    setTimeout(() => showSyncProgress(false), 800);
  }
}

async function handleConflict(remoteData, remoteHash) {
  const strategy = state.cloud.conflictStrategy || 'ask';
  if (strategy === 'local') { await doSync(true, true); return; }
  if (strategy === 'remote') {
    const merged = mergeRemoteData(remoteData);
    Object.assign(state, merged); saveDataSilent(); render();
    lastCloudHash = remoteHash;
    setSyncState('synced','Restauré (Netlify)'); toast('Données Netlify appliquées'); return;
  }
  if (strategy === 'newer') {
    const lt = state.lastSave ? new Date(state.lastSave).getTime() : 0;
    const rt = remoteData._meta?.syncedAt ? new Date(remoteData._meta.syncedAt).getTime() : 0;
    if (lt >= rt) await doSync(true, true);
    else {
      const merged = mergeRemoteData(remoteData);
      Object.assign(state, merged); saveDataSilent(); render();
      lastCloudHash = remoteHash;
      setSyncState('synced','Netlify plus récent'); toast('Version Netlify appliquée');
    }
    return;
  }
  // ask
  showSyncProgress(false);
  window._conflictRemote = remoteData;
  window._conflictRemoteHash = remoteHash;
  const lt = state.lastSave ? new Date(state.lastSave).toLocaleString('fr-FR') : 'Inconnue';
  const rt = remoteData._meta?.syncedAt ? new Date(remoteData._meta.syncedAt).toLocaleString('fr-FR') : 'Inconnue';
  showModal('conflict-modal', `
    <div class="modal-header">
      <div class="modal-title" style="color:var(--danger)"><i class="fas fa-triangle-exclamation"></i> Conflit détecté</div>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Local et Netlify ont divergé.</p>
      <div class="conflict-box">
        <div class="conflict-title">📱 Local — ${lt}</div>
        <div class="conflict-detail">Tâches: ${state.todo.length} · Notes: ${state.notes.length} · Journal: ${(state.journal||[]).length}</div>
        <button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="resolveConflict('local')">Garder le local →</button>
      </div>
      <div class="conflict-box" style="border-color:var(--voyage);margin-top:10px">
        <div class="conflict-title" style="color:var(--voyage)">☁️ Netlify — ${rt}</div>
        <div class="conflict-detail">Tâches: ${(remoteData.todo||[]).length} · Notes: ${(remoteData.notes||[]).length} · Journal: ${(remoteData.journal||[]).length}</div>
        <button class="btn btn-ghost btn-sm" style="margin-top:10px;border-color:var(--voyage);color:var(--voyage)" onclick="resolveConflict('remote')">Garder Netlify →</button>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('conflict-modal')">Annuler</button></div>
  `);
  setSyncState('error','Conflit — action requise');
}

window.resolveConflict = async function(choice) {
  closeModal('conflict-modal');
  if (choice === 'local') {
    await doSync(true, true);
  } else {
    const merged = mergeRemoteData(window._conflictRemote);
    Object.assign(state, merged); saveDataSilent(); render();
    lastCloudHash = window._conflictRemoteHash;
    setSyncState('synced','Version Netlify appliquée');
    toast('Version Netlify appliquée');
  }
};

async function cloudSync(showToast=true) {
  if (!state.cloud.netlifyUrl) {
    toast("Configure l'URL Netlify dans Paramètres", 'fas fa-warning');
    navigate('settings'); return;
  }
  await doSync(showToast, true);
}

async function cloudPull() {
  if (!state.cloud.netlifyUrl) {
    toast('Aucune config Netlify','fas fa-warning'); return;
  }
  setSyncState('syncing','Restauration depuis Netlify…');
  showSyncProgress(true);
  try {
    animateSyncProgress(50);
    const res = await fetch(netlifyApiUrl(), { headers: netlifyHeaders() });
    animateSyncProgress(90);
    if (res.ok) {
      const body = await res.json();
      const rd = body.data;
      if (!rd) { toast('Aucune donnée sur Netlify','fas fa-warning'); return; }
      lastCloudHash = simpleHash(rd);
      const merged = mergeRemoteData(rd);
      Object.assign(state, merged);
      saveDataSilent(); render();
      setSyncState('synced','Restauré depuis Netlify');
      const lcs = $('last-cloud-sync');
      if (lcs) lcs.textContent = new Date().toLocaleString('fr-FR');
      toast('Données restaurées depuis Netlify !');
    } else {
      const err = await res.json().catch(()=>({error:'HTTP '+res.status}));
      throw new Error(err.error || 'HTTP '+res.status);
    }
  } catch(e) {
    setSyncState('error','Erreur restauration');
    toast('Erreur restauration : ' + e.message, 'fas fa-xmark');
  } finally { setTimeout(() => showSyncProgress(false), 800); }
}

async function flushQueue() {
  if (syncQueue.length === 0) { toast("File d'attente vide"); return; }
  await doSync(true, true);
}

function showSyncProgress(show) {
  const el = $('sync-progress');
  if (!el) return;
  if (show) { el.classList.add('active'); animateSyncProgress(0); }
  else setTimeout(() => el.classList.remove('active'), 300);
}

function animateSyncProgress(pct) {
  const el = $('sync-progress-fill');
  if (el) el.style.width = pct + '%';
}

function restartAutoSync() {
  clearInterval(autoSyncTimer);
  clearInterval(window._nextSyncCountdown);
  const mins = parseInt(state.cloud.autoSync) || 0;
  const el2 = $('next-sync-time');
  if (mins === 0 || !state.cloud.netlifyUrl) { if (el2) el2.textContent = 'Désactivée'; return; }
  const ms = mins * 60 * 1000;
  nextSyncTimestamp = Date.now() + ms;
  autoSyncTimer = setInterval(async () => {
    nextSyncTimestamp = Date.now() + ms;
    if (isOnline && state.cloud.netlifyUrl) await doSync(false);
  }, ms);
  window._nextSyncCountdown = setInterval(() => {
    if (!nextSyncTimestamp) return;
    const rem = Math.max(0, nextSyncTimestamp - Date.now());
    const m = Math.floor(rem/60000), s = Math.floor((rem%60000)/1000);
    if (el2) el2.textContent = `dans ${m}m ${s < 10 ? '0'+s : s}s`;
  }, 1000);
}

function setSyncState(s, label) {
  ['sync-dot','sync-dot2'].forEach(id => { const el = $(id); if (el) el.className = 'sync-dot ' + s; });
  const lbl = $('sync-label'); if (lbl) lbl.textContent = label;
  const det = $('sync-status-detail'); if (det) det.textContent = label;
}

// ===== NAVIGATION =====
// ===== NAVIGATION =====
function navigate(section) {
  currentSection = section;
  document.querySelectorAll('.section-page').forEach(p => p.classList.remove('active'));
  const page = $('page-' + section);
  if (page) page.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.section === section));
  document.querySelectorAll('.bnav-item').forEach(n => n.classList.toggle('active', n.dataset.section === section));
  // Highlight settings button in topbar
  const sb = $('settings-btn');
  if (sb) sb.style.color = section === 'settings' ? 'var(--accent)' : '';
  const titles = { dashboard:'Tableau de bord', todo:'Todo', notes:'Notes', invest:'Investissement', culture:'Culture', voyage:'Voyage', settings:'Paramètres', habitudes:'Habitudes 🔥', journal:'Journal 📓' };
  const tt = $('topbar-title');
  if (tt) tt.textContent = titles[section] || section;
  renderTopbarActions(section);
  renderSection(section);
}

function renderTopbarActions(section) {
  const c = $('topbar-actions');
  if (!c) return;
  const actions = {
    todo: `<button class="btn btn-primary btn-sm" onclick="openTodoModal()"><i class="fas fa-plus"></i> Tâche</button>`,
    notes: `<button class="btn btn-primary btn-sm" onclick="openNoteModal('key')"><i class="fas fa-keyboard"></i> Clavier</button>
            <button class="btn btn-ghost btn-sm" onclick="openNoteModal('hw')"><i class="fas fa-pen-nib"></i> Manuscrit</button>`,
    invest: `<button class="btn btn-primary btn-sm" onclick="openInvestModal()"><i class="fas fa-plus"></i> Position</button>
             <label class="btn btn-ghost btn-sm" style="cursor:pointer" title="Importer CSV (nom,achat,actuel,cat,ticker)">
               <i class="fas fa-file-csv"></i> CSV
               <input type="file" accept=".csv" style="display:none" onchange="importInvestCSV(event)">
             </label>`,
    culture: `<button class="btn btn-primary btn-sm" onclick="openCultureModal()"><i class="fas fa-plus"></i> Ajouter</button>`,
    voyage: `<button class="btn btn-primary btn-sm" onclick="openVoyageModal()"><i class="fas fa-plus"></i> Voyage</button>`,
    habitudes: `<button class="btn btn-primary btn-sm" onclick="openHabitModal()"><i class="fas fa-plus"></i> Habitude</button>`,
    journal: `<button class="btn btn-primary btn-sm" onclick="openJournalModal()"><i class="fas fa-plus"></i> Entrée</button>`,
  };
  c.innerHTML = actions[section] || '';
}

function setupResponsive() {
  const check = () => {
    const btn = $('menu-btn');
    if (btn) btn.style.display = window.innerWidth < 768 ? 'flex' : 'none';
  };
  check();
  window.addEventListener('resize', check);
}

function toggleSidebar() {
  const s = $('sidebar');
  if (s) s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
}

function switchTab(section, tab, el) {
  if (section === 'notes') {
    switchNoteTab(tab);
  } else if (section === 'invest') {
    switchInvestCat(tab);
  } else if (section === 'voyage') {
    currentVoyageTab = tab;
    document.querySelectorAll('#page-voyage .tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    renderVoyage();
  }
}

// ===== RENDER =====
function render() {
  renderDashboard();
  renderSection(currentSection);
  updateBadges();
  renderSettings();
  refreshWidgetPreview();
}

function renderSection(section) {
  if (section === 'todo') renderTodo();
  else if (section === 'notes') renderNotes();
  else if (section === 'invest') renderInvest();
  else if (section === 'culture') renderCulture();
  else if (section === 'voyage') renderVoyage();
  else if (section === 'settings') renderSettings();
  else if (section === 'habitudes') renderHabitudes();
  else if (section === 'journal') renderJournal();
}

function updateBadges() {
  const pending = (state.todo||[]).filter(t => !t.done).length;
  const b1 = $('badge-todo');
  if (b1) { b1.style.display = pending > 0 ? 'flex' : 'none'; b1.textContent = pending; }
  const b2 = $('bnav-badge-todo');
  if (b2) { b2.style.display = pending > 0 ? 'flex' : 'none'; b2.textContent = pending; }
}

// ===== DASHBOARD =====
function renderDashboard() {
  const now     = new Date();
  const greet   = now.getHours() < 18 ? 'Bonjour' : 'Bonsoir';
  const dayStr  = now.toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
  const dayNum  = now.getDate();
  const monthSh = now.toLocaleDateString('fr-FR',{month:'short'}).replace('.','');

  const todos    = state.todo    || [];
  const notes    = state.notes   || [];
  const cultures = state.culture || [];

  const todoDone    = todos.filter(t => t.done).length;
  const todoTotal   = todos.length;
  const todoRate    = todoTotal ? todoDone / todoTotal : 0;
  const todoPending = todoTotal - todoDone;

  const cultureDone  = cultures.filter(c => c.statut === 'done').length;
  const cultureTotal = Math.max(cultures.length, 1);
  const cultureRate  = cultureDone / cultureTotal;

  const weekAgo   = Date.now() - 7*24*3600*1000;
  const notesWeek = notes.filter(n => n.date > weekAgo).length;
  const notesRate = Math.min(notesWeek / 5, 1);

  const totalAchat  = (state.invest||[]).reduce((s,i) => s+(parseFloat(i.valeurAchat)||0),   0);
  const totalActuel = (state.invest||[]).reduce((s,i) => s+(parseFloat(i.valeurActuelle)||0), 0);
  const pnlPct      = totalAchat ? (totalActuel - totalAchat) / totalAchat : 0;
  const investRate  = Math.max(0, Math.min((pnlPct + 0.3) / 0.6, 1));

  const SIZE = 160, CX = SIZE/2, CY = SIZE/2, SW = 9;
  const rings = [
    { r:68, color:'var(--todo)',    rate:todoRate,    label:'Tâches',  val: todoTotal ? `${todoDone}/${todoTotal}` : '—', nav:'todo'    },
    { r:54, color:'var(--culture)', rate:cultureRate, label:'Culture', val: cultureDone ? `${cultureDone}` : '—',         nav:'culture' },
    { r:40, color:'var(--notes)',   rate:notesRate,   label:'Notes 7j',val: notesWeek ? `+${notesWeek}` : '0',            nav:'notes'   },
    { r:26, color:'var(--invest)',  rate:investRate,  label:'Invest',  val: totalAchat ? (pnlPct>=0?'+':'')+Math.round(pnlPct*100)+'%' : '—', nav:'invest' },
  ];

  const ringsHTML = rings.map(ring => {
    const circ = 2 * Math.PI * ring.r;
    return `
      <circle class="ring-track" cx="${CX}" cy="${CY}" r="${ring.r}" stroke="${ring.color}" stroke-width="${SW}"/>
      <circle class="ring-fill" cx="${CX}" cy="${CY}" r="${ring.r}"
        stroke="${ring.color}" stroke-width="${SW}"
        stroke-dasharray="${circ}" stroke-dashoffset="${circ}"
        style="--glow-color:${ring.color}"
        data-offset="${circ * (1 - ring.rate)}"/>`;
  }).join('');

  const legendHTML = rings.map(ring => `
    <div class="ring-legend-item" onclick="navigate('${ring.nav}')">
      <div class="ring-legend-dot" style="background:${ring.color}"></div>
      <span class="ring-legend-label">${ring.label}</span>
      <div class="ring-legend-bar-wrap">
        <div class="ring-legend-bar" style="background:${ring.color}" data-pct="${Math.round(ring.rate*100)}"></div>
      </div>
      <span class="ring-legend-val" style="color:${ring.color}">${ring.val}</span>
    </div>`).join('');

  // Streak: days in a row with at least 1 action (todo done or note added)
  let streak = 0;
  for (let d = 0; d < 30; d++) {
    const dayStart = new Date(); dayStart.setHours(0,0,0,0); dayStart.setDate(dayStart.getDate()-d);
    const dayEnd   = new Date(dayStart); dayEnd.setDate(dayEnd.getDate()+1);
    const active   = todos.some(t => t.done && t.date >= dayStart && t.date < dayEnd)
                  || notes.some(n => n.date >= dayStart && n.date < dayEnd);
    if (active) streak++; else if (d > 0) break;
  }

  const widget = $('dash-widget');
  if (!widget) return;

  widget.innerHTML = `
    <div class="rings-widget">
      <div class="rings-svg-wrap" style="width:${SIZE}px;height:${SIZE}px;flex-shrink:0">
        <svg width="${SIZE}" height="${SIZE}" viewBox="0 0 ${SIZE} ${SIZE}" style="transform:rotate(-90deg);overflow:visible">
          <defs>
            <filter id="ring-glow"><feGaussianBlur stdDeviation="2.5" result="b"/>
              <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          ${ringsHTML}
        </svg>
        <div class="rings-center">
          <div class="rings-center-day">${dayNum}</div>
          <div class="rings-center-label">${monthSh}</div>
        </div>
      </div>
      <div class="rings-info">
        <div class="rings-greeting">${greet} \u{1F44B}</div>
        <div class="rings-date">${dayStr.charAt(0).toUpperCase()+dayStr.slice(1)}</div>
        ${streak > 1 ? `<div style="display:inline-flex;align-items:center;gap:5px;background:rgba(240,165,0,0.12);border:1px solid rgba(240,165,0,0.25);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;color:var(--accent);margin-bottom:12px">🔥 ${streak} jours d'affilée</div>` : '<div style="margin-bottom:12px"></div>'}
        <div class="ring-legend-list">${legendHTML}</div>
        ${todoPending > 0 ? `<div style="margin-top:14px;font-size:11px;color:var(--text3)">${todoPending} tâche${todoPending>1?'s':''} en attente</div>` : `<div style="margin-top:14px;font-size:11px;color:var(--invest)">✓ Tout est à jour !</div>`}
      </div>
    </div>`;

  // Animate rings
  requestAnimationFrame(() => requestAnimationFrame(() => {
    document.querySelectorAll('.ring-fill').forEach(el => {
      el.style.strokeDashoffset = el.dataset.offset;
      el.style.filter = `drop-shadow(0 0 5px ${el.getAttribute('stroke')})`;
    });
    document.querySelectorAll('.ring-legend-bar').forEach(el => {
      el.style.width = el.dataset.pct + '%';
    });
  }));

  // Actions rapides
  const body = $('dash-body');
  if (body) body.innerHTML = `
    ${renderFocusDay()}
    ${renderHabitsDashWidget()}
    <div style="margin-top:8px">
      <div class="dash-section-title"><span>Actions rapides</span></div>
      <div style="display:flex;flex-direction:column;gap:10px">

        <!-- Nouvelle tâche rapide -->
        <div class="quick-action-card" style="border-color:var(--todo)">
          <div class="quick-action-header">
            <span class="icon-box" style="background:rgba(124,111,247,0.15);color:var(--todo);width:28px;height:28px;border-radius:8px;font-size:13px">
              <i class="fas fa-check-circle"></i>
            </span>
            <span style="font-size:13px;font-weight:600;color:var(--text)">Nouvelle tâche</span>
            <button class="btn btn-ghost btn-sm btn-icon" style="margin-left:auto" onclick="openTodoModal()" title="Options avancées">
              <i class="fas fa-sliders-h" style="font-size:11px"></i>
            </button>
          </div>
          <div class="quick-action-input-row">
            <input class="form-input quick-input" id="quick-todo-text"
              placeholder="Que devez-vous faire ?"
              onkeydown="if(event.key===\'Enter\')quickAddTodo()">
            <select class="form-select quick-select" id="quick-todo-priority" title="Priorité">
              <option value="high">🔴</option>
              <option value="medium" selected>🟡</option>
              <option value="low">🟢</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="quickAddTodo()">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- Nouvelle note rapide -->
        <div class="quick-action-card" style="border-color:var(--notes)">
          <div class="quick-action-header">
            <span class="icon-box" style="background:rgba(240,112,80,0.15);color:var(--notes);width:28px;height:28px;border-radius:8px;font-size:13px">
              <i class="fas fa-keyboard"></i>
            </span>
            <span style="font-size:13px;font-weight:600;color:var(--text)">Nouvelle note</span>
            <button class="btn btn-ghost btn-sm btn-icon" style="margin-left:auto" onclick="quickNewNote()" title="Note complète">
              <i class="fas fa-expand" style="font-size:11px"></i>
            </button>
          </div>
          <div class="quick-action-input-row">
            <input class="form-input quick-input" id="quick-note-title"
              placeholder="Titre de la note...">
          </div>
          <textarea class="form-textarea quick-textarea" id="quick-note-content"
            placeholder="Contenu... (Ctrl+Entrée pour valider)"
            rows="2"
            onkeydown="if(event.key===\'Enter\'&&(event.ctrlKey||event.metaKey))quickAddNote()"></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:6px">
            <button class="btn btn-primary btn-sm" onclick="quickAddNote()">
              <i class="fas fa-plus"></i> Enregistrer
            </button>
          </div>
        </div>

      </div>
    </div>`;
}

function renderHabitsDashWidget() {
  const habits = state.habits||[];
  if(!habits.length) return '';
  const today = habitToday();
  const doneCount = habits.filter(h=>(h.completions||[]).includes(today)).length;
  const allDone = doneCount === habits.length;

  const items = habits.map(h=>{
    const done = (h.completions||[]).includes(today);
    const streak = habitStreak(h);
    const color = h.color||'var(--habit)';
    return `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border-radius:var(--radius-sm);border:1px solid ${done?color:'var(--border)'};transition:border-color .2s;cursor:pointer" onclick="habitToggleToday('${h.id}');renderDashboard()">
        <div style="width:32px;height:32px;border-radius:50%;border:2px solid ${color};background:${done?color:'transparent'};display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0">
          ${done ? '<span style="color:#fff;font-weight:700;font-size:12px">✓</span>' : (h.emoji||'🎯')}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;${done?'text-decoration:line-through;opacity:.6':''}">${h.name}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:1px">🔥 ${streak} j de suite</div>
        </div>
        ${done?`<span style="font-size:10px;font-weight:600;color:${color}">✓ Fait</span>`:''}
      </div>`;
  }).join('');

  return `
    <div style="margin-top:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="dash-section-title" style="margin-bottom:0"><span>🔥 Habitudes du jour</span></div>
        <div style="font-size:11px;color:${allDone?'var(--habit)':'var(--text3)'};font-weight:600">
          ${allDone?'🎉 Tout validé !':doneCount+'/'+habits.length+' complétées'}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${items}
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px;width:100%;justify-content:center;font-size:11px" onclick="navigate('habitudes')">
        Voir toutes les habitudes <i class="fas fa-arrow-right" style="font-size:10px"></i>
      </button>
    </div>`;
}

function quickNewNote() {
  navigate('notes');
  setTimeout(() => openNoteModal('key'), 100);
}

function quickAddTodo() {
  const input = $('quick-todo-text');
  const text  = (input?.value || '').trim();
  if (!text) { input?.focus(); return; }
  const priority = $('quick-todo-priority')?.value || 'medium';
  if (!state.todo) state.todo = [];
  state.todo.push({ id:uid(), text, priority, done:false, date:Date.now() });
  saveData();
  updateBadges();
  renderDashboard();
  // Flash confirmation — re-focus input
  setTimeout(() => {
    const inp = $('quick-todo-text');
    if (inp) { inp.value=''; inp.focus(); }
  }, 50);
  toast('Tâche ajoutée ✓');
}

function quickAddNote() {
  const titleEl   = $('quick-note-title');
  const contentEl = $('quick-note-content');
  const title   = (titleEl?.value   || '').trim();
  const content = (contentEl?.value || '').trim();
  if (!title && !content) { titleEl?.focus(); return; }
  if (!state.notes) state.notes = [];
  state.notes.push({
    id:uid(), date:Date.now(), type:'key',
    title: title || 'Note rapide',
    content
  });
  saveData();
  renderDashboard();
  setTimeout(() => {
    const t = $('quick-note-title'), c = $('quick-note-content');
    if (t) t.value = '';
    if (c) c.value = '';
    if (t) t.focus();
  }, 50);
  toast('Note enregistrée ✓');
}

// ===== TODO =====
function renderTodo() {
  const cats = ['all', ...(state.cats.todo||[])];
  const fb = $('todo-filters');
  if (!fb) return;
  fb.innerHTML = cats.map(c => `<div class="filter-chip ${currentTodoFilter===c?'active':''}" style="--c:var(--todo)" onclick="filterTodo('${c}')">${c==='all'?'Toutes':c}</div>`).join('') +
    `<div class="filter-spacer"></div>
     <select class="form-select" style="width:auto;padding:6px 12px" onchange="filterTodoPriority(this.value)">
       <option value="all">Toutes priorités</option><option value="high">🔴 Haute</option><option value="medium">🟡 Moyenne</option><option value="low">🟢 Basse</option>
     </select>`;

  let todos = state.todo||[];
  if (currentTodoFilter !== 'all') todos = todos.filter(t => t.cat === currentTodoFilter);
  const done = todos.filter(t => t.done);
  const notDone = todos.filter(t => !t.done).sort((a,b) => ({high:0,medium:1,low:2}[a.priority||'medium'] - {high:0,medium:1,low:2}[b.priority||'medium']));
  const sorted = [...notDone, ...done];

  const list = $('todo-list');
  if (!list) return;
  const recurLabel = {daily:'🔁',weekly:'📅',monthly:'🗓️'};
  list.innerHTML = sorted.length ? sorted.map((t,idx) => `
    <div class="todo-item ${t.done?'done':''}" draggable="true" data-id="${t.id}" data-idx="${idx}"
      ondragstart="todoDragStart(event)" ondragover="todoDragOver(event)" ondragleave="todoDragLeave(event)" ondrop="todoDrop(event)">
      <i class="fas fa-grip-vertical" style="color:var(--text3);font-size:11px;cursor:grab;flex-shrink:0"></i>
      <div class="priority-dot p-${t.priority||'medium'}"></div>
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo('${t.id}')"></div>
      <div style="flex:1">
        <div class="todo-text">${t.text}${t.recurrence?`<span class="recur-badge">${recurLabel[t.recurrence]||''}</span>`:''}</div>
        <div class="todo-meta">${t.cat||''} ${t.dueDate ? '· Échéance: '+formatDate(t.dueDate) : ''}</div>
      </div>
      <div class="todo-actions">
        <button class="btn btn-ghost btn-icon btn-sm" onclick="editTodo('${t.id}')"><i class="fas fa-pen"></i></button>
        <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteTodo('${t.id}')"><i class="fas fa-trash"></i></button>
      </div>
    </div>`).join('') : '<div class="empty"><i class="fas fa-check-double"></i><p>Aucune tâche !</p></div>';
}

function filterTodo(cat) { currentTodoFilter = cat; renderTodo(); }
function filterTodoPriority(p) {
  let todos = p === 'all' ? (state.todo||[]) : (state.todo||[]).filter(t => t.priority === p);
  const list = $('todo-list');
  if (!list) return;
  list.innerHTML = todos.map(t => `
    <div class="todo-item ${t.done?'done':''}">
      <div class="priority-dot p-${t.priority||'medium'}"></div>
      <div class="todo-check ${t.done?'checked':''}" onclick="toggleTodo('${t.id}')"></div>
      <div style="flex:1"><div class="todo-text">${t.text}</div><div class="todo-meta">${t.cat||''}</div></div>
      <div class="todo-actions">
        <button class="btn btn-ghost btn-icon btn-sm" onclick="editTodo('${t.id}')"><i class="fas fa-pen"></i></button>
        <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteTodo('${t.id}')"><i class="fas fa-trash"></i></button>
      </div>
    </div>`).join('') || '<div class="empty"><i class="fas fa-check-double"></i><p>Aucune tâche</p></div>';
}

function toggleTodo(id) {
  const t = (state.todo||[]).find(t => t.id === id);
  if (!t) return;
  t.done = !t.done;
  // Recurrence: when marking done, create next occurrence
  if (t.done && t.recurrence && t.dueDate) {
    const next = new Date(t.dueDate);
    if (t.recurrence === 'daily') next.setDate(next.getDate()+1);
    else if (t.recurrence === 'weekly') next.setDate(next.getDate()+7);
    else if (t.recurrence === 'monthly') next.setMonth(next.getMonth()+1);
    state.todo.push({ id:uid(), text:t.text, cat:t.cat, priority:t.priority, dueDate:next.toISOString().slice(0,10), recurrence:t.recurrence, notes:t.notes, done:false, date:Date.now() });
    toast('✅ Tâche récurrente → prochaine le '+formatDate(next.toISOString()));
  }
  saveData(); renderTodo(); updateBadges(); renderDashboard();
}

function deleteTodo(id) {
  state.todo = (state.todo||[]).filter(t => t.id !== id);
  saveData(); renderTodo(); updateBadges();
}

function editTodo(id) {
  const t = (state.todo||[]).find(t => t.id === id);
  if (t) openTodoModal(t);
}

function openTodoModal(todo=null) {
  const catOpts = (state.cats.todo||[]).map(c => `<option value="${c}" ${todo?.cat===c?'selected':''}>${c}</option>`).join('');
  showModal('todo-modal', `
    <div class="modal-header">
      <div class="modal-title">${todo?'Modifier la tâche':'Nouvelle tâche'}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('todo-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Tâche *</label>
        <input class="form-input" id="todo-text" placeholder="Que devez-vous faire ?" value="${todo?.text||''}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Catégorie</label>
          <select class="form-select" id="todo-cat"><option value="">Sans catégorie</option>${catOpts}</select></div>
        <div class="form-group"><label class="form-label">Priorité</label>
          <select class="form-select" id="todo-priority">
            <option value="high" ${todo?.priority==='high'?'selected':''}>🔴 Haute</option>
            <option value="medium" ${!todo||todo?.priority==='medium'?'selected':''}>🟡 Moyenne</option>
            <option value="low" ${todo?.priority==='low'?'selected':''}>🟢 Basse</option>
          </select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date d'échéance</label>
          <input class="form-input" type="date" id="todo-due" value="${todo?.dueDate||''}"></div>
        <div class="form-group"><label class="form-label">Récurrence</label>
          <select class="form-select" id="todo-recur">
            <option value="" ${!todo?.recurrence?'selected':''}>Aucune</option>
            <option value="daily" ${todo?.recurrence==='daily'?'selected':''}>🔁 Quotidienne</option>
            <option value="weekly" ${todo?.recurrence==='weekly'?'selected':''}>📅 Hebdomadaire</option>
            <option value="monthly" ${todo?.recurrence==='monthly'?'selected':''}>🗓️ Mensuelle</option>
          </select></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label>
        <textarea class="form-textarea" id="todo-notes" placeholder="Détails...">${todo?.notes||''}</textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('todo-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveTodo('${todo?.id||''}')">Enregistrer</button>
    </div>`);
}

function saveTodo(existingId) {
  const text = ($('todo-text')?.value||'').trim();
  if (!text) { toast('Saisissez le texte de la tâche', 'fas fa-warning'); return; }
  const data = {
    text,
    cat: $('todo-cat')?.value||'',
    priority: $('todo-priority')?.value||'medium',
    dueDate: $('todo-due')?.value||'',
    recurrence: $('todo-recur')?.value||'',
    notes: $('todo-notes')?.value||''
  };
  if (existingId) {
    const t = (state.todo||[]).find(t => t.id === existingId);
    if (t) Object.assign(t, data);
  } else {
    if (!state.todo) state.todo = [];
    state.todo.push({ id:uid(), done:false, date:Date.now(), ...data });
  }
  saveData();
  closeModal('todo-modal');
  renderTodo();
  updateBadges();
  renderDashboard();
  toast(existingId ? 'Tâche modifiée' : 'Tâche ajoutée');
}

// ===== NOTES =====
function renderNotes() {
  const key = (state.notes||[]).filter(n => n.type === 'key');
  const hw  = (state.notes||[]).filter(n => n.type === 'hw');
  const all = [...(state.notes||[])].sort((a,b) => (b.date||0)-(a.date||0));

  // Filter bar — same style as Todo
  const fb = $('notes-filters');
  const tabs = [
    { id:'keynotes', label:'<i class="fas fa-keyboard"></i> Clavier',        count: key.length },
    { id:'hwnotes',  label:'<i class="fas fa-pen-nib"></i> Manuscrit',       count: hw.length  },
    { id:'allnotes', label:'<i class="fas fa-layer-group"></i> Toutes',      count: all.length },
  ];
  if (fb) fb.innerHTML = tabs.map(t =>
    `<div class="filter-chip ${currentNoteTab===t.id?'active':''}" style="--c:var(--notes)" onclick="switchNoteTab('${t.id}')">
      ${t.label} <span style="opacity:.6;font-size:10px;margin-left:4px">${t.count}</span>
    </div>`).join('');

  const kl  = $('keynotes-list');
  const hwl = $('hwnotes-list');
  const al  = $('allnotes-list');
  if (kl)  kl.innerHTML  = key.length ? key.map(noteCard).join('') : '<div class="empty" style="grid-column:span 3"><i class="fas fa-keyboard"></i><p>Aucune note clavier</p></div>';
  if (hwl) hwl.innerHTML = hw.length  ? hw.map(noteCard).join('')  : '<div class="empty" style="grid-column:span 3"><i class="fas fa-pen-nib"></i><p>Aucune note manuscrite</p></div>';
  if (al)  al.innerHTML  = all.length ? all.map(noteCard).join('') : '<div class="empty" style="grid-column:span 3"><i class="fas fa-sticky-note"></i><p>Aucune note</p></div>';
}

function switchNoteTab(tab) {
  currentNoteTab = tab;
  document.querySelectorAll('.notes-panel').forEach(p => p.style.display = 'none');
  const panel = $('notes-' + tab + '-panel');
  if (panel) panel.style.display = 'block';
  renderNotes();
}

function noteCard(n) {
  return `<div class="note-card" onclick="viewNote('${n.id}')">
    ${n.photo?`<img src="${n.photo}" class="note-img-thumb" alt="">`:''}
    <div class="note-type"><i class="fas ${n.type==='hw'?'fa-pen-nib':'fa-keyboard'}"></i> ${n.type==='hw'?'Manuscrit':'Clavier'}</div>
    <div class="note-title">${n.title||'Sans titre'}</div>
    ${n.type==='key' ? `<div class="note-preview">${n.content||''}</div>` : `<div style="font-size:11px;color:var(--text3)">${n.strokes||0} traits</div>`}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
      <div class="note-date">${formatDate(n.date)}</div>
      <button class="btn btn-ghost btn-icon btn-sm" onclick="event.stopPropagation();deleteNote('${n.id}')"><i class="fas fa-trash"></i></button>
    </div>
  </div>`;
}

function deleteNote(id) {
  state.notes = (state.notes||[]).filter(n => n.id !== id);
  saveData(); renderNotes();
}

function viewNote(id) {
  const n = (state.notes||[]).find(n => n.id === id);
  if (n) openNoteModal(n.type, n);
}

function openNoteModal(type, note=null) {
  if (type === 'key') {
    showModal('note-modal', `
      <div class="modal-header">
        <div class="modal-title">${note?'Modifier la note':'Nouvelle note'}</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('note-modal')"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Titre</label>
          <input class="form-input" id="note-title" placeholder="Titre..." value="${note?.title||''}"></div>
        <div class="form-group"><label class="form-label">Contenu</label>
          <textarea class="form-textarea" id="note-content" style="min-height:200px" placeholder="Votre note...">${note?.content||''}</textarea></div>
        <div class="form-group"><label class="form-label">Photo</label>
          <button class="btn btn-ghost btn-sm" onclick="$('note-photo-input').click()"><i class="fas fa-image"></i> Ajouter une photo</button>
          <input type="file" id="note-photo-input" accept="image/*" style="display:none" onchange="previewPhoto(event,'note-photo-preview')">
          <img id="note-photo-preview" src="${note?.photo||''}" style="max-width:100%;max-height:150px;border-radius:8px;margin-top:8px;${note?.photo?'':'display:none'}">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('note-modal')">Annuler</button>
        <button class="btn btn-primary" onclick="saveNote('key','${note?.id||''}')">Enregistrer</button>
      </div>`);
  } else {
    showModal('note-modal', `
      <div class="modal-header">
        <div class="modal-title">Note manuscrite</div>
        <button class="btn btn-ghost btn-icon" onclick="closeModal('note-modal')"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Titre</label>
          <input class="form-input" id="note-hw-title" placeholder="Titre..." value="${note?.title||''}"></div>
        <div class="canvas-tools">
          <label class="form-label" style="margin-bottom:0">Couleur :</label>
          ${['#000000','#e05555','#3388ff','#30c88a','#f0a500','#9b59b6'].map(c=>`<div class="color-btn ${drawColor===c?'active':''}" style="background:${c}" onclick="setDrawColor('${c}',this)"></div>`).join('')}
          <label class="form-label" style="margin-bottom:0;margin-left:8px">Taille :</label>
          ${[2,4,8,14].map(s=>`<button class="size-btn ${drawSize===s?'active':''}" onclick="setDrawSize(${s},this)">${s}</button>`).join('')}
          <button class="btn btn-ghost btn-sm" onclick="clearCanvas()"><i class="fas fa-eraser"></i></button>
        </div>
        <canvas id="drawing-canvas" height="300" style="width:100%;background:#fff;border-radius:8px;cursor:crosshair;touch-action:none"></canvas>
        <div class="form-group" style="margin-top:12px">
          <label class="form-label">Photo</label>
          <button class="btn btn-ghost btn-sm" onclick="$('hw-photo-input').click()"><i class="fas fa-image"></i> Ajouter</button>
          <input type="file" id="hw-photo-input" accept="image/*" style="display:none" onchange="previewPhoto(event,'hw-photo-preview')">
          <img id="hw-photo-preview" src="${note?.photo||''}" style="max-width:100%;max-height:100px;border-radius:8px;margin-top:6px;${note?.photo?'':'display:none'}">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('note-modal')">Annuler</button>
        <button class="btn btn-primary" onclick="saveNote('hw','${note?.id||''}')">Enregistrer</button>
      </div>`, () => initCanvas(note));
  }
}

function previewPhoto(event, previewId) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = $(previewId);
    if (img) { img.src = e.target.result; img.style.display = 'block'; img.dataset.data = e.target.result; }
  };
  reader.readAsDataURL(file);
}

let drawStrokes = 0;
let _currentCanvasNoteId = null;
function initCanvas(note) {
  _currentCanvasNoteId = note?.id || null;
  const canvas = $('drawing-canvas');
  if (!canvas) return;
  canvas.width = canvas.offsetWidth || 400;
  drawingCtx = canvas.getContext('2d');
  drawingCtx.lineCap = 'round';
  drawingCtx.lineJoin = 'round';
  drawStrokes = note?.strokes || 0;
  if (note?.canvasData) {
    const img = new Image();
    img.onload = () => drawingCtx.drawImage(img, 0, 0);
    img.src = note.canvasData;
  }
  const getPos = e => {
    const r = canvas.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX - r.left) * (canvas.width/r.width), y: (src.clientY - r.top) * (canvas.height/r.height) };
  };
  let _canvasAutoSaveTimer = null;
  const start = e => { isDrawing=true; const p=getPos(e); drawingCtx.beginPath(); drawingCtx.moveTo(p.x,p.y); e.preventDefault(); };
  const draw = e => {
    if(!isDrawing)return;
    const p=getPos(e);
    drawingCtx.strokeStyle=drawColor; drawingCtx.lineWidth=drawSize;
    drawingCtx.lineTo(p.x,p.y); drawingCtx.stroke();
    drawStrokes++;
    e.preventDefault();
    // Auto-save after 1.5s of inactivity
    clearTimeout(_canvasAutoSaveTimer);
    _canvasAutoSaveTimer = setTimeout(() => {
      if (!_currentCanvasNoteId) return;
      const n = (state.notes||[]).find(n => n.id === _currentCanvasNoteId);
      if (!n) return;
      const cv = $('drawing-canvas');
      if (!cv) return;
      const tmp = document.createElement('canvas');
      tmp.width = cv.width; tmp.height = cv.height;
      const ctx2 = tmp.getContext('2d');
      ctx2.fillStyle = '#ffffff'; ctx2.fillRect(0,0,tmp.width,tmp.height);
      ctx2.drawImage(cv,0,0);
      n.canvasData = tmp.toDataURL('image/jpeg',0.85);
      n.strokes = drawStrokes;
      saveDataSilent();
    }, 1500);
  };
  const end = () => isDrawing = false;
  canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',draw);
  canvas.addEventListener('mouseup',end); canvas.addEventListener('mouseleave',end);
  canvas.addEventListener('touchstart',start,{passive:false}); canvas.addEventListener('touchmove',draw,{passive:false});
  canvas.addEventListener('touchend',end);
}

function setDrawColor(c, el) { drawColor=c; document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
function setDrawSize(s, el) { drawSize=s; document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
function clearCanvas() { const c=$('drawing-canvas'); if(c&&drawingCtx){drawingCtx.clearRect(0,0,c.width,c.height); drawStrokes=0;} }

function saveNote(type, existingId) {
  let data = {};
  if (type === 'key') {
    const photoEl = $('note-photo-preview');
    data = {
      type:'key',
      title: ($('note-title')?.value||'').trim() || 'Sans titre',
      content: $('note-content')?.value||'',
      photo: photoEl?.dataset.data || (photoEl?.src?.startsWith('data:') ? photoEl.src : '')
    };
  } else {
    const canvas = $('drawing-canvas');
    const photoEl = $('hw-photo-preview');
    // Compress canvas to JPEG at save time (much lighter than raw PNG)
    let canvasData = '';
    if (canvas) {
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width; tmp.height = canvas.height;
      const ctx = tmp.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, tmp.width, tmp.height);
      ctx.drawImage(canvas, 0, 0);
      canvasData = tmp.toDataURL('image/jpeg', 0.85);
    }
    data = {
      type:'hw',
      title: ($('note-hw-title')?.value||'').trim() || 'Note manuscrite',
      canvasData,
      strokes: drawStrokes,
      photo: photoEl?.dataset.data || (photoEl?.src?.startsWith('data:') ? photoEl.src : '')
    };
  }
  if (!state.notes) state.notes = [];
  if (existingId) {
    const n = state.notes.find(n => n.id === existingId);
    if (n) Object.assign(n, data, { date: Date.now() });
  } else {
    state.notes.push({ id:uid(), date:Date.now(), ...data });
  }
  saveData(); closeModal('note-modal'); renderNotes();
  toast('Note enregistrée');
}

// ===== INVEST =====
function renderInvest() {
  const inv = state.invest||[];
  const total = inv.reduce((s,i) => s+(parseFloat(i.valeurActuelle)||0), 0);
  const totalAchat = inv.reduce((s,i) => s+(parseFloat(i.valeurAchat)||0), 0);
  const pnl = total - totalAchat;
  const pnlPct = totalAchat > 0 ? (pnl/totalAchat*100).toFixed(1) : '0.0';

  // Summary cards with extra vertical padding
  const sum = $('invest-summary');
  if (sum) sum.innerHTML = `
    <div class="stat-card" style="--c:var(--invest);padding:24px 20px">
      <div class="stat-icon"><i class="fas fa-wallet"></i></div>
      <div class="stat-value">${formatMoney(total)}</div>
      <div class="stat-label">Valeur actuelle</div>
    </div>
    <div class="stat-card" style="--c:${pnl>=0?'var(--invest)':'var(--danger)'};padding:24px 20px">
      <div class="stat-icon"><i class="fas fa-arrow-trend-${pnl>=0?'up':'down'}"></i></div>
      <div class="stat-value">${pnl>=0?'+':''}${formatMoney(pnl)}</div>
      <div class="stat-label">Plus/moins-value (${pnlPct}%)</div>
    </div>
    <div class="stat-card" style="--c:var(--accent);padding:24px 20px">
      <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
      <div class="stat-value">${inv.length}</div>
      <div class="stat-label">Positions ouvertes</div>
    </div>`;

  // ---- Mini bar chart par position ----
  const chart = $('invest-chart');
  if (chart) {
    if (!inv.length) { chart.innerHTML = ''; }
    else {
      const maxVal = Math.max(...inv.map(i => parseFloat(i.valeurActuelle)||0), 1);
      const rows = inv.slice().sort((a,b) => (parseFloat(b.valeurActuelle)||0)-(parseFloat(a.valeurActuelle)||0))
        .map(i => {
          const v = parseFloat(i.valeurActuelle)||0;
          const a = parseFloat(i.valeurAchat)||0;
          const pnlPct2 = a ? (v-a)/a*100 : 0;
          const isPos = pnlPct2 >= 0;
          const pct = Math.round(v/maxVal*100);
          return `<div class="invest-chart-bar-row">
            <div class="invest-chart-bar-label" title="${i.nom}">${i.nom}</div>
            <div class="invest-chart-bar-track">
              <div class="invest-chart-bar-fill" style="width:${pct}%;background:${isPos?'var(--invest)':'var(--danger)'}"></div>
            </div>
            <div class="invest-chart-bar-val" style="color:${isPos?'var(--invest)':'var(--danger)'}">${isPos?'+':''}${pnlPct2.toFixed(1)}%</div>
          </div>`;
        }).join('');
      chart.innerHTML = `<div class="invest-chart-wrap">
        <div class="invest-chart-title"><i class="fas fa-chart-bar" style="margin-right:6px;color:var(--invest)"></i>Répartition & performance</div>
        ${rows}
      </div>`;
    }
  }

  // Filter bar — same style as Todo
  const fb = $('invest-filters');
  const cats = ['all', ...(state.cats.invest||[])];
  if (fb) fb.innerHTML = cats.map(c => {
    const count = c === 'all' ? inv.length : inv.filter(i => i.cat === c).length;
    return `<div class="filter-chip ${currentInvestTab===c?'active':''}" style="--c:var(--invest)" onclick="switchInvestCat('${c}')">
      ${c === 'all' ? 'Tout' : c} <span style="opacity:.6;font-size:10px;margin-left:4px">${count}</span>
    </div>`;
  }).join('');

  let items = inv;
  if (currentInvestTab !== 'all') items = items.filter(i => i.cat === currentInvestTab);

  const list = $('invest-list');
  if (!list) return;

  if (!items.length) {
    list.innerHTML = '<div class="empty"><i class="fas fa-chart-bar"></i><p>Aucun investissement dans cette catégorie</p></div>';
    return;
  }

  const icons = {Actions:'📈',Banque:'🏦',Crypto:'₿',Immobilier:'🏠',Obligations:'📋',ETF:'📊'};

  // Group by category when showing all
  const grouped = {};
  items.forEach(i => {
    const key = currentInvestTab === 'all' ? i.cat : '—';
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(i);
  });

  list.innerHTML = Object.entries(grouped).map(([cat, catItems]) => {
    const catTotal = catItems.reduce((s,i) => s+(parseFloat(i.valeurActuelle)||0), 0);
    const header = currentInvestTab === 'all' ? `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px 6px;margin-top:8px">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px">${cat}</div>
        <div style="font-size:12px;font-weight:600;color:var(--text2)">${formatMoney(catTotal)}</div>
      </div>` : '';

    const rows = catItems.map(i => {
      const pnl2 = ((i.valeurActuelle-i.valeurAchat)/(i.valeurAchat||1)*100).toFixed(1);
      const isPos = parseFloat(pnl2) >= 0;
      // PnL bar: 50% = 0%, capped at 100%
      const barPct = Math.min(100, Math.max(0, 50 + parseFloat(pnl2) * 2));
      const barColor = isPos ? 'var(--invest)' : 'var(--danger)';

      return `<div class="invest-item">
        <div class="invest-icon">${icons[i.cat]||'💰'}</div>
        <div style="flex:1;min-width:0">
          <div class="invest-name">${i.nom}</div>
          <div class="invest-cat">${i.cat}${i.ticker?' · '+i.ticker:''}</div>
          <div class="invest-pnl-bar" style="margin-top:10px">
            <div class="invest-pnl-fill" style="width:${barPct}%;background:${barColor}"></div>
          </div>
          ${i.objectifPct ? `<div class="invest-objectif-bar">
            <div class="invest-objectif-fill" style="width:${Math.min(100,Math.max(0,(parseFloat(pnl2)/i.objectifPct*100)))}%"></div>
            <div class="invest-objectif-target" style="left:100%"></div>
          </div>
          <div style="font-size:9px;color:var(--text3);margin-top:2px">Objectif: ${i.objectifPct}% — ${parseFloat(pnl2)>=i.objectifPct?'✅ Atteint':Math.round(parseFloat(pnl2)/i.objectifPct*100)+'%'}</div>` : ''}
          ${renderSparkline(i.history)}
        </div>
        <div style="text-align:right;padding-left:8px">
          <div class="invest-amount">${formatMoney(i.valeurActuelle)}</div>
          <div class="invest-change ${isPos?'pos':'neg'}">${isPos?'+':''}${pnl2}%</div>
          <div style="font-size:10px;color:var(--text3);margin-top:3px">achat ${formatMoney(i.valeurAchat)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;margin-left:8px">
          <button class="btn btn-ghost btn-icon btn-sm" onclick="editInvest('${i.id}')"><i class="fas fa-pen"></i></button>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="openInvestHistory('${i.id}')"><i class="fas fa-history"></i></button>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteInvest('${i.id}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>`;
    }).join('');

    return header + rows;
  }).join('');
}

function switchInvestCat(cat) {
  currentInvestTab = cat;
  renderInvest();
}

function deleteInvest(id) { state.invest=(state.invest||[]).filter(i=>i.id!==id); saveData(); renderInvest(); }
function editInvest(id) { const i=(state.invest||[]).find(i=>i.id===id); if(i) openInvestModal(i); }

function openInvestModal(invest=null) {
  const catOpts = (state.cats.invest||[]).map(c => `<option value="${c}" ${invest?.cat===c?'selected':''}>${c}</option>`).join('');
  showModal('invest-modal', `
    <div class="modal-header">
      <div class="modal-title">${invest?'Modifier':'Nouvelle position'}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('invest-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nom *</label>
          <input class="form-input" id="inv-nom" placeholder="Apple, Bitcoin..." value="${invest?.nom||''}"></div>
        <div class="form-group"><label class="form-label">Ticker</label>
          <input class="form-input" id="inv-ticker" placeholder="AAPL, BTC..." value="${invest?.ticker||''}"></div>
      </div>
      <div class="form-group"><label class="form-label">Catégorie</label>
        <select class="form-select" id="inv-cat">${catOpts}</select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Valeur d'achat (€) *</label>
          <input class="form-input" type="number" id="inv-achat" placeholder="0" value="${invest?.valeurAchat||''}"></div>
        <div class="form-group"><label class="form-label">Valeur actuelle (€) *</label>
          <input class="form-input" type="number" id="inv-actuel" placeholder="0" value="${invest?.valeurActuelle||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date d'achat</label>
          <input class="form-input" type="date" id="inv-date" value="${invest?.dateAchat||''}"></div>
        <div class="form-group"><label class="form-label">Quantité</label>
          <input class="form-input" type="number" id="inv-qty" step="any" value="${invest?.quantite||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Objectif rendement (%)</label>
          <input class="form-input" type="number" id="inv-objectif" step="any" placeholder="ex: 20" value="${invest?.objectifPct||''}"></div>
        <div class="form-group"><label class="form-label">Valeur objectif (€)</label>
          <input class="form-input" type="number" id="inv-objectif-val" placeholder="ex: 5000" value="${invest?.objectifVal||''}"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label>
        <textarea class="form-textarea" id="inv-notes">${invest?.notes||''}</textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('invest-modal')">Annuler</button>
      ${invest ? `<button class="btn btn-ghost btn-sm" onclick="closeModal('invest-modal');openInvestHistory('${invest.id}')"><i class="fas fa-history"></i> Historique</button>` : ''}
      <button class="btn btn-primary" onclick="saveInvest('${invest?.id||''}')">Enregistrer</button>
    </div>`);
}

function saveInvest(existingId) {
  const nom = ($('inv-nom')?.value||'').trim();
  if (!nom) { toast('Nom requis','fas fa-warning'); return; }
  const newActuel = parseFloat($('inv-actuel')?.value)||0;
  const data = {
    nom, ticker: $('inv-ticker')?.value||'',
    cat: $('inv-cat')?.value||'',
    valeurAchat: parseFloat($('inv-achat')?.value)||0,
    valeurActuelle: newActuel,
    dateAchat: $('inv-date')?.value||'',
    quantite: $('inv-qty')?.value||'',
    objectifPct: parseFloat($('inv-objectif')?.value)||0,
    objectifVal: parseFloat($('inv-objectif-val')?.value)||0,
    notes: $('inv-notes')?.value||''
  };
  if (!state.invest) state.invest = [];
  if (existingId) {
    const i = state.invest.find(i=>i.id===existingId);
    if (i) {
      // Add history snapshot if value changed
      if (i.valeurActuelle !== newActuel) {
        if (!i.history) i.history = [];
        i.history.push({ date: new Date().toISOString().slice(0,10), value: newActuel });
        if (i.history.length > 30) i.history = i.history.slice(-30); // keep last 30
      }
      Object.assign(i, data);
    }
  } else {
    state.invest.push({ id:uid(), history:[{date:new Date().toISOString().slice(0,10),value:newActuel}], ...data });
  }
  saveData(); closeModal('invest-modal'); renderInvest();
  toast(existingId ? 'Position modifiée' : 'Position ajoutée');
}

// ===== CULTURE =====
const cultureEmojis = {Films:'🎬','Séries TV':'📺',Expo:'🎨',Livres:'📚',Musique:'🎵',Podcasts:'🎙️'};

function renderCulture() {
  const cats = ['all', ...(state.cats.culture||[])];
  const fb = $('culture-filters');
  if (fb) fb.innerHTML = cats.map(c =>
    `<div class="filter-chip ${currentCultureFilter===c?'active':''}" style="--c:var(--culture)" onclick="filterCulture('${c}')">${c==='all'?'Tout':c}</div>`).join('') +
    `<div class="filter-spacer"></div>
     <select class="form-select" style="width:auto;padding:6px 12px" onchange="filterCultureStatus(this.value)">
       <option value="all">Tous statuts</option><option value="done">✅ Vu/Lu</option><option value="progress">🔄 En cours</option><option value="todo">📌 À voir</option>
     </select>`;

  let items = state.culture||[];
  if (currentCultureFilter !== 'all') items = items.filter(c => c.cat === currentCultureFilter);
  renderCultureItems(items);
}

function renderCultureItems(items) {
  const grid = $('culture-grid');
  if (!grid) return;
  grid.innerHTML = items.length ? items.map(c => {
    const stars = '★'.repeat(c.note||0)+'☆'.repeat(5-(c.note||0));
    const sc = {done:'status-done',progress:'status-progress',todo:'status-todo'}[c.statut]||'status-todo';
    const sl = {done:'Vu/Lu',progress:'En cours',todo:'À voir'}[c.statut]||'À voir';
    return `<div class="culture-card" data-id="${c.id}" onclick="editCulture('${c.id}')">
      <div class="culture-poster">
        ${c.image?`<img src="${c.image}" alt="">`:(cultureEmojis[c.cat]||'🎯')}
        <div class="status-badge ${sc}">${sl}</div>
      </div>
      <div class="culture-body">
        <div class="culture-title">${c.titre}</div>
        <div class="culture-sub">${c.cat}${c.annee?' · '+c.annee:''}</div>
        <div class="stars">${c.note?stars:''}</div>
        <div style="display:flex;justify-content:flex-end;margin-top:8px">
          <button class="btn btn-ghost btn-icon btn-sm" onclick="event.stopPropagation();deleteCulture('${c.id}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    </div>`;
  }).join('') : '<div class="empty" style="grid-column:span 3"><i class="fas fa-film"></i><p>Aucune œuvre !</p></div>';
}

function filterCulture(cat) { currentCultureFilter = cat; renderCulture(); }
function filterCultureStatus(status) {
  let items = state.culture||[];
  if (status !== 'all') items = items.filter(c => c.statut === status);
  renderCultureItems(items);
}

function deleteCulture(id) { state.culture=(state.culture||[]).filter(c=>c.id!==id); saveData(); renderCulture(); }
function editCulture(id) { const c=(state.culture||[]).find(c=>c.id===id); if(c) openCultureModal(c); }

function openCultureModal(item=null) {
  const catOpts = (state.cats.culture||[]).map(c => `<option value="${c}" ${item?.cat===c?'selected':''}>${c}</option>`).join('');
  window._cultureNote = item?.note||0;
  showModal('culture-modal', `
    <div class="modal-header">
      <div class="modal-title">${item?'Modifier':'Ajouter une œuvre'}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('culture-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Titre *</label>
        <input class="form-input" id="cult-titre" value="${item?.titre||''}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Catégorie</label>
          <select class="form-select" id="cult-cat">${catOpts}</select></div>
        <div class="form-group"><label class="form-label">Année</label>
          <input class="form-input" type="number" id="cult-annee" value="${item?.annee||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Auteur/Réalisateur</label>
          <input class="form-input" id="cult-auteur" value="${item?.auteur||''}"></div>
        <div class="form-group"><label class="form-label">Statut</label>
          <select class="form-select" id="cult-statut">
            <option value="todo" ${item?.statut==='todo'||!item?'selected':''}>📌 À voir/lire</option>
            <option value="progress" ${item?.statut==='progress'?'selected':''}>🔄 En cours</option>
            <option value="done" ${item?.statut==='done'?'selected':''}>✅ Vu/Lu</option>
          </select></div>
      </div>
      <div class="form-group"><label class="form-label">Note</label>
        <div style="display:flex;gap:8px">
          ${[1,2,3,4,5].map(n=>`<button class="btn btn-ghost btn-sm" id="star-${n}" onclick="setStars(${n})" style="${(item?.note||0)>=n?'background:var(--accent);color:#000;border-color:var(--accent)':''}">★</button>`).join('')}
        </div></div>
      <div class="form-group"><label class="form-label">Critique</label>
        <textarea class="form-textarea" id="cult-critique">${item?.critique||''}</textarea></div>
      <div class="form-group"><label class="form-label">Image</label>
        <button class="btn btn-ghost btn-sm" onclick="$('cult-img-input').click()"><i class="fas fa-image"></i> Ajouter</button>
        <input type="file" id="cult-img-input" accept="image/*" style="display:none" onchange="previewPhoto(event,'cult-img-preview')">
        <img id="cult-img-preview" src="${item?.image||''}" style="max-width:100%;max-height:100px;border-radius:8px;margin-top:6px;${item?.image?'':'display:none'}">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('culture-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveCulture('${item?.id||''}')">Enregistrer</button>
    </div>`);
}

function setStars(n) {
  window._cultureNote = n;
  for (let i=1;i<=5;i++) {
    const btn = $('star-'+i);
    if (btn) { btn.style.background=i<=n?'var(--accent)':''; btn.style.color=i<=n?'#000':''; btn.style.borderColor=i<=n?'var(--accent)':''; }
  }
}

function saveCulture(existingId) {
  const titre = ($('cult-titre')?.value||'').trim();
  if (!titre) { toast('Titre requis','fas fa-warning'); return; }
  const imgEl = $('cult-img-preview');
  const data = {
    titre, cat: $('cult-cat')?.value||'',
    annee: $('cult-annee')?.value||'',
    auteur: $('cult-auteur')?.value||'',
    statut: $('cult-statut')?.value||'todo',
    note: window._cultureNote||0,
    critique: $('cult-critique')?.value||'',
    image: imgEl?.dataset.data||(imgEl?.src?.startsWith('data:')?imgEl.src:'')
  };
  if (!state.culture) state.culture = [];
  if (existingId) { const c=state.culture.find(c=>c.id===existingId); if(c) Object.assign(c,data); }
  else state.culture.push({ id:uid(), date:Date.now(), ...data });
  saveData(); closeModal('culture-modal'); renderCulture();
  toast(existingId ? 'Œuvre modifiée' : 'Œuvre ajoutée');
}

// ===== VOYAGE =====
function renderVoyage() {
  let items = state.voyage||[];
  if (currentVoyageTab !== 'all') items = items.filter(v => v.type === currentVoyageTab);
  const list = $('voyage-list');
  if (!list) return;
  list.innerHTML = items.length ? items.map(v => {
    const nb = v.itinerary?.length || 0;
    const itinLabel = nb ? `${nb} jour${nb>1?'s':''}` : 'Planifier';
    return `
    <div class="trip-card">
      <div class="trip-header">
        <div class="trip-flag">${v.emoji||'🌍'}</div>
        <div>
          <div class="trip-dest">${v.destination}</div>
          <div class="trip-dates">${formatDate(v.dateDepart)}${v.dateRetour?' → '+formatDate(v.dateRetour):''}</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:4px">
          <button class="btn btn-ghost btn-icon btn-sm" onclick="editVoyage('${v.id}')"><i class="fas fa-pen"></i></button>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteVoyage('${v.id}')"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div class="trip-stats">
        ${v.budget?`<div class="trip-stat">Budget: <span>${formatMoney(v.budget)}</span></div>`:''}
        ${v.compagnons?`<div class="trip-stat">Avec: <span>${v.compagnons}</span></div>`:''}
        ${v.hebergement?`<div class="trip-stat">Hébergement: <span>${v.hebergement}</span></div>`:''}
      </div>
      ${v.notes?`<div style="margin-top:10px;font-size:12px;color:var(--text2)">${v.notes}</div>`:''}
      ${v.tags?`<div class="trip-tags">${v.tags.split(',').map(t=>`<span class="tag"><span class="tag-dot" style="background:var(--voyage)"></span>${t.trim()}</span>`).join('')}</div>`:''}
      <div class="itin-wrap">
        <div class="itin-toggle" data-itin-id="${v.id}" onclick="toggleItinerary('${v.id}')">
          <i class="fas fa-route"></i>
          <span>Itinéraire</span>
          <span data-itin-count="${v.id}" style="font-size:10px;color:var(--text3);font-weight:400;margin-left:2px">${itinLabel}</span>
          <i class="fas fa-chevron-right itin-chev"></i>
        </div>
        <div class="itin-body" data-itin-body="${v.id}"></div>
      </div>
    </div>`;
  }).join('') : '<div class="empty"><i class="fas fa-plane"></i><p>Aucun voyage !</p></div>';
}

function deleteVoyage(id) { state.voyage=(state.voyage||[]).filter(v=>v.id!==id); saveData(); renderVoyage(); }
function editVoyage(id) { const v=(state.voyage||[]).find(v=>v.id===id); if(v) openVoyageModal(v); }

function openVoyageModal(voyage=null) {
  showModal('voyage-modal', `
    <div class="modal-header">
      <div class="modal-title">${voyage?'Modifier le voyage':'Nouveau voyage'}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('voyage-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group" style="flex:0 0 80px"><label class="form-label">Emoji</label>
          <input class="form-input" id="voy-emoji" placeholder="🌍" value="${voyage?.emoji||''}"></div>
        <div class="form-group"><label class="form-label">Destination *</label>
          <input class="form-input" id="voy-dest" placeholder="Paris, Tokyo..." value="${voyage?.destination||''}"></div>
      </div>
      <div class="form-group"><label class="form-label">Statut</label>
        <select class="form-select" id="voy-type">
          <option value="prochain" ${voyage?.type==='prochain'||!voyage?'selected':''}>🗺 À venir</option>
          <option value="passe" ${voyage?.type==='passe'?'selected':''}>✅ Passé</option>
          <option value="idees" ${voyage?.type==='idees'?'selected':''}>💡 Idée</option>
        </select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Départ</label>
          <input class="form-input" type="date" id="voy-dep" value="${voyage?.dateDepart||''}"></div>
        <div class="form-group"><label class="form-label">Retour</label>
          <input class="form-input" type="date" id="voy-ret" value="${voyage?.dateRetour||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Budget (€)</label>
          <input class="form-input" type="number" id="voy-budget" value="${voyage?.budget||''}"></div>
        <div class="form-group"><label class="form-label">Compagnons</label>
          <input class="form-input" id="voy-comp" value="${voyage?.compagnons||''}"></div>
      </div>
      <div class="form-group"><label class="form-label">Hébergement</label>
        <input class="form-input" id="voy-heberg" value="${voyage?.hebergement||''}"></div>
      <div class="form-group"><label class="form-label">Tags (virgule)</label>
        <input class="form-input" id="voy-tags" value="${voyage?.tags||''}"></div>
      <div class="form-group"><label class="form-label">Notes</label>
        <textarea class="form-textarea" id="voy-notes">${voyage?.notes||''}</textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('voyage-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveVoyage('${voyage?.id||''}')">Enregistrer</button>
    </div>`);
}

function saveVoyage(existingId) {
  const dest = ($('voy-dest')?.value||'').trim();
  if (!dest) { toast('Destination requise','fas fa-warning'); return; }
  const data = {
    destination: dest, emoji: $('voy-emoji')?.value||'🌍',
    type: $('voy-type')?.value||'prochain',
    dateDepart: $('voy-dep')?.value||'',
    dateRetour: $('voy-ret')?.value||'',
    budget: $('voy-budget')?.value||'',
    compagnons: $('voy-comp')?.value||'',
    hebergement: $('voy-heberg')?.value||'',
    tags: $('voy-tags')?.value||'',
    notes: $('voy-notes')?.value||''
  };
  if (!state.voyage) state.voyage = [];
  if (existingId) { const v=state.voyage.find(v=>v.id===existingId); if(v) Object.assign(v,data); }
  else state.voyage.push({ id:uid(), date:Date.now(), itinerary:[], ...data });
  saveData(); closeModal('voyage-modal'); renderVoyage();
  toast(existingId ? 'Voyage modifié' : 'Voyage ajouté');
}

// ===== ITINERARY =====
const ACT_TYPES = ['Transport','Visite','Repas','Hébergement','Nature','Activité','Shopping','Soirée','Autre'];
const ACT_EMOJI = {Transport:'🚌',Visite:'🏛️',Repas:'🍽️',Hébergement:'🏨',Nature:'🌿',Activité:'⚽',Shopping:'🛍️',Soirée:'🌙',Autre:'📌'};

function toggleItinerary(vid) {
  const toggle = document.querySelector(`[data-itin-id="${vid}"]`);
  const body   = document.querySelector(`[data-itin-body="${vid}"]`);
  if (!toggle || !body) return;
  const opening = !body.classList.contains('open');
  body.classList.toggle('open', opening);
  toggle.classList.toggle('open', opening);
  if (opening) refreshItinBody(vid);
}

function refreshItinBody(vid) {
  const body = document.querySelector(`[data-itin-body="${vid}"]`);
  if (!body) return;
  const v = (state.voyage||[]).find(v => v.id === vid);
  if (!v) return;
  v.itinerary = v.itinerary || [];

  if (!v.itinerary.length) {
    body.innerHTML = `<button class="itin-add-day-btn" onclick="addItinDay('${vid}')">
      <i class="fas fa-plus"></i> Ajouter le premier jour
    </button>`;
    return;
  }

  body.innerHTML = v.itinerary.map((day, di) => {
    let dayDateStr = '';
    if (v.dateDepart) {
      const d = new Date(v.dateDepart); d.setDate(d.getDate() + di);
      dayDateStr = d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric', month:'short'});
    }
    const actsHtml = (day.activities||[]).map((a, ai) => `
      <div class="itin-act">
        <div class="itin-act-time">${a.time||'—'}</div>
        <div class="itin-act-body">
          <div class="itin-act-desc">${a.desc}</div>
          ${a.lieu ? `<div class="itin-act-loc"><i class="fas fa-location-dot"></i> ${a.lieu}</div>` : ''}
          ${a.notes ? `<div class="itin-act-loc" style="color:var(--text2)">${a.notes}</div>` : ''}
        </div>
        <span class="itin-type-badge">${ACT_EMOJI[a.type]||'📌'} ${a.type||'Autre'}</span>
        <button class="btn btn-ghost btn-icon btn-sm" style="width:26px;height:26px;padding:0;flex-shrink:0"
          onclick="deleteItinAct('${vid}',${di},${ai})"><i class="fas fa-xmark"></i></button>
      </div>`).join('');

    return `<div class="itin-day">
      <div class="itin-day-header">
        <div class="itin-day-num">${di+1}</div>
        <div class="itin-day-title">${day.title||'Jour '+(di+1)}</div>
        <div class="itin-day-date">${dayDateStr}</div>
        <button class="btn btn-ghost btn-icon btn-sm" style="width:24px;height:24px;padding:0;margin-left:4px"
          onclick="deleteItinDay('${vid}',${di})" title="Supprimer ce jour"><i class="fas fa-xmark"></i></button>
      </div>
      ${actsHtml}
      <button class="itin-add-act-btn" onclick="openAddItinAct('${vid}',${di})">
        <i class="fas fa-plus"></i> Ajouter une activité
      </button>
    </div>`;
  }).join('') + `
    <button class="itin-add-day-btn" onclick="addItinDay('${vid}')">
      <i class="fas fa-plus"></i> Ajouter un jour
    </button>`;
}

function updateItinCount(vid) {
  const v = (state.voyage||[]).find(v => v.id === vid);
  const nb = v?.itinerary?.length || 0;
  const el = document.querySelector(`[data-itin-count="${vid}"]`);
  if (el) el.textContent = nb ? `${nb} jour${nb>1?'s':''}` : 'Planifier';
}

function addItinDay(vid) {
  const v = (state.voyage||[]).find(v => v.id === vid);
  if (!v) return;
  v.itinerary = v.itinerary || [];
  v.itinerary.push({ id:uid(), title:'Jour '+(v.itinerary.length+1), activities:[] });
  saveData();
  // Ouvrir si pas encore ouvert
  const body = document.querySelector(`[data-itin-body="${vid}"]`);
  if (body && !body.classList.contains('open')) {
    document.querySelector(`[data-itin-id="${vid}"]`)?.classList.add('open');
    body.classList.add('open');
  }
  refreshItinBody(vid);
  updateItinCount(vid);
  toast('Jour ajouté');
}

function deleteItinDay(vid, di) {
  const v = (state.voyage||[]).find(v => v.id === vid);
  if (!v?.itinerary) return;
  if (!confirm(`Supprimer le jour ${di+1} et ses activités ?`)) return;
  v.itinerary.splice(di, 1);
  saveData(); refreshItinBody(vid); updateItinCount(vid);
}

function openAddItinAct(vid, di) {
  const typeOptions = ACT_TYPES.map(t =>
    `<option value="${t}">${ACT_EMOJI[t]} ${t}</option>`).join('');
  showModal('itin-act-modal', `
    <div class="modal-header">
      <div class="modal-title" style="color:var(--voyage)"><i class="fas fa-map-pin"></i> Nouvelle activité</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('itin-act-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Description *</label>
        <input class="form-input" id="ia-desc" placeholder="Ex : Visite du musée du Louvre…"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Heure</label>
          <input class="form-input" type="time" id="ia-time"></div>
        <div class="form-group"><label class="form-label">Type</label>
          <select class="form-select" id="ia-type">${typeOptions}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Lieu</label>
        <input class="form-input" id="ia-lieu" placeholder="Adresse ou nom du lieu"></div>
      <div class="form-group"><label class="form-label">Notes</label>
        <textarea class="form-textarea" rows="2" id="ia-notes"
          placeholder="Prix, réservation, horaires…"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('itin-act-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveItinAct('${vid}',${di})"
        style="background:var(--voyage);color:#000"><i class="fas fa-plus"></i> Ajouter</button>
    </div>`);
}

function saveItinAct(vid, di) {
  const desc = ($('ia-desc')?.value||'').trim();
  if (!desc) { toast('Description requise', 'fas fa-warning'); return; }
  const v = (state.voyage||[]).find(v => v.id === vid);
  if (!v?.itinerary?.[di]) return;
  const act = {
    id: uid(),
    desc,
    time:  $('ia-time')?.value || '',
    type:  $('ia-type')?.value || 'Autre',
    lieu:  $('ia-lieu')?.value || '',
    notes: $('ia-notes')?.value || ''
  };
  v.itinerary[di].activities = v.itinerary[di].activities || [];
  v.itinerary[di].activities.push(act);
  // Trier par heure
  v.itinerary[di].activities.sort((a,b) => (a.time||'99:99').localeCompare(b.time||'99:99'));
  saveData(); closeModal('itin-act-modal'); refreshItinBody(vid);
  toast('Activité ajoutée 📍');
}

function deleteItinAct(vid, di, ai) {
  const v = (state.voyage||[]).find(v => v.id === vid);
  if (!v?.itinerary?.[di]) return;
  v.itinerary[di].activities.splice(ai, 1);
  saveData(); refreshItinBody(vid);
}

// ===== SETTINGS =====
function renderSettings() {
  renderCatList('todo');
  renderCatList('invest');
  renderCatList('culture');
  restoreCloudUI();
  const sel = $('notif-freq');
  if (sel) sel.value = state.notifFreq || 60;
  updateNotifBadge();
  // Theme
  renderThemePresets();
  updateColorInputs();
}

function renderCatList(type) {
  const el = $(type+'-cats-list');
  if (!el) return;
  el.innerHTML = (state.cats[type]||[]).map((c,i) => `
    <div class="cat-item">
      <div class="cat-dot" style="width:10px;height:10px;border-radius:50%;background:var(--${type==='todo'?'todo':type==='invest'?'invest':'culture'})"></div>
      <div class="cat-name">${c}</div>
      <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteCat('${type}',${i})"><i class="fas fa-xmark"></i></button>
    </div>`).join('');
}

function addCat(type) {
  const input = $('new-'+type+'-cat');
  const val = (input?.value||'').trim();
  if (!val) return;
  if (!state.cats[type]) state.cats[type] = [];
  if (state.cats[type].includes(val)) { toast('Catégorie déjà existante'); return; }
  state.cats[type].push(val);
  if (input) input.value = '';
  saveData(); renderCatList(type);
  toast('Catégorie ajoutée');
}

function deleteCat(type, idx) {
  if (state.cats[type]) state.cats[type].splice(idx, 1);
  saveData(); renderCatList(type);
}

// ===== MODAL =====
function showModal(id, content, afterRender) {
  closeModal(id);
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'overlay-' + id;
  overlay.innerHTML = `<div class="modal">${content}</div>`;
  overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(id); });
  const container = $('modals-container');
  if (container) container.appendChild(overlay);
  requestAnimationFrame(() => overlay.classList.add('open'));
  if (afterRender) setTimeout(afterRender, 60);
}

function closeModal(id) {
  const overlay = $('overlay-' + id);
  if (overlay) { overlay.classList.remove('open'); setTimeout(() => overlay.remove(), 250); }
}

// ===== TOAST =====
function toast(msg, icon='fas fa-circle-check') {
  const t = $('toast');
  if (!t) return;
  const i = t.querySelector('i');
  const s = $('toast-msg');
  if (i) i.className = icon;
  if (s) s.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ===== DEADLINE NOTIFICATIONS =====
let _deadlineTimer = null;
let _bannerTimer   = null;
// Throttle: don't re-notify same task within 1 hour
const _notified = {};

function initDeadlineNotif() {
  updateNotifBadge();
  const freq = state.notifFreq || 60;
  const sel = $('notif-freq');
  if (sel) sel.value = freq;
  if (Notification.permission === 'granted' && freq > 0) startDeadlineTimer(freq);
  // Also check on visibility change (user returns to app)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) checkDeadlines(false);
  });
}

function saveNotifConfig() {
  const sel = $('notif-freq');
  state.notifFreq = sel ? parseInt(sel.value) : 60;
  saveDataSilent();
  restartDeadlineTimer();
  toast('Réglage enregistré');
}

function restartDeadlineTimer() {
  clearInterval(_deadlineTimer);
  const freq = state.notifFreq || 60;
  updateNotifBadge();
  if (Notification.permission === 'granted' && freq > 0) startDeadlineTimer(freq);
}

function startDeadlineTimer(freqMin) {
  checkDeadlines(false); // immediate check on start
  _deadlineTimer = setInterval(() => checkDeadlines(false), freqMin * 60 * 1000);
}

async function requestNotifPerm() {
  if (!('Notification' in window)) {
    toast('Notifications non supportées sur ce navigateur', 'fas fa-xmark');
    return;
  }
  const result = await Notification.requestPermission();
  updateNotifBadge();
  if (result === 'granted') {
    toast('Notifications activées ✓');
    restartDeadlineTimer();
    checkDeadlines(true); // immediate check
  } else {
    toast('Permission refusée — les alertes s\'afficheront dans l\'app', 'fas fa-info');
  }
}

function updateNotifBadge() {
  const badge = $('notif-perm-badge');
  if (!badge) return;
  const p = ('Notification' in window) ? Notification.permission : 'denied';
  badge.className = 'badge-notif ' + p;
  badge.textContent = p === 'granted' ? '✓ Autorisé' : p === 'denied' ? '✗ Refusé' : '⚠ En attente';
}

function checkDeadlines(force = false) {
  const todos = (state.todo || []).filter(t => !t.done && t.dueDate);
  if (!todos.length) return;

  const now   = Date.now();
  const today = new Date(); today.setHours(0,0,0,0);
  const tom   = new Date(today); tom.setDate(tom.getDate() + 1);
  const in3   = new Date(today); in3.setDate(in3.getDate() + 3);

  const overdue  = [];
  const dueToday = [];
  const dueSoon  = [];

  todos.forEach(t => {
    const d = new Date(t.dueDate); d.setHours(0,0,0,0);
    if (d < today)                    overdue.push(t);
    else if (d.getTime() === today.getTime()) dueToday.push(t);
    else if (d < in3)                 dueSoon.push(t);
  });

  // Build notification groups
  const groups = [];
  if (overdue.length)  groups.push({ icon:'🚨', title:`${overdue.length} tâche${overdue.length>1?'s':''} en retard`, tasks: overdue,  urgent: true });
  if (dueToday.length) groups.push({ icon:'⏰', title:`${dueToday.length} tâche${dueToday.length>1?'s':''} à faire aujourd\'hui`, tasks: dueToday, urgent: false });
  if (dueSoon.length && !overdue.length && !dueToday.length)
    groups.push({ icon:'📅', title:`${dueSoon.length} tâche${dueSoon.length>1?'s':''} dans les 3 prochains jours`, tasks: dueSoon, urgent: false });

  groups.forEach(g => {
    const key = g.tasks.map(t => t.id).sort().join(',');
    const throttle = 60 * 60 * 1000; // 1h
    if (!force && _notified[key] && (now - _notified[key]) < throttle) return;
    _notified[key] = now;

    const msg = g.tasks.slice(0,3).map(t => `• ${t.text}`).join('\n')
              + (g.tasks.length > 3 ? `\n+ ${g.tasks.length - 3} autre(s)` : '');

    sendDeadlineNotif(g.icon, g.title, msg, g.urgent);
  });
}

function sendDeadlineNotif(icon, title, msg, urgent) {
  // Try native notification first
  if (Notification.permission === 'granted') {
    try {
      new Notification(title, {
        body: msg,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">' + icon + '</text></svg>',
        tag: 'jdk-deadline',
        requireInteraction: urgent
      });
      return; // native sent, no need for banner
    } catch(e) { /* fallback to banner */ }
  }
  // In-app banner fallback
  showDeadlineBanner(icon, title, msg, urgent);
}

function showDeadlineBanner(icon, title, msg, urgent) {
  const banner = $('deadline-banner');
  if (!banner) return;
  $('deadline-banner-icon').textContent  = icon;
  $('deadline-banner-title').textContent = title;
  $('deadline-banner-msg').textContent   = msg;
  banner.className = 'deadline-banner' + (urgent ? ' urgent' : '');
  // Trigger show
  requestAnimationFrame(() => banner.classList.add('show'));
  clearTimeout(_bannerTimer);
  _bannerTimer = setTimeout(closeDeadlineBanner, urgent ? 10000 : 6000);
}

function closeDeadlineBanner() {
  const b = $('deadline-banner');
  if (b) b.classList.remove('show');
}

// ===== THEME ENGINE =====
const THEME_DEFAULTS = {
  accent:'#f0a500', accent2:'#e8c860',
  todo:'#7c6ff7', notes:'#f07050', invest:'#30c88a',
  culture:'#e05580', voyage:'#38b8d8',
  bg:'#0d0f14', bg2:'#13161e', bg3:'#1a1e2a',
  surface:'#1e2230', surface2:'#252a3a', border:'#2e3347',
  radius: 14
};

const THEME_PRESETS = [
  {
    name:'Défaut', id:'default',
    colors:{ accent:'#f0a500', todo:'#7c6ff7', notes:'#f07050', invest:'#30c88a', culture:'#e05580', voyage:'#38b8d8', bg:'#0d0f14' }
  },
  {
    name:'Océan', id:'ocean',
    colors:{ accent:'#00b4d8', todo:'#48cae4', notes:'#90e0ef', invest:'#0077b6', culture:'#023e8a', voyage:'#ade8f4', bg:'#03045e' }
  },
  {
    name:'Forêt', id:'forest',
    colors:{ accent:'#95d5b2', todo:'#52b788', notes:'#d8f3dc', invest:'#1b4332', culture:'#40916c', voyage:'#74c69d', bg:'#081c15' }
  },
  {
    name:'Crépuscule', id:'dusk',
    colors:{ accent:'#f72585', todo:'#7209b7', notes:'#f72585', invest:'#4cc9f0', culture:'#4361ee', voyage:'#3a0ca3', bg:'#10002b' }
  },
  {
    name:'Sable', id:'sand',
    colors:{ accent:'#e9c46a', todo:'#f4a261', notes:'#e76f51', invest:'#2a9d8f', culture:'#264653', voyage:'#a8dadc', bg:'#1a1208' }
  },
  {
    name:'Clair', id:'light',
    colors:{ accent:'#e63946', todo:'#457b9d', notes:'#e63946', invest:'#2d6a4f', culture:'#e63946', voyage:'#1d3557', bg:'#f1faee' }
  },
];

function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return {r,g,b};
}

function lighten(hex, pct) {
  try {
    const {r,g,b} = hexToRgb(hex);
    const f = pct/100;
    const nr = Math.min(255,Math.round(r + (255-r)*f));
    const ng = Math.min(255,Math.round(g + (255-g)*f));
    const nb = Math.min(255,Math.round(b + (255-b)*f));
    return '#'+[nr,ng,nb].map(x=>x.toString(16).padStart(2,'0')).join('');
  } catch { return hex; }
}

function darken(hex, pct) {
  try {
    const {r,g,b} = hexToRgb(hex);
    const f = 1 - pct/100;
    const nr = Math.round(r*f), ng = Math.round(g*f), nb = Math.round(b*f);
    return '#'+[nr,ng,nb].map(x=>x.toString(16).padStart(2,'0')).join('');
  } catch { return hex; }
}

function applyThemeColor(variable, value) {
  document.documentElement.style.setProperty('--'+variable, value);
  if (!state.theme) state.theme = {};
  state.theme[variable] = value;
  saveDataSilent();
  updateColorInputs();
}

function applyBgColor(hex) {
  const {r,g,b} = hexToRgb(hex);
  // Derive bg2, bg3, surface, surface2, border automatically
  const isLight = (r*299 + g*587 + b*114)/1000 > 128;
  const step = isLight ? -10 : 10;
  const blend = (c, amt) => Math.max(0,Math.min(255, c+amt));
  const toHex = (rv,gv,bv) => '#'+[rv,gv,bv].map(x=>Math.round(x).toString(16).padStart(2,'0')).join('');

  const bg2   = toHex(blend(r,step*0.8), blend(g,step*0.8), blend(b,step*0.8));
  const bg3   = toHex(blend(r,step*1.7), blend(g,step*1.7), blend(b,step*1.7));
  const surf  = toHex(blend(r,step*2.5), blend(g,step*2.5), blend(b,step*2.5));
  const surf2 = toHex(blend(r,step*3.2), blend(g,step*3.2), blend(b,step*3.2));
  const bord  = toHex(blend(r,step*4.5), blend(g,step*4.5), blend(b,step*4.5));
  const text  = isLight ? '#1a1a2e' : '#e8eaf0';
  const text2 = isLight ? '#4a4a6a' : '#9099b0';
  const text3 = isLight ? '#8080a0' : '#5a6275';

  const vars = {bg:hex, bg2, bg3, surface:surf, surface2:surf2, border:bord, text, text2, text3};
  Object.entries(vars).forEach(([k,v]) => {
    document.documentElement.style.setProperty('--'+k, v);
    if (!state.theme) state.theme = {};
    state.theme[k] = v;
  });
  saveDataSilent();
  updateColorInputs();
}

function applyRadius(val) {
  const v = val + 'px';
  const sm = Math.max(0, parseInt(val)-6) + 'px';
  document.documentElement.style.setProperty('--radius', v);
  document.documentElement.style.setProperty('--radius-sm', sm);
  if (!state.theme) state.theme = {};
  state.theme.radius = parseInt(val);
  state.theme.radiusSm = Math.max(0, parseInt(val)-6);
  const lbl = $('radius-val');
  if (lbl) lbl.textContent = v;
  const rng = $('radius-range');
  if (rng) rng.value = val;
  saveDataSilent();
}

function applyPreset(preset) {
  const c = preset.colors;
  const bg = c.bg || THEME_DEFAULTS.bg;
  applyBgColor(bg);
  Object.entries(c).forEach(([k,v]) => {
    if (k === 'bg') return;
    document.documentElement.style.setProperty('--'+k, v);
    if (!state.theme) state.theme = {};
    state.theme[k] = v;
    if (k === 'accent') {
      const a2 = lighten(v, 20);
      document.documentElement.style.setProperty('--accent2', a2);
      state.theme.accent2 = a2;
    }
  });
  state.theme.presetId = preset.id;
  saveDataSilent();
  updateColorInputs();
  renderThemePresets();
}

function resetTheme() {
  state.theme = {};
  Object.entries(THEME_DEFAULTS).forEach(([k,v]) => {
    if (k === 'radius') {
      document.documentElement.style.setProperty('--radius', v+'px');
      document.documentElement.style.setProperty('--radius-sm', (v-6)+'px');
    } else {
      document.documentElement.style.setProperty('--'+k, v);
    }
  });
  saveDataSilent();
  updateColorInputs();
  renderThemePresets();
  applyRadius(14);
  toast('Thème réinitialisé');
}

function loadTheme() {
  if (!state.theme) return;
  const t = state.theme;
  Object.entries(t).forEach(([k,v]) => {
    if (k === 'radius') {
      document.documentElement.style.setProperty('--radius', v+'px');
    } else if (k === 'radiusSm') {
      document.documentElement.style.setProperty('--radius-sm', v+'px');
    } else if (k !== 'presetId') {
      document.documentElement.style.setProperty('--'+k, v);
    }
  });
}

function updateColorInputs() {
  const root = getComputedStyle(document.documentElement);
  const get = v => root.getPropertyValue('--'+v).trim();
  const pairs = {
    'clr-accent':'accent', 'clr-todo':'todo', 'clr-notes':'notes',
    'clr-invest':'invest', 'clr-culture':'culture', 'clr-voyage':'voyage', 'clr-bg':'bg'
  };
  Object.entries(pairs).forEach(([id,v]) => {
    const el = $(id);
    if (el) el.value = get(v);
  });
  // Radius
  const radius = parseInt(get('radius')) || 14;
  const rng = $('radius-range');
  if (rng) rng.value = radius;
  const lbl = $('radius-val');
  if (lbl) lbl.textContent = radius + 'px';

  // Accent swatches
  const accent = get('accent');
  const swatchEl = $('clr-accent-swatches');
  if (swatchEl) {
    const swatches = [accent, lighten(accent,15), lighten(accent,30), darken(accent,15), darken(accent,30),
      '#f0a500','#e05555','#30c88a','#38b8d8','#7c6ff7','#f07050','#e05580'];
    swatchEl.innerHTML = swatches.map(c =>
      `<div class="swatch ${c===accent?'active':''}" style="background:${c}" title="${c}"
        onclick="applyThemeColor('accent','${c}');applyThemeColor('accent2','${lighten(c,20)}');updateColorInputs()"></div>`
    ).join('');
  }
}

function renderThemePresets() {
  const el = $('theme-presets');
  if (!el) return;
  const activeId = state.theme?.presetId || 'default';
  el.innerHTML = THEME_PRESETS.map(p => {
    const dots = Object.values(p.colors).slice(0,4)
      .map(c => `<div class="theme-dot" style="background:${c}"></div>`).join('');
    return `<div class="theme-preset ${p.id===activeId?'active':''}" onclick="applyPreset(${JSON.stringify(p).replace(/"/g,'&quot;')})">
      <div class="theme-preset-dots">${dots}</div>
      <span>${p.name}</span>
    </div>`;
  }).join('');
}

// ===== GLOBAL SEARCH =====
function openSearch() {
  const ov = $('search-overlay');
  if (!ov) return;
  ov.style.display = 'block';
  requestAnimationFrame(() => {
    const inp = $('search-input');
    if (inp) { inp.value = ''; inp.focus(); }
    $('search-results').innerHTML = '<div class="search-empty"><i class="fas fa-magnifying-glass" style="font-size:28px;display:block;margin-bottom:8px"></i>Tapez pour rechercher…</div>';
  });
}

function closeSearch() {
  const ov = $('search-overlay');
  if (ov) ov.style.display = 'none';
}

function runSearch(q) {
  const el = $('search-results');
  if (!el) return;
  q = (q||'').trim().toLowerCase();
  if (q.length < 2) {
    el.innerHTML = '<div class="search-empty">Tapez au moins 2 caractères…</div>';
    return;
  }

  const hl = (text, q) => {
    if (!text) return '';
    const safe = text.replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')', 'gi');
    return safe.replace(re, '<span class="search-highlight">$1</span>');
  };

  const groups = [];

  // --- TODO ---
  const todos = (state.todo||[]).filter(t =>
    t.text?.toLowerCase().includes(q) || t.cat?.toLowerCase().includes(q) || t.notes?.toLowerCase().includes(q));
  if (todos.length) groups.push({
    label: 'Todo', color: 'var(--todo)', icon: 'fa-check-circle',
    items: todos.map(t => ({
      icon: `<i class="fas fa-check-circle" style="color:var(--todo)"></i>`,
      title: hl(t.text, q),
      sub: [t.cat, t.dueDate?'Échéance '+formatDate(t.dueDate):''].filter(Boolean).join(' · '),
      action: `navigate('todo')`
    }))
  });

  // --- NOTES ---
  const notes = (state.notes||[]).filter(n =>
    n.title?.toLowerCase().includes(q) || n.content?.toLowerCase().includes(q));
  if (notes.length) groups.push({
    label: 'Notes', color: 'var(--notes)', icon: 'fa-pen-nib',
    items: notes.map(n => ({
      icon: `<i class="fas fa-${n.type==='hw'?'pen-nib':'keyboard'}" style="color:var(--notes)"></i>`,
      title: hl(n.title||'Sans titre', q),
      sub: hl((n.content||'').slice(0,80), q),
      action: `navigate('notes')`
    }))
  });

  // --- INVEST ---
  const invests = (state.invest||[]).filter(i =>
    i.nom?.toLowerCase().includes(q) || i.ticker?.toLowerCase().includes(q) || i.cat?.toLowerCase().includes(q));
  if (invests.length) groups.push({
    label: 'Investissement', color: 'var(--invest)', icon: 'fa-chart-line',
    items: invests.map(i => ({
      icon: `<i class="fas fa-chart-line" style="color:var(--invest)"></i>`,
      title: hl(i.nom, q),
      sub: [i.cat, i.ticker, formatMoney(i.valeurActuelle)].filter(Boolean).join(' · '),
      action: `navigate('invest')`
    }))
  });

  // --- CULTURE ---
  const cultures = (state.culture||[]).filter(c =>
    c.titre?.toLowerCase().includes(q) || c.auteur?.toLowerCase().includes(q) || c.cat?.toLowerCase().includes(q));
  if (cultures.length) groups.push({
    label: 'Culture', color: 'var(--culture)', icon: 'fa-film',
    items: cultures.map(c => ({
      icon: `<i class="fas fa-film" style="color:var(--culture)"></i>`,
      title: hl(c.titre, q),
      sub: [c.cat, c.auteur, c.annee].filter(Boolean).join(' · '),
      action: `navigate('culture')`
    }))
  });

  // --- VOYAGE ---
  const voyages = (state.voyage||[]).filter(v =>
    v.destination?.toLowerCase().includes(q) || v.notes?.toLowerCase().includes(q) || v.hebergement?.toLowerCase().includes(q));
  if (voyages.length) groups.push({
    label: 'Voyage', color: 'var(--voyage)', icon: 'fa-plane',
    items: voyages.map(v => ({
      icon: `<i class="fas fa-plane" style="color:var(--voyage)"></i>`,
      title: hl(v.destination, q),
      sub: [v.dateDepart?formatDate(v.dateDepart):'', v.hebergement].filter(Boolean).join(' · '),
      action: `navigate('voyage')`
    }))
  });

  if (!groups.length) {
    el.innerHTML = `<div class="search-empty"><i class="fas fa-face-frown" style="font-size:28px;display:block;margin-bottom:8px"></i>Aucun résultat pour « ${q} »</div>`;
    return;
  }

  el.innerHTML = groups.map(g => `
    <div class="search-result-group">
      <div class="search-result-group-title" style="color:${g.color}">
        <i class="fas ${g.icon}" style="margin-right:4px"></i>${g.label} (${g.items.length})
      </div>
      ${g.items.map(item => `
        <div class="search-result-item" onclick="${item.action};closeSearch()">
          <div class="search-result-icon" style="background:color-mix(in srgb, ${g.color} 12%, transparent)">
            ${item.icon}
          </div>
          <div style="flex:1;min-width:0">
            <div class="search-result-title">${item.title}</div>
            ${item.sub ? `<div class="search-result-sub">${item.sub}</div>` : ''}
          </div>
          <i class="fas fa-arrow-right" style="color:var(--text3);font-size:11px"></i>
        </div>`).join('')}
    </div>`).join('');
}

// ===== KEYBOARD SHORTCUTS =====
function initKeyboardShortcuts() {
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
    if (e.ctrlKey || e.metaKey) return;
    const map = {'1':'dashboard','2':'todo','3':'notes','4':'invest','5':'culture','6':'voyage','7':'habitudes','8':'journal'};
    if (map[e.key]) { navigate(map[e.key]); return; }
    if (e.key === 'n' && currentSection === 'todo') openTodoModal();
    if (e.key === 'n' && currentSection === 'notes') openNoteModal('key');
    if (e.key === 'n' && currentSection === 'invest') openInvestModal();
    if (e.key === 'n' && currentSection === 'voyage') openVoyageModal();
    if (e.key === '/') { e.preventDefault(); openSearch(); }
  });
}

// ===== DRAG & DROP TODOS =====
let _dragId = null;
function todoDragStart(e) {
  _dragId = e.currentTarget.dataset.id;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}
function todoDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}
function todoDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function todoDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const targetId = e.currentTarget.dataset.id;
  if (!_dragId || _dragId === targetId) return;
  const arr = state.todo;
  const fromIdx = arr.findIndex(t => t.id === _dragId);
  const toIdx   = arr.findIndex(t => t.id === targetId);
  if (fromIdx < 0 || toIdx < 0) return;
  const [item] = arr.splice(fromIdx, 1);
  arr.splice(toIdx, 0, item);
  saveData(); renderTodo();
}

// ===== SPARKLINE =====
function renderSparkline(history) {
  if (!history || history.length < 2) return '';
  const vals = history.slice(-10).map(h => parseFloat(h.value)||0);
  const min = Math.min(...vals), max = Math.max(...vals);
  const range = max - min || 1;
  const W = 60, H = 20;
  const pts = vals.map((v,i) => {
    const x = (i/(vals.length-1))*W;
    const y = H - ((v-min)/range)*H;
    return `${x},${y}`;
  }).join(' ');
  const last = vals[vals.length-1], first = vals[0];
  const color = last >= first ? 'var(--invest)' : 'var(--danger)';
  return `<div class="invest-sparkline-wrap">
    <svg class="sparkline" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
      <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
    </svg>
  </div>`;
}

// ===== INVEST HISTORY =====
function openInvestHistory(id) {
  const inv = (state.invest||[]).find(i => i.id === id);
  if (!inv) return;
  const hist = inv.history||[];
  const rows = hist.slice().reverse().map(h =>
    `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:var(--text2)">${h.date}</span>
      <span style="font-weight:600;font-family:'Bricolage Grotesque',sans-serif">${formatMoney(h.value)}</span>
    </div>`).join('') || '<div style="color:var(--text3);font-size:13px;padding:12px 0">Aucun historique</div>';
  showModal('invest-hist-modal',`
    <div class="modal-header">
      <div class="modal-title">📈 Historique — ${inv.nom}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('invest-hist-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:12px">
        <button class="btn btn-primary btn-sm" onclick="addInvestSnapshot('${id}')"><i class="fas fa-plus"></i> Saisir valeur aujourd'hui</button>
      </div>
      <div style="max-height:300px;overflow-y:auto">${rows}</div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('invest-hist-modal')">Fermer</button></div>
  `);
}

function addInvestSnapshot(id) {
  const val = prompt('Valeur actuelle (€) :');
  if (val === null) return;
  const v = parseFloat(val);
  if (isNaN(v)) { toast('Valeur invalide','fas fa-xmark'); return; }
  const inv = (state.invest||[]).find(i => i.id === id);
  if (!inv) return;
  if (!inv.history) inv.history = [];
  inv.valeurActuelle = v;
  inv.history.push({ date: new Date().toISOString().slice(0,10), value: v });
  if (inv.history.length > 30) inv.history = inv.history.slice(-30);
  saveData(); closeModal('invest-hist-modal'); renderInvest();
  toast('Valeur mise à jour');
}

// ===== IMPORT CSV INVEST =====
function importInvestCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split('\n').filter(l => l.trim());
    let imported = 0;
    lines.slice(1).forEach(line => {
      const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g,''));
      if (parts.length < 3) return;
      const [nom, achat, actuel, cat='', ticker=''] = parts;
      const va = parseFloat(achat), vc = parseFloat(actuel);
      if (!nom || isNaN(va) || isNaN(vc)) return;
      if (!state.invest) state.invest = [];
      state.invest.push({ id:uid(), nom, valeurAchat:va, valeurActuelle:vc, cat:cat||'Actions', ticker, history:[{date:new Date().toISOString().slice(0,10),value:vc}] });
      imported++;
    });
    saveData(); renderInvest();
    toast(`${imported} position(s) importée(s) ✓`);
  };
  reader.readAsText(file);
}

// ===== OFFLINE BANNER =====
function initOfflineBanner() {
  const update = () => {
    const b = $('offline-banner');
    if (!b) return;
    if (!navigator.onLine) b.classList.add('show');
    else b.classList.remove('show');
  };
  window.addEventListener('online', update);
  window.addEventListener('offline', update);
  update();
}

// ===== PWA =====
let _pwaPrompt = null;
function initPWA() {
  // Inject manifest dynamically
  const manifest = {
    name:'JDKActivity', short_name:'JDKActivity',
    description:'Tableau de bord personnel',
    start_url:'./', display:'standalone',
    background_color:'#0d0f14', theme_color:'#0d0f14',
    icons:[{ src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230d0f14'/><text y='70' x='50' text-anchor='middle' font-size='60' fill='%23f0a500'>⚡</text></svg>", sizes:'192x192', type:'image/svg+xml'}]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const link = $('pwa-manifest');
  if (link) link.href = URL.createObjectURL(blob);

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    _pwaPrompt = e;
    const btn = $('pwa-install-btn');
    if (btn) btn.classList.add('visible');
  });
  window.addEventListener('appinstalled', () => {
    const btn = $('pwa-install-btn');
    if (btn) btn.classList.remove('visible');
    toast('Application installée ! 🎉');
  });
}

async function installPWA() {
  if (!_pwaPrompt) { toast('Installation non disponible sur ce navigateur','fas fa-info'); return; }
  _pwaPrompt.prompt();
  const { outcome } = await _pwaPrompt.userChoice;
  if (outcome === 'accepted') toast('Installation en cours…');
  _pwaPrompt = null;
  const btn = $('pwa-install-btn');
  if (btn) btn.classList.remove('visible');
}

// ===== VOYAGE REMINDERS =====
function initVoyageReminders() {
  checkVoyageReminders();
  // Check daily on visibility
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) checkVoyageReminders();
  });
}

function checkVoyageReminders() {
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  (state.voyage||[]).filter(v => v.type === 'prochain' && v.dateDepart).forEach(v => {
    const dep = new Date(v.dateDepart); dep.setHours(0,0,0,0);
    const diff = Math.round((dep - today) / 86400000);
    const key = `voy_notif_${v.id}_${diff}`;
    if ((diff === 7 || diff === 1) && !sessionStorage.getItem(key)) {
      sessionStorage.setItem(key, '1');
      const label = diff === 1 ? 'demain !' : 'dans 7 jours';
      if (Notification.permission === 'granted') {
        new Notification(`✈️ Voyage ${label}`, {
          body: `${v.emoji||'🌍'} ${v.destination}${v.hebergement ? ' · '+v.hebergement : ''}`,
          tag: 'jdk-voyage-'+v.id
        });
      } else {
        showDeadlineBanner('✈️', `Départ ${label}`, `${v.emoji||'🌍'} ${v.destination}`, diff === 1);
      }
    }
  });
}

// ===== FOCUS DU JOUR =====
function renderFocusDay() {
  const today = new Date().toISOString().slice(0,10);
  const urgent = (state.todo||[]).filter(t => !t.done && t.priority === 'high').slice(0,3);
  const dueToday = (state.todo||[]).filter(t => !t.done && t.dueDate === today);
  const nextVoyage = (state.voyage||[]).filter(v => v.type==='prochain' && v.dateDepart >= today)
    .sort((a,b) => a.dateDepart.localeCompare(b.dateDepart))[0];
  const totalActuel = (state.invest||[]).reduce((s,i) => s+(parseFloat(i.valeurActuelle)||0), 0);
  const totalAchat  = (state.invest||[]).reduce((s,i) => s+(parseFloat(i.valeurAchat)||0), 0);
  const pnl = totalActuel - totalAchat;

  if (!urgent.length && !dueToday.length && !nextVoyage) return '';

  const rows = [
    ...dueToday.map(t => `<div class="focus-row"><div class="focus-icon">⚠️</div><div style="flex:1">${t.text}</div><div style="font-size:11px;color:var(--danger)">Aujourd'hui</div></div>`),
    ...urgent.map(t => `<div class="focus-row"><div class="focus-icon">🔴</div><div style="flex:1">${t.text}</div></div>`),
    nextVoyage ? `<div class="focus-row"><div class="focus-icon">${nextVoyage.emoji||'✈️'}</div><div style="flex:1">${nextVoyage.destination}</div><div style="font-size:11px;color:var(--voyage)">${formatDate(nextVoyage.dateDepart)}</div></div>` : '',
    totalActuel > 0 ? `<div class="focus-row"><div class="focus-icon">💹</div><div style="flex:1">${formatMoney(totalActuel)}</div><div style="font-size:11px;color:${pnl>=0?'var(--invest)':'var(--danger)'}">${pnl>=0?'+':''}${formatMoney(pnl)}</div></div>` : '',
  ].filter(Boolean).join('');

  return `<div class="focus-card"><div class="focus-title">⚡ Focus du jour</div>${rows}</div>`;
}

// ===== WIDGET FUNCTIONS (SETTINGS) =====
function buildWidgetText() {
  const todos = state.todo||[];
  const pending = todos.filter(t=>!t.done);
  const urgent  = pending.filter(t=>t.priority==='high');
  const inv = state.invest||[];
  const totalActuel = inv.reduce((s,i)=>s+(parseFloat(i.valeurActuelle)||0),0);
  const totalAchat  = inv.reduce((s,i)=>s+(parseFloat(i.valeurAchat)||0),0);
  const pnl = totalActuel-totalAchat;
  const pnlPct = totalAchat ? (pnl/totalAchat*100).toFixed(1) : '0.0';
  const today = new Date().toISOString().slice(0,10);
  const nextVoy = (state.voyage||[]).filter(v=>v.type==='prochain'&&v.dateDepart>=today)
    .sort((a,b)=>a.dateDepart.localeCompare(b.dateDepart))[0];
  const lines = [
    '⚡ JDKActivity',
    '────────────────',
    `✅ ${pending.length} tâche${pending.length!==1?'s':''} en cours${urgent.length?'  🔴 '+urgent.length+' urgent'+(urgent.length>1?'s':''):''}`,
    ...urgent.slice(0,2).map(t=>'  • '+t.text.slice(0,35)+(t.text.length>35?'…':'')),
    '────────────────',
    totalActuel > 0 ? `💹 ${new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(totalActuel)} €  (${pnlPct>=0?'+':''}${pnlPct}%)` : null,
    `📝 ${(state.notes||[]).length} note${(state.notes||[]).length!==1?'s':''}`,
    nextVoy ? '────────────────' : null,
    nextVoy ? `✈️ ${nextVoy.emoji||''}${nextVoy.destination} — ${nextVoy.dateDepart}` : null,
    nextVoy ? `  J-${Math.ceil((new Date(nextVoy.dateDepart)-new Date())/86400000)}` : null,
    '────────────────',
    `🕐 ${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`
  ].filter(l=>l!==null);
  return lines.join('\n');
}

function refreshWidgetPreview() {
  const box = $('widget-preview-box');
  if (!box) return;
  const text = buildWidgetText();
  box.innerHTML = text.split('\n').map(l => {
    if (l.startsWith('⚡')) return `<div class="wline-title">${l}</div>`;
    if (l.startsWith('─')) return `<div class="wline-sep">${l}</div>`;
    if (l.startsWith('✅')||l.startsWith('  •')) return `<div class="wline-todo">${l}</div>`;
    if (l.startsWith('💹')) return `<div class="wline-invest">${l}</div>`;
    if (l.startsWith('✈️')) return `<div class="wline-voyage">${l}</div>`;
    if (l.startsWith('📝')) return `<div class="wline-notes">${l}</div>`;
    if (l.startsWith('🕐')) return `<div class="wline-time">${l}</div>`;
    return `<div>${l}</div>`;
  }).join('');
}

function switchWidgetTab(tab) {
  ['preview','macrodroid','tasker','http'].forEach(t => {
    const p = $('widget-panel-'+t); if(p) p.style.display = t===tab?'block':'none';
  });
  document.querySelectorAll('#widget-tabs .filter-chip').forEach(el => {
    el.classList.toggle('active', el.textContent.trim().toLowerCase().includes(tab) || (tab==='preview'&&el.textContent.includes('Aperçu')));
  });
  if (tab==='preview') refreshWidgetPreview();
  else generateWidgetScripts();
}

function generateWidgetScripts() {
  const apikey = state.cloud.apikey||'';
  const binid  = state.cloud.binid||'';
  const url = binid ? `https://api.jsonbin.io/v3/b/${binid}/latest` : '—';

  const el1 = $('widget-apikey-display'), el2 = $('widget-apikey-display2');
  const eu1 = $('widget-jsonbin-url'), eu2 = $('widget-jsonbin-url2');
  if(el1) el1.textContent = apikey||'configurez votre clé dans Cloud Sync';
  if(el2) el2.textContent = apikey||'configurez votre clé';
  if(eu1) eu1.textContent = url;
  if(eu2) eu2.textContent = url;

  const scriptCore = `// ====== JDKActivity Widget ======
var API_KEY = "${apikey||'VOTRE_CLE_JSONBIN'}";
var BIN_ID  = "${binid||'VOTRE_BIN_ID'}";
// ================================

var req = new XMLHttpRequest();
req.open("GET", "https://api.jsonbin.io/v3/b/" + BIN_ID + "/latest", false);
req.setRequestHeader("X-Master-Key", API_KEY);
req.setRequestHeader("X-Bin-Meta", "false");
req.send();

if (req.status !== 200) {
  output = "Erreur " + req.status;
} else {
  var d = JSON.parse(req.responseText);
  var todos = d.todo||[], pending = todos.filter(function(t){return !t.done;});
  var urgent = pending.filter(function(t){return t.priority==="high";});
  var inv = d.invest||[];
  var total = 0, achat = 0;
  inv.forEach(function(i){ total+=parseFloat(i.valeurActuelle)||0; achat+=parseFloat(i.valeurAchat)||0; });
  var pnl = total-achat, pct = achat?(pnl/achat*100).toFixed(1):"0.0";
  var today = new Date().toISOString().slice(0,10);
  var voys = (d.voyage||[]).filter(function(v){return v.type==="prochain"&&v.dateDepart>=today;});
  voys.sort(function(a,b){return a.dateDepart.localeCompare(b.dateDepart);});
  var nv = voys[0];

  var lines = ["⚡ JDKActivity","────────────────",
    "✅ "+pending.length+" tâche"+(pending.length!==1?"s":"")+(urgent.length?"  🔴 "+urgent.length+" urgent"+(urgent.length>1?"s":""):"")];
  urgent.slice(0,2).forEach(function(t){ lines.push("  • "+t.text.slice(0,30)); });
  lines.push("────────────────");
  if(total>0) lines.push("💹 "+Math.round(total).toLocaleString("fr-FR")+" € ("+(pct>=0?"+":"")+pct+"%)");
  lines.push("📝 "+(d.notes||[]).length+" note"+(((d.notes||[]).length)!==1?"s":""));
  if(nv){ var diff=Math.ceil((new Date(nv.dateDepart)-new Date())/86400000);
    lines.push("────────────────","✈️ "+(nv.emoji||"")+" "+nv.destination,"  J-"+diff); }
  lines.push("────────────────","🕐 "+new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}));
  output = lines.join("\\n");
}`;

  const macroEl = $('widget-script-macrodroid');
  if (macroEl) macroEl.value = scriptCore + '\n\n// Puis dans "Définir variable" :\n// variable: jdk_widget\n// valeur: {output}';

  const taskerEl = $('widget-script-tasker');
  if (taskerEl) taskerEl.value = scriptCore;
}

function copyWidgetScript(type) {
  const el = $('widget-script-'+type);
  if (!el) return;
  navigator.clipboard.writeText(el.value).then(()=>toast('Script copié ✓')).catch(()=>toast('Erreur copie','fas fa-xmark'));
}

// ===== JOURNAL ENGINE =====

const JOURNAL_MOODS = [
  { emoji:'😄', label:'Super' },
  { emoji:'🙂', label:'Bien' },
  { emoji:'😐', label:'Neutre' },
  { emoji:'😔', label:'Pas top' },
  { emoji:'😤', label:'Stressé' },
  { emoji:'😴', label:'Fatigué' },
  { emoji:'🤩', label:'Excellent' },
  { emoji:'😤', label:'Frustré' },
];

const JOURNAL_TAGS_PRESET = ['Travail','Perso','Santé','Famille','Réflexion','Objectifs','Gratitude','Idées'];

let _journalFilter = 'all';
let _journalSearch = '';

function renderJournal() {
  const entries = (state.journal||[]).slice().sort((a,b) => b.date.localeCompare(a.date));

  // Stats
  const statsEl = $('journal-stats');
  if (statsEl) {
    const total = entries.length;
    const thisMonth = entries.filter(e => e.date.startsWith(new Date().toISOString().slice(0,7))).length;
    const streak = journalStreak();
    const totalWords = entries.reduce((s,e) => s + wordCount(e.content||''), 0);
    statsEl.innerHTML = [
      { icon:'📓', val:total, label:'Entrées' },
      { icon:'📅', val:thisMonth, label:'Ce mois' },
      { icon:'🔥', val:streak+' j', label:'Streak' },
      { icon:'📝', val:totalWords, label:'Mots écrits' },
    ].map(p=>`
      <div class="journal-stat-pill">
        <span style="font-size:18px">${p.icon}</span>
        <div>
          <div class="val">${p.val}</div>
          <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.3px">${p.label}</div>
        </div>
      </div>`).join('');
  }

  // Filter bar
  const filtersEl = $('journal-filters');
  if (filtersEl) {
    const moods = [...new Set(entries.map(e=>e.mood).filter(Boolean))];
    filtersEl.innerHTML = `
      <div class="filter-chip ${_journalFilter==='all'?'active':''}" style="--c:var(--journal)" onclick="journalFilter('all')">Tout</div>
      ${moods.map(m=>`<div class="filter-chip ${_journalFilter===m?'active':''}" style="--c:var(--journal)" onclick="journalFilter('${m}')">${m}</div>`).join('')}
      <div class="filter-spacer"></div>
      <div style="position:relative">
        <i class="fas fa-magnifying-glass" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:11px"></i>
        <input class="form-input" style="padding-left:30px;width:180px;font-size:12px;height:34px" placeholder="Rechercher…" value="${_journalSearch}" oninput="journalSearch(this.value)">
      </div>`;
  }

  // Entries
  const listEl = $('journal-list');
  if (!listEl) return;

  let filtered = entries;
  if (_journalFilter !== 'all') filtered = filtered.filter(e => e.mood === _journalFilter);
  if (_journalSearch) {
    const q = _journalSearch.toLowerCase();
    filtered = filtered.filter(e =>
      (e.title||'').toLowerCase().includes(q) ||
      (e.content||'').toLowerCase().includes(q) ||
      (e.tags||[]).some(t=>t.toLowerCase().includes(q))
    );
  }

  if (!filtered.length) {
    listEl.innerHTML = `<div class="journal-empty">
      <div class="journal-empty-icon">📓</div>
      <p style="font-size:15px;font-weight:600;margin-bottom:8px">${entries.length ? 'Aucun résultat' : 'Aucune entrée pour l\'instant'}</p>
      <p style="font-size:13px">${entries.length ? 'Modifie le filtre ou la recherche' : 'Commence par écrire ta première entrée du jour'}</p>
      ${!entries.length ? `<button class="btn btn-primary" style="margin-top:20px" onclick="openJournalModal()"><i class="fas fa-plus"></i> Nouvelle entrée</button>` : ''}
    </div>`;
    return;
  }

  listEl.innerHTML = filtered.map(e => {
    const d = new Date(e.date);
    const day = d.getDate();
    const mon = d.toLocaleDateString('fr-FR',{month:'short'}).replace('.','');
    const dow = d.toLocaleDateString('fr-FR',{weekday:'short'});
    const wc  = wordCount(e.content||'');
    const preview = (e.content||'').replace(/\n/g,' ').slice(0,160);
    return `
    <div class="journal-entry" onclick="openJournalModal('${e.id}')">
      <div class="journal-entry-head">
        <div class="journal-date-badge">
          <div class="journal-date-day">${day}</div>
          <div class="journal-date-mon">${mon}</div>
        </div>
        <div class="journal-meta">
          <div class="journal-title">
            <span class="journal-mood">${e.mood||'📓'}</span>
            ${e.title || '<span style="color:var(--text3);font-style:italic;font-weight:400">Sans titre</span>'}
          </div>
          <div style="font-size:11px;color:var(--text3)">${dow} · ${wc} mot${wc>1?'s':''}</div>
          ${(e.tags||[]).length ? `<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:5px">${e.tags.map(t=>`<span class="journal-tag">${t}</span>`).join('')}</div>` : ''}
        </div>
        <div class="journal-actions">
          <button class="btn btn-ghost btn-icon" style="font-size:11px;width:28px;height:28px" onclick="event.stopPropagation();deleteJournalEntry('${e.id}')" title="Supprimer"><i class="fas fa-trash" style="color:var(--danger)"></i></button>
        </div>
      </div>
      ${preview ? `<div class="journal-preview">${preview}</div>` : ''}
    </div>`;
  }).join('');
}

function wordCount(text) {
  return text.trim() ? text.trim().split(/\s+/).length : 0;
}

function journalStreak() {
  const entries = state.journal||[];
  if (!entries.length) return 0;
  const datesSet = new Set(entries.map(e=>e.date.slice(0,10)));
  let streak = 0;
  const today = new Date();
  for (let i=0; i<365; i++) {
    const d = new Date(today); d.setDate(d.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    if (datesSet.has(ds)) streak++;
    else if (i > 0) break;
  }
  return streak;
}

function journalFilter(f) {
  _journalFilter = f;
  renderJournal();
}

function journalSearch(q) {
  _journalSearch = q;
  renderJournal();
}

function openJournalModal(id) {
  const entry = id ? (state.journal||[]).find(e=>e.id===id) : null;
  const today = new Date().toISOString().slice(0,10);
  const selMood = entry?.mood || '📓';
  const selTags = entry?.tags || [];

  showModal('journal-modal', `
    <div class="modal-header">
      <div class="modal-title" style="color:var(--journal)">
        <i class="fas fa-book-open"></i> ${entry ? 'Modifier l\'entrée' : 'Nouvelle entrée'}
      </div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('journal-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">

      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label class="form-label">Date</label>
          <input class="form-input" type="date" id="jrn-date" value="${entry?.date?.slice(0,10)||today}">
        </div>
        <div class="form-group" style="flex:2">
          <label class="form-label">Titre (optionnel)</label>
          <input class="form-input" id="jrn-title" placeholder="Résumé en quelques mots…" value="${entry?.title||''}">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Comment tu te sens ?</label>
        <div class="mood-grid" id="jrn-mood-grid">
          ${JOURNAL_MOODS.map(m=>`
            <div class="mood-opt ${m.emoji===selMood?'active':''}" onclick="journalPickMood(this,'${m.emoji}')" title="${m.label}">${m.emoji}</div>
          `).join('')}
        </div>
        <input type="hidden" id="jrn-mood" value="${selMood}">
      </div>

      <div class="form-group">
        <label class="form-label">Écris ici…</label>
        <textarea class="journal-editor" id="jrn-content" placeholder="Comment s'est passée ta journée ? Qu'est-ce qui te tient à cœur en ce moment ?" oninput="updateJrnWC(this)">${entry?.content||''}</textarea>
        <div class="journal-wc" id="jrn-wc">${wordCount(entry?.content||'')} mot${wordCount(entry?.content||'')!==1?'s':''}</div>
      </div>

      <div class="form-group">
        <label class="form-label">Tags</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
          ${JOURNAL_TAGS_PRESET.map(t=>`
            <div class="filter-chip ${selTags.includes(t)?'active':''}" style="--c:var(--journal);cursor:pointer;font-size:11px" onclick="journalToggleTag(this,'${t}')">${t}</div>
          `).join('')}
        </div>
        <div style="display:flex;gap:8px">
          <input class="form-input" id="jrn-tag-input" placeholder="Tag personnalisé…" style="font-size:12px" onkeydown="if(event.key==='Enter'){event.preventDefault();journalAddCustomTag()}">
          <button class="btn btn-ghost btn-sm" onclick="journalAddCustomTag()"><i class="fas fa-plus"></i></button>
        </div>
        <input type="hidden" id="jrn-tags" value="${JSON.stringify(selTags)}">
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('journal-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveJournalEntry('${id||''}')">
        <i class="fas fa-check"></i> ${entry ? 'Enregistrer' : 'Ajouter'}
      </button>
    </div>
  `);
  setTimeout(() => $('jrn-content')?.focus(), 100);
}

window.journalPickMood = function(el, emoji) {
  document.querySelectorAll('.mood-opt').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');
  const inp = $('jrn-mood'); if(inp) inp.value = emoji;
};

window.journalToggleTag = function(el, tag) {
  el.classList.toggle('active');
  const inp = $('jrn-tags'); if(!inp) return;
  let tags = JSON.parse(inp.value||'[]');
  if (el.classList.contains('active')) { if(!tags.includes(tag)) tags.push(tag); }
  else tags = tags.filter(t=>t!==tag);
  inp.value = JSON.stringify(tags);
};

window.journalAddCustomTag = function() {
  const input = $('jrn-tag-input');
  const tag = input?.value.trim();
  if (!tag) return;
  const inp = $('jrn-tags');
  let tags = JSON.parse(inp?.value||'[]');
  if (!tags.includes(tag)) {
    tags.push(tag);
    inp.value = JSON.stringify(tags);
    // Add chip
    const chip = document.createElement('div');
    chip.className = 'filter-chip active';
    chip.style.cssText = '--c:var(--journal);cursor:pointer;font-size:11px';
    chip.textContent = tag;
    chip.onclick = () => window.journalToggleTag(chip, tag);
    input.closest('.form-group').querySelector('div').appendChild(chip);
  }
  input.value = '';
};

window.updateJrnWC = function(el) {
  const wc = wordCount(el.value);
  const el2 = $('jrn-wc');
  if (el2) el2.textContent = `${wc} mot${wc!==1?'s':''}`;
};

window.saveJournalEntry = function(id) {
  const date  = $('jrn-date')?.value || new Date().toISOString().slice(0,10);
  const title = $('jrn-title')?.value.trim() || '';
  const mood  = $('jrn-mood')?.value || '📓';
  const content = $('jrn-content')?.value || '';
  const tags  = JSON.parse($('jrn-tags')?.value||'[]');

  if (!content.trim() && !title) { toast('Écris quelque chose d\'abord 😊','fas fa-warning'); return; }

  if (!state.journal) state.journal = [];
  if (id) {
    const e = state.journal.find(e=>e.id===id);
    if (e) { e.date=date; e.title=title; e.mood=mood; e.content=content; e.tags=tags; e.updatedAt=new Date().toISOString(); }
  } else {
    state.journal.push({ id:'jrn_'+Date.now(), date, title, mood, content, tags, createdAt:new Date().toISOString() });
  }
  closeModal('journal-modal');
  saveData();
  renderJournal();
  toast(id ? 'Entrée modifiée ✓' : '📓 Entrée ajoutée !');
};

window.deleteJournalEntry = function(id) {
  if (!confirm('Supprimer cette entrée définitivement ?')) return;
  state.journal = (state.journal||[]).filter(e=>e.id!==id);
  saveData();
  renderJournal();
  toast('Entrée supprimée','fas fa-trash');
};

window.openJournalModal = openJournalModal;

// ===== HABITUDES ENGINE =====

const HABIT_COLORS = [
  '#22d3a0','#7c6ff7','#f0a500','#e05580','#38b8d8','#e868a2',
  '#30c88a','#ff7043','#ab47bc','#42a5f5','#ef5350','#66bb6a'
];
const HABIT_EMOJIS = ['🏃','💪','📚','🧘','💧','🥗','😴','✍️','🎸','🌿','🧠','🏊','🚴','🎯','🧹','📖','🍎','☀️','🏋️','🎨'];

function habitToday() {
  return new Date().toISOString().slice(0,10);
}

function habitDateStr(d) {
  return d instanceof Date ? d.toISOString().slice(0,10) : d;
}

function habitIsDoneToday(habit) {
  return (habit.completions||[]).includes(habitToday());
}

function habitStreak(habit) {
  const comps = new Set(habit.completions||[]);
  const today = new Date();
  let streak = 0;
  let d = new Date(today);
  // If not done today, start checking from yesterday
  if (!comps.has(habitDateStr(d))) d.setDate(d.getDate()-1);
  while (true) {
    const ds = habitDateStr(d);
    if (!comps.has(ds)) break;
    streak++;
    d.setDate(d.getDate()-1);
  }
  return streak;
}

function habitBestStreak(habit) {
  if (!(habit.completions||[]).length) return 0;
  const sorted = [...habit.completions].sort();
  let best = 1, cur = 1;
  for (let i=1;i<sorted.length;i++) {
    const prev = new Date(sorted[i-1]), curr = new Date(sorted[i]);
    const diff = (curr-prev)/(1000*60*60*24);
    if (diff===1) { cur++; best=Math.max(best,cur); }
    else cur=1;
  }
  return best;
}

function habitCompletionRate(habit, days=30) {
  const comps = new Set(habit.completions||[]);
  let count=0;
  for(let i=0;i<days;i++) {
    const d=new Date(); d.setDate(d.getDate()-i);
    if(comps.has(habitDateStr(d))) count++;
  }
  return Math.round(count/days*100);
}

function habitToggleToday(id) {
  const h = (state.habits||[]).find(h=>h.id===id);
  if(!h) return;
  const today = habitToday();
  if(!h.completions) h.completions=[];
  const idx = h.completions.indexOf(today);
  if(idx>=0) h.completions.splice(idx,1);
  else {
    h.completions.push(today);
    // Celebration
    const streak = habitStreak(h);
    if(streak>0 && streak%7===0) toast(`🔥 ${streak} jours de suite pour "${h.name}" !`, 'fas fa-fire');
    else toast(`✅ "${h.name}" validé !`);
  }
  saveData();
  renderHabitudes();
}

function renderHabitudes() {
  const habits = state.habits||[];

  // Stats pills
  const totalHabits = habits.length;
  const doneToday = habits.filter(h=>habitIsDoneToday(h)).length;
  const totalComp = habits.reduce((s,h)=>(s+(h.completions||[]).length),0);
  const bestStreak = habits.reduce((s,h)=>Math.max(s,habitBestStreak(h)),0);
  const pillsEl = $('habit-stats-pills');
  if(pillsEl) pillsEl.innerHTML = [
    { icon:'🔥', val: doneToday+'/'+totalHabits, label:'Aujourd\'hui' },
    { icon:'⚡', val: habits.reduce((s,h)=>Math.max(s,habitStreak(h)),0), label:'Streak max actuel' },
    { icon:'🏆', val: bestStreak, label:'Record de streak' },
    { icon:'✅', val: totalComp, label:'Validations totales' },
  ].map(p=>`
    <div class="habit-stat-pill">
      <span style="font-size:18px">${p.icon}</span>
      <div>
        <div class="val">${p.val}</div>
        <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.3px">${p.label}</div>
      </div>
    </div>
  `).join('');

  // Today rate
  const rateEl = $('habit-today-rate');
  if(rateEl) rateEl.textContent = totalHabits ? Math.round(doneToday/totalHabits*100)+'% complété' : '';

  // Today list
  const listEl = $('habit-today-list');
  if(listEl) {
    if(!habits.length) {
      listEl.innerHTML = `<div class="habit-empty">
        <div class="habit-empty-icon">🌱</div>
        <p style="font-size:15px;font-weight:600;margin-bottom:8px">Aucune habitude encore</p>
        <p style="font-size:13px">Commence par en créer une pour suivre ta progression quotidienne</p>
        <button class="btn btn-primary" style="margin-top:20px" onclick="openHabitModal()"><i class="fas fa-plus"></i> Créer une habitude</button>
      </div>`;
    } else {
      const today = new Date();
      const dayNames = ['D','L','M','M','J','V','S'];
      listEl.innerHTML = habits.map(h=>{
        const done = habitIsDoneToday(h);
        const streak = habitStreak(h);
        const rate = habitCompletionRate(h,30);
        const color = h.color||'var(--habit)';

        // 7-day dots
        const days7 = Array.from({length:7},(_,i)=>{
          const d=new Date(); d.setDate(d.getDate()-(6-i));
          const ds=habitDateStr(d);
          const isToday=i===6;
          const isDone=(h.completions||[]).includes(ds);
          return {ds, isToday, isDone, label:dayNames[d.getDay()]};
        });

        return `
        <div class="habit-card ${done?'completed-today':''}" style="--hc:${color}">
          <div class="habit-top">
            <button class="habit-check-btn ${done?'done':''}" onclick="habitToggleToday('${h.id}')" title="${done?'Défaire':'Valider aujourd\'hui'}">
              ${done ? '✓' : (h.emoji||'🎯')}
            </button>
            <div class="habit-info">
              <div class="habit-name">
                ${h.name}
                <span class="habit-freq-badge">${h.frequency==='weekly'?'Hebdo':'Quotidien'}</span>
              </div>
              <div class="habit-meta">
                <div class="habit-streak"><i class="fas fa-fire" style="font-size:10px"></i> ${streak} j</div>
                <div>· ${rate}% ce mois</div>
                ${streak>=7?`<div style="color:var(--accent);font-weight:600">🏆 Record !</div>`:''}
              </div>
            </div>
            <div class="habit-actions">
              <button class="btn btn-ghost btn-icon" onclick="openHabitModal('${h.id}')" title="Modifier"><i class="fas fa-pen"></i></button>
              <button class="btn btn-ghost btn-icon" style="color:var(--danger)" onclick="deleteHabit('${h.id}')" title="Supprimer"><i class="fas fa-trash"></i></button>
            </div>
          </div>
          <div class="habit-week-wrap">
            <div class="habit-week-labels">${days7.map(d=>`<div class="habit-week-label">${d.label}</div>`).join('')}</div>
            <div class="habit-week">${days7.map(d=>`<div class="habit-day-dot ${d.isDone?'done':''} ${d.isToday?'today':''}"></div>`).join('')}</div>
          </div>
        </div>`;
      }).join('');
    }
  }

  // Heatmap
  renderHabitHeatmap();
}

function renderHabitHeatmap() {
  const el = $('habit-heatmap-section');
  if(!el) return;
  const habits = state.habits||[];
  if(!habits.length) { el.innerHTML=''; return; }

  // Build a set of all completion dates across all habits (with count)
  const countMap = {};
  habits.forEach(h=>{
    (h.completions||[]).forEach(d=>{ countMap[d]=(countMap[d]||0)+1; });
  });
  const maxCount = habits.length||1;

  // 91 days back = ~13 weeks
  const today = new Date();
  const weeks = 13;
  const totalDays = weeks*7;

  // Find start (align to Monday)
  const startDate = new Date(today);
  startDate.setDate(startDate.getDate() - (totalDays-1));

  // Month labels
  const monthLabels = {};
  for(let i=0;i<totalDays;i++) {
    const d=new Date(startDate); d.setDate(d.getDate()+i);
    const week=Math.floor(i/7);
    const dom=d.getDate();
    if(dom<=7) { const m=d.toLocaleDateString('fr-FR',{month:'short'}); monthLabels[week]=m.charAt(0).toUpperCase()+m.slice(1); }
  }

  const cells = Array.from({length:totalDays},(_,i)=>{
    const d=new Date(startDate); d.setDate(d.getDate()+i);
    const ds=habitDateStr(d);
    const count=countMap[ds]||0;
    const isToday=ds===habitToday();
    let level=0;
    if(count>0) level = count>=maxCount?3:count>=Math.ceil(maxCount/2)?2:1;
    return {ds,count,level,isToday};
  });

  // Build month row
  const monthRow = Array.from({length:weeks},(_,w)=>monthLabels[w]||'').map(m=>`<div style="width:16px;text-align:center;font-size:9px;color:var(--text3)">${m}</div>`).join('');

  // Build heatmap per habit OR global
  const globalHtml = `
    <div class="card" style="padding:16px 20px">
      <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:var(--text2)">Toutes les habitudes</div>
      <div class="habit-heatmap-wrap">
        <div style="display:flex;gap:3px;margin-bottom:4px;padding-left:16px">${monthRow}</div>
        <div style="display:flex;gap:0">
          <div style="display:flex;flex-direction:column;gap:3px;margin-right:4px">
            ${['L','M','M','J','V','S','D'].map(d=>`<div style="height:13px;line-height:13px;font-size:9px;color:var(--text3);width:12px">${d}</div>`).join('')}
          </div>
          <div class="habit-heatmap" style="--hc:var(--habit)">
            ${cells.map(c=>`<div class="hm-cell l${c.level} ${c.isToday?'today-cell':''}" title="${c.ds} — ${c.count}/${maxCount} habitude(s)"></div>`).join('')}
          </div>
        </div>
      </div>
    </div>`;

  // Per-habit heatmaps
  const perHabitHtml = habits.map(h=>{
    const comps=new Set(h.completions||[]);
    const hCells=cells.map(c=>({...c,level:comps.has(c.ds)?3:0}));
    return `
    <div class="card" style="padding:16px 20px;margin-top:12px">
      <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${h.emoji||'🎯'}</span>
        <span style="font-size:12px;font-weight:600;color:var(--text2)">${h.name}</span>
        <span style="margin-left:auto;font-size:11px;color:var(--text3)">Streak actuel : <strong style="color:${h.color||'var(--habit)'}">${habitStreak(h)} j</strong></span>
      </div>
      <div class="habit-heatmap-wrap">
        <div class="habit-heatmap" style="--hc:${h.color||'var(--habit)'}">
          ${hCells.map(c=>`<div class="hm-cell l${c.level} ${c.isToday?'today-cell':''}" title="${c.ds}"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = globalHtml + perHabitHtml;
}

// ── Modal Add/Edit ──
function openHabitModal(id) {
  const h = id ? (state.habits||[]).find(x=>x.id===id) : null;
  const selectedEmoji = h?.emoji||'🎯';
  const selectedColor = h?.color||HABIT_COLORS[0];

  showModal('habit-modal', `
    <div class="modal-header">
      <div class="modal-title" style="color:var(--habit)">${h?'<i class="fas fa-pen"></i> Modifier':'<i class="fas fa-fire"></i> Nouvelle habitude'}</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal('habit-modal')"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nom de l'habitude</label>
        <input class="form-input" id="habit-input-name" placeholder="Ex: Méditation, Sport, Lecture…" value="${h?.name||''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fréquence</label>
          <select class="form-select" id="habit-input-freq">
            <option value="daily" ${(!h||h.frequency==='daily')?'selected':''}>Quotidien</option>
            <option value="weekly" ${h?.frequency==='weekly'?'selected':''}>Hebdomadaire</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Emoji</label>
        <div class="habit-emoji-grid" id="habit-emoji-grid">
          ${HABIT_EMOJIS.map(e=>`<div class="habit-emoji-opt ${e===selectedEmoji?'active':''}" onclick="habitPickEmoji(this,'${e}')">${e}</div>`).join('')}
        </div>
        <input type="hidden" id="habit-input-emoji" value="${selectedEmoji}">
      </div>
      <div class="form-group">
        <label class="form-label">Couleur</label>
        <div class="habit-color-row">
          ${HABIT_COLORS.map(c=>`<div class="habit-color-swatch ${c===selectedColor?'active':''}" style="background:${c}" onclick="habitPickColor(this,'${c}')"></div>`).join('')}
        </div>
        <input type="hidden" id="habit-input-color" value="${selectedColor}">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('habit-modal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveHabit('${id||''}')"><i class="fas fa-check"></i> ${h?'Enregistrer':'Créer'}</button>
    </div>
  `);
  setTimeout(()=>$('habit-input-name')?.focus(), 100);
}

window.habitPickEmoji = function(el, emoji) {
  document.querySelectorAll('.habit-emoji-opt').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');
  const inp = $('habit-input-emoji'); if(inp) inp.value=emoji;
};

window.habitPickColor = function(el, color) {
  document.querySelectorAll('.habit-color-swatch').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');
  const inp = $('habit-input-color'); if(inp) inp.value=color;
};

window.saveHabit = function(id) {
  const name = $('habit-input-name')?.value.trim();
  if(!name) { toast('Donne un nom à cette habitude','fas fa-warning'); return; }
  const freq = $('habit-input-freq')?.value||'daily';
  const emoji = $('habit-input-emoji')?.value||'🎯';
  const color = $('habit-input-color')?.value||HABIT_COLORS[0];

  if(!state.habits) state.habits=[];
  if(id) {
    const h = state.habits.find(x=>x.id===id);
    if(h) { h.name=name; h.frequency=freq; h.emoji=emoji; h.color=color; }
  } else {
    state.habits.push({ id:'h_'+Date.now(), name, frequency:freq, emoji, color, completions:[], createdAt:habitToday() });
  }
  closeModal('habit-modal');
  saveData();
  renderHabitudes();
  toast(id?'Habitude modifiée ✓':'Habitude créée 🌱');
};

window.deleteHabit = function(id) {
  if(!confirm('Supprimer cette habitude et tout son historique ?')) return;
  state.habits=(state.habits||[]).filter(h=>h.id!==id);
  saveData();
  renderHabitudes();
  toast('Habitude supprimée','fas fa-trash');
};

window.openHabitModal = openHabitModal;
window.habitToggleToday = habitToggleToday;

// ===== POMODORO TIMER =====
const _POMO = {
  mode: 'work',
  running: false,
  remaining: 25 * 60,
  total: 25 * 60,
  sessionsDone: 0,
  todayDate: new Date().toDateString(),
  todayCount: parseInt(localStorage.getItem('jdk_pomo_today_count') || '0'),
  todayDateStored: localStorage.getItem('jdk_pomo_today_date') || '',
  totalCount: parseInt(localStorage.getItem('jdk_pomo_total') || '0'),
};
let _pomoInterval = null;
let _pomoOpen = false;

// Reset today count if new day
(function() {
  const today = new Date().toDateString();
  if (_POMO.todayDateStored !== today) {
    _POMO.todayCount = 0;
    localStorage.setItem('jdk_pomo_today_count', '0');
    localStorage.setItem('jdk_pomo_today_date', today);
  }
})();

function togglePomoPanel() {
  _pomoOpen = !_pomoOpen;
  const panel = document.getElementById('pomo-panel');
  if (panel) panel.style.display = _pomoOpen ? 'block' : 'none';
  if (_pomoOpen) pomoRefreshUI();
}

function pomoRefreshUI() {
  // Digits
  const m = Math.floor(_POMO.remaining / 60);
  const s = _POMO.remaining % 60;
  const digits = document.getElementById('pomo-digits');
  if (digits) digits.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  // Ring
  const ring = document.getElementById('pomo-ring');
  if (ring) {
    const circ = 2 * Math.PI * 60;
    ring.style.strokeDasharray = circ;
    ring.style.strokeDashoffset = circ * (1 - _POMO.remaining / _POMO.total);
    ring.style.stroke = _POMO.mode === 'work' ? 'url(#pg)' : '#c86dd4';
  }

  // Mode label
  const lbl = document.getElementById('pomo-mode-lbl');
  if (lbl) lbl.textContent = { work:'Focus', short:'Pause', long:'Pause longue' }[_POMO.mode] || '';

  // Play icon
  const icon = document.getElementById('pomo-play-icon');
  if (icon) icon.className = _POMO.running ? 'fas fa-pause' : 'fas fa-play';

  // Play button color
  const btn = document.getElementById('pomo-play-btn');
  if (btn) btn.style.background = _POMO.running ? '#c86dd4' : '#e868a2';

  // Dots
  const dots = document.querySelectorAll('.pdot');
  dots.forEach((d, i) => d.classList.toggle('done', i < (_POMO.sessionsDone % 4)));

  // Tabs
  ['work','short','long'].forEach(mode => {
    const tab = document.getElementById('ptab-' + mode);
    if (!tab) return;
    const active = mode === _POMO.mode;
    tab.style.borderBottomColor = active ? '#e868a2' : 'transparent';
    tab.style.color = active ? '#e868a2' : 'var(--text3)';
  });

  // Stats
  const td = document.getElementById('pomo-today'); if (td) td.textContent = _POMO.todayCount;
  const tt = document.getElementById('pomo-total'); if (tt) tt.textContent = _POMO.totalCount;

  // Topbar badge (pulsing dot when running)
  const badge = document.getElementById('pomo-topbar-badge');
  if (badge) badge.style.display = _POMO.running ? 'block' : 'none';

  // Topbar button color
  const tbBtn = document.getElementById('pomo-topbar-btn');
  if (tbBtn) tbBtn.style.color = _POMO.running ? '#e868a2' : '';

  // Update title when running
  if (_POMO.running) {
    document.title = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')} — JDKActivity`;
  } else {
    document.title = 'JDKActivity';
  }
}

function pomoSetMode(mode) {
  if (_POMO.running) pomoStop();
  _POMO.mode = mode;
  const key = mode === 'work' ? 'work' : mode === 'short' ? 'short' : 'long';
  const sel = document.getElementById('pomo-dur-' + key);
  const dur = parseInt(sel?.value || (mode === 'work' ? 25 : mode === 'short' ? 5 : 15));
  _POMO.total = dur * 60;
  _POMO.remaining = _POMO.total;
  pomoRefreshUI();
}

function pomoUpdateDur() {
  const key = _POMO.mode === 'work' ? 'work' : _POMO.mode === 'short' ? 'short' : 'long';
  const sel = document.getElementById('pomo-dur-' + key);
  const dur = parseInt(sel?.value || 25);
  _POMO.total = dur * 60;
  _POMO.remaining = _POMO.total;
  pomoRefreshUI();
}

function pomoToggle() {
  if (_POMO.running) pomoStop(); else pomoStart();
}

function pomoStart() {
  if (_POMO.remaining <= 0) { pomoReset(); return; }
  _POMO.running = true;
  pomoRefreshUI();
  _pomoInterval = setInterval(() => {
    _POMO.remaining--;
    pomoRefreshUI();
    if (_POMO.remaining <= 0) {
      clearInterval(_pomoInterval);
      _POMO.running = false;
      pomoOnComplete();
    }
  }, 1000);
}

function pomoStop() {
  clearInterval(_pomoInterval);
  _POMO.running = false;
  pomoRefreshUI();
}

function pomoReset() {
  pomoStop();
  const key = _POMO.mode === 'work' ? 'work' : _POMO.mode === 'short' ? 'short' : 'long';
  const sel = document.getElementById('pomo-dur-' + key);
  const dur = parseInt(sel?.value || 25);
  _POMO.total = dur * 60;
  _POMO.remaining = _POMO.total;
  pomoRefreshUI();
}

function pomoSkip() {
  pomoStop();
  pomoOnComplete(true);
}

function pomoOnComplete(skipped) {
  document.title = 'JDKActivity';
  if (!skipped && _POMO.mode === 'work') {
    _POMO.sessionsDone++;
    _POMO.totalCount++;
    const today = new Date().toDateString();
    if (_POMO.todayDate !== today) { _POMO.todayDate = today; _POMO.todayCount = 0; }
    _POMO.todayCount++;
    localStorage.setItem('jdk_pomo_total', _POMO.totalCount);
    localStorage.setItem('jdk_pomo_today_count', _POMO.todayCount);
    localStorage.setItem('jdk_pomo_today_date', today);
    if (_POMO.sessionsDone % 4 === 0) {
      toast(`🔥 ${_POMO.sessionsDone} sessions ! Longue pause méritée 🌸`);
    } else {
      toast('✅ Session terminée ! Petite pause ☕');
    }
    if (Notification.permission === 'granted') {
      new Notification('JDKActivity', { body: skipped ? 'Session passée' : '✅ Session terminée ! Pause méritée ☕' });
    }
  }
  // Auto switch mode
  if (!skipped) {
    if (_POMO.mode === 'work') {
      if (_POMO.sessionsDone % 4 === 0) pomoSetMode('long');
      else pomoSetMode('short');
    } else {
      pomoSetMode('work');
    }
  }
  pomoRefreshUI();
}

// Close panel on outside click
document.addEventListener('click', e => {
  const panel = document.getElementById('pomo-panel');
  const btn = document.getElementById('pomo-topbar-btn');
  if (_pomoOpen && panel && !panel.contains(e.target) && btn && !btn.contains(e.target)) {
    _pomoOpen = false;
    panel.style.display = 'none';
  }
});

document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
  if (e.key === 'Escape') { closeSearch(); }
});
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
