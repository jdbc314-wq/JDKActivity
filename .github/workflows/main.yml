name: Build APK JDKActivity
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin

      - uses: android-actions/setup-android@v3

      - uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.4'
          cache-disabled: true

      - name: Build APK
        run: |
          mkdir -p proj/app/src/main/java/com/jdk/activity
          mkdir -p proj/app/src/main/res/layout
          mkdir -p proj/app/src/main/res/values

          cat > proj/settings.gradle << 'SETTEOF'
          pluginManagement {
            repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories { google(); mavenCentral() }
          }
          rootProject.name = "JDKActivity"
          include ':app'
          SETTEOF

          cat > proj/build.gradle << 'BUILDEOF'
          plugins { id 'com.android.application' version '8.2.0' apply false }
          BUILDEOF

          cat > proj/app/build.gradle << 'APPEOF'
          plugins { id 'com.android.application' }
          android {
            namespace 'com.jdk.activity'
            compileSdk 34
            defaultConfig {
              applicationId "com.jdk.activity"
              minSdk 21; targetSdk 34
              versionCode 1; versionName "1.0"
            }
          }
          APPEOF

          cat > proj/app/src/main/AndroidManifest.xml << 'MANEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET"/>
            <application android:label="JDKActivity" android:hardwareAccelerated="true">
              <activity android:name=".MainActivity" android:exported="true">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
            </application>
          </manifest>
          MANEOF

          cat > proj/app/src/main/res/layout/activity_main.xml << 'LAYEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent" android:layout_height="match_parent">
            <WebView android:id="@+id/webview"
              android:layout_width="match_parent" android:layout_height="match_parent"/>
          </RelativeLayout>
          LAYEOF

          cat > proj/app/src/main/res/values/strings.xml << 'STREOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources><string name="app_name">JDKActivity</string></resources>
          STREOF

          cat > proj/app/src/main/java/com/jdk/activity/MainActivity.java << 'JAVAEOF'
          package com.jdk.activity;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          public class MainActivity extends Activity {
            WebView w;
            public void onCreate(Bundle s) {
              super.onCreate(s);
              setContentView(R.layout.activity_main);
              w = findViewById(R.id.webview);
              w.getSettings().setJavaScriptEnabled(true);
              w.getSettings().setDomStorageEnabled(true);
              w.setWebViewClient(new WebViewClient());
              w.loadUrl("https://candid-empanada-81a561.netlify.app/");
            }
            public void onBackPressed() {
              if (w.canGoBack()) w.goBack(); else super.onBackPressed();
            }
          }
          JAVAEOF

          cd proj && gradle assembleDebug --no-daemon

      - uses: actions/upload-artifact@v4
        with:
          name: JDKActivity-APK
          path: proj/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
